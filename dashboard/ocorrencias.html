<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ocorrências • Banco da Neon</title>
  <link rel="icon" href="logotipo.svg" type="image/svg+xml" />
  <script>
    document.documentElement.classList.add('auth-pending');
  </script>
  <style>
    :root { --primary:#5a039a; --secondary:#b6f902; --secondary-700:#8bb601; --bg:#f7f7fb; --card:#fff; --text:#1a1a1a; --muted:#5d5d6a; --border:#e8e8ef; }
    *{ box-sizing:border-box; }
    body{ margin:0; color:var(--text); font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto; background: radial-gradient(800px 600px at 100% -10%, rgba(90,3,154,0.10), rgba(90,3,154,0.0) 60%), var(--bg); }
    .header{ background:var(--primary); color:#fff; padding:12px 20px; display:flex; align-items:center; justify-content:space-between; box-shadow:0 8px 24px rgba(90,3,154,0.25); }
    .brand{ display:flex; align-items:center; gap:12px; }
    .logo-mask{ width:48px; height:48px; display:block; background-color:#b6f902; -webkit-mask:url('logotipo.svg') center/contain no-repeat; mask:url('logotipo.svg') center/contain no-repeat; }
    .wrap{ max-width:980px; margin:0 auto; padding:20px; }
    .card{ background:var(--card); border:1px solid var(--border); border-radius:20px; padding:18px; box-shadow:0 10px 30px rgba(16,20,40,0.08); }
    .card + .card{ margin-top:16px; }
    h1{ margin:0 0 8px 0; font-size:24px; font-weight:800; }
    p.helper{ margin:0 0 16px 0; color:var(--muted); }
    .auth-pending #content{ display:none !important; visibility:hidden !important; }
    #unauth.overlay{ position:fixed; inset:0; display:none; align-items:center; justify-content:center; background: radial-gradient(800px 600px at 100% -10%, rgba(90,3,154,0.10), rgba(90,3,154,0.0) 60%), var(--bg); z-index:100; }
    .btn{ background:var(--primary); color:#fff; border:none; border-radius:9999px; padding:10px 16px; cursor:pointer; }
    .list{ margin:0; padding:0; list-style:none; border:1px solid var(--border); border-radius:14px; overflow:hidden; background:#fff; }
    .item{ padding:12px 14px; border-bottom:1px solid var(--border); display:flex; justify-content:space-between; align-items:center; }
    .item:last-child{ border-bottom:none; }
    .empty{ text-align:center; color:var(--muted); padding:16px; }
    .form{ display:grid; grid-template-columns: 1fr 1fr; gap:12px; }
    .field{ display:flex; flex-direction:column; gap:6px; }
    label{ font-size:12px; color:var(--muted); }
    input, select, textarea{ width:100%; background:#f2f4f7; border:1px solid var(--border); border-radius:12px; padding:10px 12px; outline:none; }
    textarea{ min-height:90px; resize:vertical; }
    .actions{ display:flex; gap:10px; margin-top:12px; }
  </style>
</head>
<body>
  <div id="header-container"></div>
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      fetch('../components/header.html')
        .then(res => res.text())
        .then(html => {
          document.getElementById('header-container').innerHTML = html;
          // Verifica se os elementos do menu existem
          setTimeout(() => {
            console.log('btnMenu:', document.getElementById('btnMenu'));
            console.log('sidebar:', document.getElementById('sidebar'));
            console.log('sidebarOverlay:', document.getElementById('sidebarOverlay'));
            console.log('btnCloseSidebar:', document.getElementById('btnCloseSidebar'));
          }, 300);
          const script = document.createElement('script');
          script.src = '../components/header-menu.js';
          document.body.appendChild(script);
        });
    });
  </script>
  

  <div class="wrap">
    <div id="unauth" class="card overlay" style="display:none; text-align:center;">
      <div>
        <h1>Acesso não autorizado</h1>
        <p class="helper">Para ver as ocorrências, faça login.</p>
        <button class="btn" onclick="window.location.href='../index.html'">Ir para o login</button>
      </div>
    </div>

    <div id="content" class="card" style="display:none;">
      <h1>Ocorrências</h1>
      <p class="helper">Somente professores podem cadastrar ocorrências.</p>
      <div class="form">
        <div class="field" style="grid-column: span 2;">
          <label for="alunoSelect">Selecione o aluno</label>
          <select id="alunoSelect"><option value="">Carregando alunos...</option></select>
        </div>
        <div class="field" style="grid-column: span 2;">
          <label for="descricao">Descrição da ocorrência</label>
          <textarea id="descricao" placeholder="Descreva a ocorrência"></textarea>
        </div>
        <div class="field">
          <label for="datahora">Data e hora da ocorrência</label>
          <input id="datahora" type="datetime-local" />
        </div>
        <div class="field">
          <label for="gravidade">Gravidade</label>
          <select id="gravidade">
            <option value="leve">leve</option>
            <option value="médio">médio</option>
            <option value="grave">grave</option>
            <option value="gravíssimo">gravíssimo</option>
          </select>
        </div>
      </div>
      <div class="actions">
        <button id="btnEnviar" class="btn">Enviar ocorrência</button>
        <a href="dashboard.html" class="btn" style="background:#202123;">Voltar</a>
      </div>
      <ul id="listaOcorrencias" class="list" style="margin-top:16px;"></ul>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-analytics.js";
    import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";
    import { getFirestore, collection, getDocs, query, orderBy, limit, where, doc, setDoc, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBHU6yFDCKp9jm9tPGyRqQJFS3amewuuQY",
      authDomain: "crmdaneon.firebaseapp.com",
      projectId: "crmdaneon",
      storageBucket: "crmdaneon.firebasestorage.app",
      messagingSenderId: "564595832938",
      appId: "1:564595832938:web:16fb660d8d433ae5f3f213",
      measurementId: "G-D3G4M9F17R"
    };

    const app = initializeApp(firebaseConfig);
    try { getAnalytics(app); } catch {}
    try { await signInAnonymously(getAuth(app)); } catch {}

    const unauthEl = document.getElementById('unauth');
    const contentEl = document.getElementById('content');
    const listaEl = document.getElementById('listaOcorrencias');
    const alunoSelect = document.getElementById('alunoSelect');
    const descricaoEl = document.getElementById('descricao');
    const datahoraEl = document.getElementById('datahora');
    const gravidadeEl = document.getElementById('gravidade');
    const btnEnviar = document.getElementById('btnEnviar');
    const sessRaw = localStorage.getItem('bn.currentUser');
    let sess = null; try { sess = JSON.parse(sessRaw); } catch {}

    if (!sess || !sess.user || sess.classe !== 'professor') {
      unauthEl.style.display = 'flex';
    } else {
      contentEl.style.display = 'block';
      document.documentElement.classList.remove('auth-pending');

      // Carrega alunos para o select
      try {
        const db = (() => { try { return getFirestore(app, 'bancodaneondb'); } catch { return getFirestore(app); } })();
        const alunosCol = collection(db, 'alunos');
        const snapAlunos = await getDocs(query(alunosCol, orderBy('firstName', 'asc')));
        const opts = [];
        snapAlunos.forEach(d => {
          const a = d.data();
          const label = `${a?.firstName || ''} ${a?.lastName || ''}`.trim();
          opts.push({ id: d.id, label });
        });
        opts.sort((x,y)=>x.label.localeCompare(y.label));
        alunoSelect.innerHTML = '<option value="">Selecione o aluno</option>' + opts.map(o=>`<option value="${o.id}">${o.label}</option>`).join('');
      } catch (e) {
        alunoSelect.innerHTML = '<option value="">Erro ao carregar alunos</option>';
      }

      // Listagem simples das últimas ocorrências (global)
      try {
        const db = (() => { try { return getFirestore(app, 'bancodaneondb'); } catch { return getFirestore(app); } })();
        const col = collection(db, 'ocorrencias');
        const snap = await getDocs(query(col, orderBy('quando', 'desc'), limit(20)));
        if (snap.empty) {
          const li = document.createElement('li'); li.className='empty'; li.textContent='Nenhuma ocorrência encontrada.'; listaEl.appendChild(li);
        } else {
          snap.forEach(d => {
            const data = d.data();
            const li = document.createElement('li'); li.className='item';
            const titulo = data?.descricaoOcorrencia ?? 'Ocorrência';
            const quando = data?.datahoraLancado?.toDate ? data.datahoraLancado.toDate().toLocaleString() : '';
            const left = document.createElement('div'); left.innerHTML = `<strong>${titulo}</strong><br><span style="color:var(--muted)">${quando}</span>`;
            const right = document.createElement('div'); right.textContent = data?.falta ?? ''; right.style.maxWidth = '55%'; right.style.textAlign='right';
            li.appendChild(left); li.appendChild(right);
            listaEl.appendChild(li);
          });
        }
      } catch (e) {
        const li = document.createElement('li'); li.className='empty'; li.textContent = `Erro ao carregar: ${e?.message || e}`; listaEl.appendChild(li);
        console.error(e);
      }

      // Enviar ocorrência
      btnEnviar?.addEventListener('click', async () => {
        const alunoId = alunoSelect.value;
        const descricao = descricaoEl.value.trim();
        const datahoraStr = datahoraEl.value;
        const falta = gravidadeEl.value;
        if (!alunoId || !descricao || !datahoraStr || !falta) {
          alert('Preencha todos os campos.');
          return;
        }
        const datahora = new Date(datahoraStr);
        const confirmMsg = `Aluno: ${alunoSelect.options[alunoSelect.selectedIndex].text}\n`+
                           `Data/Hora ocorrência: ${datahora.toLocaleString()}\n`+
                           `Gravidade: ${falta}\n`+
                           `Descrição: ${descricao}\n\nConfirmar envio?`;
        if (!confirm(confirmMsg)) return;

                 // Variáveis para o desconto (declaradas no escopo principal)
         let custoFalta = 0;
         let novoSaldo = 0;
         
         try {
           const db = (() => { try { return getFirestore(app, 'bancodaneondb'); } catch { return getFirestore(app); } })();
           // Garante doc do aluno em ocorrencias/{docIdAluno}
           const ocorrAlunoDocRef = doc(db, 'ocorrencias', alunoId);
           await setDoc(ocorrAlunoDocRef, { atualizadoEm: serverTimestamp() }, { merge: true });
           // Encontra próximo índice em ocorrencias/{docId}/ocorrenciaAluno
           const subCol = collection(db, 'ocorrencias', alunoId, 'ocorrenciaAluno');
           const snap = await getDocs(subCol);
           let maxNum = 0;
           snap.forEach(d => { const n = parseInt(d.id, 10); if (!isNaN(n) && n > maxNum) maxNum = n; });
           const nextId = String(maxNum + 1);
           await setDoc(doc(db, 'ocorrencias', alunoId, 'ocorrenciaAluno', nextId), {
             datahoraLancado: serverTimestamp(),
             datahoraOcorrencia: datahora,
             descricaoOcorrencia: descricao,
             docIdAluno: alunoId,
             falta
           });

                     // Lê custoFaltas e aplica desconto no extrato do aluno
           try {
             // Usa o banco de dados correto (bancodaneondb)
             const dbCorreto = getFirestore(app, 'bancodaneondb');
             const custoRef = doc(dbCorreto, 'ocorrencias', 'custoFaltas');
             const custoSnap = await getDocs(collection(dbCorreto, 'ocorrencias'));
             
             // Procura pelo documento custoFaltas
             custoSnap.forEach(d => {
               if (d.id === 'custoFaltas') {
                 const custoData = d.data();
                 // Mapeia a gravidade para o valor correto (com e sem acentos)
                 if (falta === 'leve') custoFalta = custoData.leve || 0;
                 else if (falta === 'médio' || falta === 'medio') custoFalta = custoData.médio || custoData.medio || 0;
                 else if (falta === 'grave') custoFalta = custoData.grave || 0;
                 else if (falta === 'gravíssimo' || falta === 'gravissimo') custoFalta = custoData.gravíssimo || custoData.gravissimo || 0;
               }
             });

                         if (custoFalta > 0) {
               // Busca o documento do aluno para obter o saldo atual e docId
               const alunoRef = doc(dbCorreto, 'alunos', alunoId);
               const alunoSnap = await getDocs(collection(dbCorreto, 'alunos'));
               let alunoData = null;
               let alunoDocId = null;
               
               alunoSnap.forEach(d => {
                 if (d.id === alunoId) {
                   alunoData = d.data();
                   alunoDocId = d.id;
                 }
               });

                             if (alunoData && alunoDocId) {
                 const saldoAtual = alunoData.saldo || 0;
                 novoSaldo = Math.max(0, saldoAtual - custoFalta); // Não permite saldo negativo
                
                // Atualiza o saldo do aluno
                await setDoc(alunoRef, { saldo: novoSaldo }, { merge: true });
                
                                 // Cria entrada no extrato do aluno
                 const extratoCol = collection(dbCorreto, 'alunos', alunoDocId, 'extrato');
                 await addDoc(extratoCol, {
                   amount: -custoFalta, // Valor negativo (desconto)
                   dateTime: serverTimestamp(),
                   description: `Ocorrência ${falta.charAt(0).toUpperCase() + falta.slice(1)}`,
                   isEarn: false,
                   saldoInicial: saldoAtual,
                   saldoFinal: novoSaldo
                 });
              }
            }
          } catch (e) {
            console.error('Erro ao aplicar desconto:', e);
            // Continua mesmo se falhar o desconto
          }

          let mensagem = 'Ocorrência enviada com sucesso.';
          if (custoFalta > 0) {
            mensagem += `\n\nDesconto aplicado: N$ ${custoFalta}\nNovo saldo do aluno: N$ ${novoSaldo}`;
          }
          alert(mensagem);
          descricaoEl.value = '';
          datahoraEl.value = '';
          gravidadeEl.value = 'leve';
          alunoSelect.value = '';
        } catch (e) {
          alert(e?.message || String(e));
          console.error(e);
        }
      });
    }
  </script>
</body>
</html>


