<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PIX ‚Ä¢ Banco da Neon</title>
  <style>
    :root { --primary:#5a039a; --secondary:#b6f902; --bg:#f7f7fb; --card:#fff; --text:#1a1a1a; --muted:#5d5d6a; --border:#e8e8ef; }
    *{ box-sizing:border-box; }
    body{ margin:0; color:var(--text); font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto; background: var(--bg); }
    .header{ background:var(--primary); color:#fff; padding:12px 20px; display:flex; align-items:center; justify-content:space-between; box-shadow:0 8px 24px rgba(90,3,154,0.25); }
    #juntinhos { display: flex; align-items: center; gap: 30px; }
    .brand{ display:flex; align-items:center; gap:12px; }
    .logo-mask{ width:48px; height:48px; display:block; background-color:#b6f902; -webkit-mask:url('logotipo.svg') center/contain no-repeat; mask:url('logotipo.svg') center/contain no-repeat; }
    .brand a { display: inline-block; line-height: 0; }
    .header-actions { display: flex; align-items: center; gap: 20px; }
    .menu-btn { width: 30px; height: 30px; padding: 0; background: transparent; border: 0; transition: background-color 0.2s ease; display: flex; align-items: center; justify-content: center; }
    .menu-btn:hover { background: rgba(255,255,255,0.1); }
    .menu-icon { width: 20px; height: 20px; display: block; filter: brightness(0) invert(1); }
    /* Menu lateral */
    .sidebar { position: fixed; top: 0; left: -300px; width: 300px; height: 100vh; background: var(--card); border-right: 1px solid var(--border); box-shadow: 4px 0 20px rgba(0,0,0,0.1); transition: left 0.3s ease; z-index: 1000; }
    .sidebar.open { left: 0; }
    .sidebar-header { display: flex; align-items: center; justify-content: space-between; padding: 20px; border-bottom: 1px solid var(--border); }
    .sidebar-header h3 { margin: 0; color: var(--primary); }
    .btn-close { background: none; border: none; font-size: 24px; cursor: pointer; color: var(--muted); }
    .sidebar-nav { padding: 20px 0; }
    .nav-item { display: flex; align-items: center; gap: 12px; padding: 16px 20px; color: var(--text); text-decoration: none; transition: background-color 0.2s; }
    .nav-item:hover { background-color: var(--bg); }
    .nav-item.active { background-color: var(--primary); color: #fff; }
    .nav-icon { font-size: 20px; }
    .sidebar-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); opacity: 0; visibility: hidden; transition: all 0.3s ease; z-index: 999; }
    .sidebar-overlay.open { opacity: 1; visibility: visible; }
    .wrap{ max-width:720px; margin:0 auto; padding:20px; }
    .card{ background:var(--card); border:1px solid var(--border); border-radius:20px; padding:18px; box-shadow:0 10px 30px rgba(16,20,40,0.08); }
    h1{ margin:0 0 8px 0; font-size:24px; font-weight:800; }
    p.helper{ margin:0 0 16px 0; color:var(--muted); }
    label{ font-size:12px; color:var(--muted); display:block; margin-bottom:6px; }
    input{ width:100%; background:#f2f4f7; border:1px solid var(--border); border-radius:12px; padding:10px 12px; outline:none; }
    .field{ margin-bottom:12px; }
    .actions{ display:flex; gap:10px; margin-top:12px; }
    .btn{ background:var(--primary); color:#fff; border:none; border-radius:9999px; padding:10px 16px; cursor:pointer; }
    .btn.secondary{ background:#202123; }
    .error{ color:#a20b0b; min-height:18px; margin-top:6px; }
    .ok{ color:#12805a; min-height:18px; margin-top:6px; }
  </style>
</head>
<body>
  <div id="header-container"></div>
  <script>
    document.addEventListener('DOMContentLoaded', function() {
  fetch('../components/header.html')
        .then(res => res.text())
        .then(html => {
          document.getElementById('header-container').innerHTML = html;
          const script = document.createElement('script');
          script.src = 'components/header-menu.js';
          document.body.appendChild(script);
        });
    });
  </script>
  

  <!-- Menu lateral -->
  <div id="sidebar" class="sidebar">
    <div class="sidebar-header">
      <h3>Menu</h3>
      <button id="btnCloseSidebar" class="btn-close">&times;</button>
    </div>
    <nav class="sidebar-nav">
      <a href="dashboard.html" class="nav-item">
        <span class="nav-icon">üè†</span>
        Dashboard
      </a>
      <a href="extrato.html" class="nav-item">
        <span class="nav-icon">üìä</span>
        Extrato
      </a>
      <a href="pix.html" class="nav-item active">
        <span class="nav-icon">üí∏</span>
        PIX
      </a>
      <a href="loja.html" class="nav-item">
        <span class="nav-icon">üõçÔ∏è</span>
        Loja
      </a>
      <a href="inventario.html" class="nav-item">
        <span class="nav-icon">üéí</span>
        Meu Invent√°rio
      </a>
      <a href="lojaconfig.html" class="nav-item">
        <span class="nav-icon">‚öôÔ∏è</span>
        Config Loja
      </a>
      <a href="ocorrencias.html" class="nav-item">
        <span class="nav-icon">‚ö†Ô∏è</span>
        Ocorr√™ncias
      </a>
      <a href="adicionarAluno.html" class="nav-item">
        <span class="nav-icon">üë§</span>
        Adicionar Aluno
      </a>
      <a href="dev.html" class="nav-item">
        <span class="nav-icon">üîß</span>
        Dev
      </a>
    </nav>
  </div>

  <!-- Overlay para fechar o menu -->
  <div id="sidebarOverlay" class="sidebar-overlay"></div>

  <div class="wrap">
    <div id="unauth" class="card" style="display:none; text-align:center;">
      <h1>Acesso n√£o autorizado</h1>
      <p class="helper">Fa√ßa login para usar o PIX.</p>
      <a class="btn" href="index.html">Ir para login</a>
    </div>

    <div id="content" class="card" style="display:none;">
      <h1>Transfer√™ncia PIX</h1>
      <p class="helper">Envie valores para outra pessoa usando a chave Pix (idAluno).</p>
      <div class="field">
        <label for="chavePix">Chave Pix (idAluno de destino)</label>
        <input id="chavePix" type="text" placeholder="Ex.: c7f603" />
      </div>
      <div class="field">
        <label for="descricao">Descri√ß√£o</label>
        <input id="descricao" type="text" placeholder="Ex.: Pagamento do lanche" />
      </div>
      <div class="field">
        <label for="valor">Valor</label>
        <input id="valor" type="text" inputmode="decimal" pattern="^[0-9]+([\.,][0-9]{1,2})?$" placeholder="Ex.: 50" />
      </div>
      <div class="actions">
        <button id="btnTransferir" class="btn">Transferir</button>
        <a class="btn secondary" href="dashboard.html">Voltar</a>
      </div>
      <div id="msg" class="ok"></div>
      <div id="err" class="error"></div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-analytics.js";
    import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";
    import { getFirestore, collection, query, where, limit, getDocs, addDoc, doc, getDoc, updateDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBHU6yFDCKp9jm9tPGyRqQJFS3amewuuQY",
      authDomain: "crmdaneon.firebaseapp.com",
      projectId: "crmdaneon",
      storageBucket: "crmdaneon.firebasestorage.app",
      messagingSenderId: "564595832938",
      appId: "1:564595832938:web:16fb660d8d433ae5f3f213",
      measurementId: "G-D3G4M9F17R"
    };

    const app = initializeApp(firebaseConfig);
    try { getAnalytics(app); } catch {}
    try { await signInAnonymously(getAuth(app)); } catch {}

    const sessRaw = localStorage.getItem('bn.currentUser');
    const unauthEl = document.getElementById('unauth');
    const contentEl = document.getElementById('content');
    const msgEl = document.getElementById('msg');
    const errEl = document.getElementById('err');
    let sess = null;
    try { sess = JSON.parse(sessRaw); } catch { sess = null; }
    // Controles do menu lateral
    const btnMenu = document.getElementById('btnMenu');
    const sidebar = document.getElementById('sidebar');
    const sidebarOverlay = document.getElementById('sidebarOverlay');
    const btnCloseSidebar = document.getElementById('btnCloseSidebar');

    btnMenu?.addEventListener('click', () => {
      sidebar.classList.add('open');
      sidebarOverlay.classList.add('open');
    });

    btnCloseSidebar?.addEventListener('click', () => {
      sidebar.classList.remove('open');
      sidebarOverlay.classList.remove('open');
    });

    sidebarOverlay?.addEventListener('click', () => {
      sidebar.classList.remove('open');
      sidebarOverlay.classList.remove('open');
    });

    if (!sess || !sess.user) {
      unauthEl.style.display = 'block';
    } else {
      contentEl.style.display = 'block';
    }

    const db = (() => { try { return getFirestore(app, 'bancodaneondb'); } catch { return getFirestore(app); } })();

    function $(s){ return document.querySelector(s); }
    const btnTransferir = $('#btnTransferir');

    async function getAlunoByUser(user){
      const alunosCol = collection(db, 'alunos');
      const q = query(alunosCol, where('user','==', user), limit(1));
      const snap = await getDocs(q);
      if (snap.empty) return null;
      const d = snap.docs[0];
      const data = d.data();
      return { gilberto: d.id, saldo: Number(data?.saldo ?? 0), user: data?.user, firstName: data?.firstName };
    }
    async function getAlunoByIdAluno(idAluno){
      const alunosCol = collection(db, 'alunos');
      const q = query(alunosCol, where('idAluno','==', idAluno), limit(1));
      const snap = await getDocs(q);
      if (snap.empty) return null;
      const d = snap.docs[0];
      const data = d.data();
      return { gilberto: d.id, saldo: Number(data?.saldo ?? 0), user: data?.user, firstName: data?.firstName };
    }

    function parseValor(input){
      const s = String(input || '').replace(',', '.').trim();
      const n = Number(s);
      if (!isFinite(n) || n <= 0) return null;
      return Math.round(n * 100) / 100;
    }

    btnTransferir?.addEventListener('click', async () => {
      msgEl.textContent = '';
      errEl.textContent = '';
      const chave = String($('#chavePix').value || '').trim();
      const descricao = String($('#descricao').value || '').trim();
      const valor = parseValor($('#valor').value);
      if (!chave || !descricao || !valor){ errEl.textContent = 'Preencha todos os campos com valores v√°lidos (valor > 0).'; return; }

      if (!confirm(`Confirmar transfer√™ncia de N$ ${valor} para a chave ${chave}?`)){
        return;
      }

      try {
        // Carrega remetente e destinat√°rio
        const remetente = await getAlunoByUser(sess.user);
        if (!remetente) { throw new Error('Remetente n√£o encontrado'); }
        const destinatario = await getAlunoByIdAluno(chave);
        if (!destinatario) { throw new Error('Destinat√°rio n√£o encontrado'); }
        if (remetente.gilberto === destinatario.gilberto) { throw new Error('N√£o √© poss√≠vel transferir para si mesmo.'); }
        if (remetente.saldo < valor) { throw new Error('Saldo insuficiente.'); }

        const agora = serverTimestamp();

        // Extrato remetente (isEarn false)
        const saldoInicialR = remetente.saldo;
        const saldoFinalR = saldoInicialR - valor;
        // Caminho exigido: bancodaneondb/alunos/{docId}/extrato/extrato
        await addDoc(collection(db,'alunos', remetente.gilberto, 'extrato'), {
          amount: -Math.abs(valor),
          dateTime: agora,
          description: descricao,
          isEarn: false,
          saldoInicial: saldoInicialR,
          saldoFinal: saldoFinalR
        });
        await updateDoc(doc(db,'alunos', remetente.gilberto), { saldo: saldoFinalR });

        // Extrato destinat√°rio (isEarn true)
        const saldoInicialD = destinatario.saldo;
        const saldoFinalD = saldoInicialD + valor;
        await addDoc(collection(db,'alunos', destinatario.gilberto, 'extrato'), {
          amount: Math.abs(valor),
          dateTime: agora,
          description: `Transfer√™ncia PIX - ${remetente.user}`,
          isEarn: true,
          saldoInicial: saldoInicialD,
          saldoFinal: saldoFinalD
        });
        await updateDoc(doc(db,'alunos', destinatario.gilberto), { saldo: saldoFinalD });

        msgEl.textContent = 'Transfer√™ncia conclu√≠da com sucesso!';
      } catch (e) {
        errEl.textContent = e?.message || String(e);
        console.error(e);
      }
    });
  </script>
</body>
</html>


