<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Dashboard ‚Ä¢ Banco da Neon</title>
  <link rel="icon" href="logotipo.svg" type="image/svg+xml" />
  <style>
    :root {
      --primary: #5a039a;
      --secondary: #b6f902;
      --secondary-700: #8bb601;
      --bg: #f7f7fb;
      --card: #ffffff;
      --text: #1a1a1a;
      --muted: #5d5d6a;
      --border: #e8e8ef;
    }
    *{ box-sizing:border-box; }
    body {
      margin:0; color: var(--text);
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto;
      background:
        radial-gradient(800px 600px at 100% -10%, rgba(90,3,154,0.10), rgba(90,3,154,0.0) 60%),
        var(--bg);
    }
    .header { background: var(--primary); color: #fff; padding: 12px 20px; display: flex; align-items: center; justify-content: space-between; box-shadow: 0 8px 24px rgba(90,3,154,0.25); }
    #juntinhos { display: flex; align-items: center; gap: 30px; }
    .brand { display:flex; align-items:center; gap: 12px; }
    .logo-mask { width: 60px; height: 60px; display:block; background-color: #b6f902; -webkit-mask: url('logotipo.svg') center/contain no-repeat; mask: url('logotipo.svg') center/contain no-repeat; }
    .brand a { display: inline-block; line-height: 0; }
    .brand .title { font-weight: 800; letter-spacing: .2px; }
    .header-actions { display: flex; align-items: center; gap: 20px; }
    .menu-btn { width: 30px; height: 30px; padding: 0; background: transparent; border: 0; transition: background-color 0.2s ease; display: flex; align-items: center; justify-content: center; }
    .menu-btn:hover { background: rgba(255,255,255,0.1); }
    .menu-icon { width: 20px; height: 20px; display: block; filter: brightness(0) invert(1); }
    /* Menu lateral */
    .sidebar { position: fixed; top: 0; left: -300px; width: 300px; height: 100vh; background: var(--card); border-right: 1px solid var(--border); box-shadow: 4px 0 20px rgba(0,0,0,0.1); transition: left 0.3s ease; z-index: 1000; }
    .sidebar.open { left: 0; }
    .sidebar-header { display: flex; align-items: center; justify-content: space-between; padding: 20px; border-bottom: 1px solid var(--border); }
    .sidebar-header h3 { margin: 0; color: var(--primary); }
    .btn-close { background: none; border: none; font-size: 24px; cursor: pointer; color: var(--muted); }
    .sidebar-nav { padding: 20px 0; }
    .nav-item { display: flex; align-items: center; gap: 12px; padding: 16px 20px; color: var(--text); text-decoration: none; transition: background-color 0.2s; }
    .nav-item:hover { background-color: var(--bg); }
    .nav-item.active { background-color: var(--primary); color: #fff; }
    .nav-icon { font-size: 20px; }
    .sidebar-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); opacity: 0; visibility: hidden; transition: all 0.3s ease; z-index: 999; }
    .sidebar-overlay.open { opacity: 1; visibility: visible; }
    .wrap { max-width: 980px; margin: 0 auto; padding: 20px; }
    /* Controles de ocorr√™ncias */
    .ocorrencias-controls { display: flex; gap: 10px; }
    .ocorrencias-list { margin-top: 16px; }
    .ocorrencias-list .loading { text-align: center; color: var(--muted); padding: 20px; }
    .ocorrencia-item { display: flex; justify-content: space-between; align-items: center; padding: 12px 16px; border: 1px solid var(--border); border-radius: 12px; margin-bottom: 8px; background: #fff; }
    .ocorrencia-info { flex: 1; }
    .ocorrencia-tipo { font-weight: 600; color: var(--primary); }
    .ocorrencia-data { font-size: 14px; color: var(--muted); }
    .ocorrencia-valor { font-weight: 700; color: #dc3545; }
    .card { background: var(--card); border: 1px solid var(--border); border-radius: 24px; padding: 20px; box-shadow: 0 10px 30px rgba(16, 20, 40, 0.08); }
    .card + .card { margin-top: 16px; }
    #ocorrencias { min-height: 75vh; }
    .row { display:flex; justify-content: space-between; align-items:center; margin-bottom: 16px; }
    a { color: var(--primary); text-decoration:none; }
    .big { font-size: 24px; font-weight: 800; }
    .muted { color: var(--muted); }
    .pill { display:inline-flex; align-items:center; gap:8px; background: linear-gradient(180deg, var(--secondary), var(--secondary-700)); color: #202420; padding: 6px 12px; border-radius: 999px; font-weight: 700; border: 1px solid rgba(0,0,0,0.06); }
    .actions-horizontal { display: flex; flex-wrap: nowrap; gap: 24px; margin-top: 16px; align-items: center; justify-content: space-evenly; flex-direction: row; }
    .action-item { display: flex; flex-direction: column; align-items: center; gap: 12px; }
    .circle-btn { width: 80px; height: 80px; border-radius: 9999px; border: none; background: var(--secondary); display: grid; place-items: center; cursor: pointer; }
    .circle-btn:disabled { opacity: .6; cursor: not-allowed; }
    .mask { -webkit-mask: var(--icon) center/contain no-repeat; mask: var(--icon) center/contain no-repeat; background-color: var(--icon-color, currentColor); width: 42px; height: 42px; display: block; }
    .label { font-weight: 700; font-size: 32px; }
    /* Novo bloco de cabe√ßalho do cart√£o */
    .header-block { display: flex; flex-direction: column; gap: 4px; margin-bottom: 8px; }
    .greeting { font-size: 56px; font-weight: 800; }
    .account-label { font-size: 48px; color: var(--muted); font-weight: 800; display: inline-block; white-space: nowrap; line-height: 1; }
    .balance { font-size: 36px; color: var(--muted); font-weight: 800; }
    .account-line { position: relative; display: inline-flex; align-items: baseline; gap: 8px; width: fit-content; }
    .icon-btn { position: static; width: 20px; height: 20px; border: none; background: transparent; padding: 0; cursor: pointer; display: inline-flex; align-items: center; justify-content: center; }
    /* Layout do card principal: Moacir √† esquerda (textos+a√ß√µes) e avatar √† direita */
    #cardProfile { display: flex; align-items: flex-start; justify-content: space-between; gap: 20px; }
    #Moacir { flex: 1 1 50%; max-width: 50%; }
    #profileWithButton { position: relative; width: clamp(220px, 90%, 300px); aspect-ratio: 1 / 1; align-self: center; margin-left: auto; }
    /* Avatar + edi√ß√£o */
    .avatar { position: relative; width: 100%; height: 100%; border-radius: 50%; background: var(--primary); border: 8px solid var(--secondary); overflow: hidden; }
    .avatar img { width: 100%; height: 100%; object-fit: cover; display: block; }
    .avatar .placeholder { position: absolute; inset: 0; background: var(--primary); display: grid; place-items: center; }
    .avatar .placeholder img { width: 80%; height: 80%; object-fit: contain; border-radius: 50%; }
    .avatar .spinner { position: absolute; inset: 0; display: grid; place-items: center; }
    .avatar .spinner::after { content: ""; width: 56px; height: 56px; border: 6px solid rgba(0,0,0,0.1); border-top-color: var(--secondary); border-radius: 50%; animation: spin 1s linear infinite; }
    .avatar.hide-photo .placeholder { display: grid; }
    .avatar.hide-photo img { opacity: 0.15; }
    .edit-btn { position: absolute; width: 48px; height: 48px; border-radius: 50%; background: #5a039a; color: #fff; display: grid; place-items: center; border: 1px solid rgba(255,255,255,0.2); cursor: pointer; right: 20px; bottom: 20px }
    .edit-btn .mask { width: 30px; height: 30px; background-color: #fff; --icon: url('lapis.svg'); }
    .tooltip { position: absolute; background: rgba(0,0,0,0.8); color: #fff; font-size: 12px; padding: 6px 8px; border-radius: 6px; white-space: nowrap; opacity: 0; pointer-events: none; right: 0; bottom: 40px; transform: translateY(6px); transition: opacity .15s, transform .15s; }
    .edit-btn:hover + .tooltip, .edit-btn:focus + .tooltip { opacity: 1; transform: translateY(0); }
    .account-label { display: inline-flex; align-items: baseline; gap: 8px; }
    .actions-horizontal { max-width: 50%; }
    /* Modal upload */
    .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.6); display: none; align-items: center; justify-content: center; z-index: 60; }
    .modal { width: min(92vw, 520px); background: var(--card); border: 1px solid var(--border); border-radius: 16px; padding: 16px; box-shadow: 0 20px 50px rgba(0,0,0,0.3); }
    .modal h3 { margin: 0 0 8px 0; }
    .modal .actions { justify-content: flex-end; }
    .preview { width: 160px; height: 160px; border-radius: 50%; overflow: hidden; border: 4px solid var(--secondary); background: var(--primary); margin-bottom: 12px; }
    .preview img { width: 100%; height: 100%; object-fit: cover; display: block; }
  </style>
</head>
<body>
  <div class="header">
    <div id="juntinhos">
      <div class="brand">
        <a href="dashboard.html" title="In√≠cio"><span class="logo-mask" aria-label="Neon"></span></a>
      </div>
      <button id="btnMenu" class="menu-btn" title="Menu">
        <img src="menu.svg" alt="Menu" class="menu-icon" />
      </button>
    </div>
    <div class="header-actions">
      <button id="btnLogout" class="btn" style="background:#dc3545;">Sair</button>
    </div>
  </div>

  <!-- Menu lateral -->
  <div id="sidebar" class="sidebar">
    <div class="sidebar-header">
      <h3>Menu</h3>
      <button id="btnCloseSidebar" class="btn-close">&times;</button>
    </div>
    <nav class="sidebar-nav">
      <a href="dashboard.html" class="nav-item active">
        <span class="nav-icon">üè†</span>
        Dashboard
      </a>
      <a href="extrato.html" class="nav-item">
        <span class="nav-icon">üìä</span>
        Extrato
      </a>
      <a href="pix.html" class="nav-item">
        <span class="nav-icon">üí∏</span>
        PIX
      </a>
      <a href="loja.html" class="nav-item">
        <span class="nav-icon">üõçÔ∏è</span>
        Loja
      </a>
      <a href="inventario.html" class="nav-item">
        <span class="nav-icon">üéí</span>
        Meu Invent√°rio
      </a>
      <a href="lojaconfig.html" class="nav-item">
        <span class="nav-icon">‚öôÔ∏è</span>
        Config Loja
      </a>
      <a href="ocorrencias.html" class="nav-item">
        <span class="nav-icon">‚ö†Ô∏è</span>
        Ocorr√™ncias
      </a>
      <a href="adicionarAluno.html" class="nav-item">
        <span class="nav-icon">üë§</span>
        Adicionar Aluno
      </a>
      <a href="dev.html" class="nav-item">
        <span class="nav-icon">üîß</span>
        Dev
      </a>
    </nav>
  </div>

  <!-- Overlay para fechar o menu -->
  <div id="sidebarOverlay" class="sidebar-overlay"></div>
  <div class="wrap">
    <div class="card" id="cardProfile">
      <div id="Moacir">
        <div class="header-block" id="infoConta">
          <div id="saudacao" class="greeting">Ol√°, ...</div>
          <div class="account-line">
            <div id="robervaldo" class="account-label">Conta</div>
            <button id="btnHide" class="icon-btn" title="Ocultar saldo" aria-label="Ocultar saldo" style="display: inline-block;">
              <span class="mask" style="--icon: url('ocultar.svg'); --icon-color: var(--primary);"></span>
            </button>
            <button id="btnShow" class="icon-btn" title="Mostrar saldo" aria-label="Mostrar saldo" style="display: none;">
              <span class="mask" style="--icon: url('mostrar.svg'); --icon-color: var(--primary);"></span>
            </button>
          </div>
          <div id="saldoLinha" class="balance">N$ ...</div>
        </div>
        <div class="actions-horizontal" id="actionsButtonsBanco">
          <div class="action-item">
            <button id="pixButton" class="circle-btn" title="Pix" aria-label="Pix" onclick="window.location.href='pix.html'">
              <span class="mask" style="--icon: url('pix.svg'); --icon-color: var(--primary);"></span>
            </button>
            <span class="label">Pix</span>
          </div>
          <div class="action-item">
            <button id="extratoButton" class="circle-btn" title="Extrato" aria-label="Extrato">
              <span class="mask" style="--icon: url('extrato.svg'); --icon-color: var(--primary);"></span>
            </button>
            <span class="label">Extrato</span>
          </div>
          <div class="action-item">
            <button id="shopButton" class="circle-btn" title="Loja" aria-label="Loja" onclick="window.location.href='loja.html'">
              <span class="mask" style="--icon: url('loja.svg'); --icon-color: var(--primary);"></span>
            </button>
            <span class="label">Loja</span>
          </div>
        </div>
      </div>
      <div id="profileWithButton">
        <div class="avatar" id="avatar">
          <img id="avatarImg" src="" alt="Sua foto" />
          <div id="avatarSpinner" class="spinner"></div>
          <div id="avatarPlaceholder" class="placeholder" style="display:none;"><img src="semfoto.png" alt="Sem foto"/></div>
        </div>
        <div id="editarButton" class="edit-btn" title="Edite ou adicione sua foto" aria-label="Editar foto"><span class="mask"></span></div>
        <div class="tooltip">Edite ou adicione sua foto</div>
      </div>
    </div>
    <div class="card" id="ocorrencias">
      <div class="row">
        <div class="big">Ocorr√™ncias</div>
        <div class="ocorrencias-controls">
          <button id="btnShowOcorrencias" class="btn" style="background:var(--secondary); color:#202420;">Mostrar</button>
          <button id="btnHideOcorrencias" class="btn" style="background:var(--muted); color:#fff; display:none;">Ocultar</button>
        </div>
      </div>
      <div id="listaOcorrencias" class="ocorrencias-list" style="display:none;">
        <div class="loading">Carregando ocorr√™ncias...</div>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-analytics.js";
    import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";
    import { getFirestore, collection, query, where, limit, getDocs, doc, updateDoc } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";
    import { getStorage, ref, uploadBytes, getDownloadURL, getMetadata, getBytes } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-storage.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBHU6yFDCKp9jm9tPGyRqQJFS3amewuuQY",
      authDomain: "crmdaneon.firebaseapp.com",
      projectId: "crmdaneon",
      storageBucket: "crmdaneon.firebasestorage.app",
      messagingSenderId: "564595832938",
      appId: "1:564595832938:web:16fb660d8d433ae5f3f213",
      measurementId: "G-D3G4M9F17R"
    };

    const DEBUG_UPLOAD = true; // F√°cil de desativar/remover depois
    const logU = (...args) => { if (DEBUG_UPLOAD) console.log('[UploadFoto]', ...args); };

    logU('Dashboard carregado');
    const app = initializeApp(firebaseConfig);
    try { getAnalytics(app); } catch {}
    try { await signInAnonymously(getAuth(app)); } catch {}

    let db; try { db = getFirestore(app, "bancodaneondb"); logU('Firestore OK (bancodaneondb)'); } catch { db = getFirestore(app); logU('Firestore fallback (default)'); }
    const storage = getStorage(app, "gs://crmdaneon.firebasestorage.app");
    logU('Storage OK (bucket gs://crmdaneon.firebasestorage.app)');

    const sessRaw = localStorage.getItem("bn.currentUser");
    if (!sessRaw) { window.location.href = "index.html"; }
    let sess = null;
    try { sess = JSON.parse(sessRaw); } catch { sess = null; }
    logU('Sess√£o encontrada?', !!sess, sess?.user);
    if (!sess || !sess.user) { window.location.href = "index.html"; }

    const $ = (s) => document.querySelector(s);
    const saudacaoEl = $("#saudacao");
    const saldoLinhaEl = $("#saldoLinha");
    const btnHide = $("#btnHide");
    const btnShow = $("#btnShow");
    const btnExtrato = document.getElementById('extratoButton');
    const btnAvatarEdit = document.getElementById('editarButton');
    const avatarImg = document.getElementById('avatarImg');
    let currentDocId = null;

    // Spinner overlay (mantido)
    const spinner = document.createElement('div');
    spinner.id = 'spinner';
    spinner.style.cssText = 'display:flex; position: fixed; inset: 0; background: rgba(0,0,0,0.45); backdrop-filter: blur(2px); align-items:center; justify-content:center;';
    spinner.innerHTML = '<div style="width:56px; height:56px; border:6px solid rgba(255,255,255,0.2); border-top-color:#1ee1a8; border-radius:50%; animation: spin 1s linear infinite;"></div>';
    document.body.appendChild(spinner);
    const style = document.createElement('style'); style.textContent = '@keyframes spin { to { transform: rotate(360deg); } }'; document.head.appendChild(style);

    // Busca dados atualizados do Firestore por seguran√ßa
    // Avatar: inicia com spinner por 10s; se resolver a tempo, carrega foto, sen√£o mostra semfoto
    const avatarEl = document.getElementById('avatar');
    const avatarSpinner = document.getElementById('avatarSpinner');
    const avatarPlaceholder = document.getElementById('avatarPlaceholder');
    let avatarResolved = false;
    setTimeout(() => {
      if (!avatarResolved) {
        try { avatarSpinner.style.display = 'none'; } catch {}
        try { avatarPlaceholder.style.display = 'grid'; } catch {}
      }
    }, 10000);
    try {
      spinner.style.display = 'flex';
      const alunosCol = collection(db, "alunos");
      const q = query(alunosCol, where("user", "==", sess.user), limit(1));
      const snap = await getDocs(q);
      if (!snap.empty) {
        const d = snap.docs[0];
        const data = d.data();
        currentDocId = d.id;
        logU('Aluno resolvido', { docId: currentDocId, hasFotoUrl: !!data?.fotoUrl, saldo: data?.saldo });
        const nome = data?.firstName || sess.firstName || sess.user;
        const saldo = data?.saldo ?? sess.saldo ?? 0;
        saudacaoEl.textContent = `Ol√°, ${nome}`;
        saldoLinhaEl.dataset.raw = String(saldo);
        saldoLinhaEl.textContent = `N$ ${saldo}`;
        if (data?.fotoUrl) {
          avatarImg.onload = () => { try { avatarSpinner.style.display = 'none'; avatarResolved = true; } catch {} };
          avatarImg.src = data.fotoUrl;
        } // se n√£o houver foto, timeout exibir√° placeholder ap√≥s 10s
      } else {
        saudacaoEl.textContent = `Ol√°, ${sess.firstName || sess.user}`;
        saldoLinhaEl.dataset.raw = String(sess.saldo ?? 0);
        saldoLinhaEl.textContent = `N$ ${sess.saldo ?? 0}`;
      }
    } catch (e) {
      console.error(e);
      saudacaoEl.textContent = `Ol√°, ${sess.firstName || sess.user}`;
      saldoLinhaEl.dataset.raw = String(sess.saldo ?? 0);
      saldoLinhaEl.textContent = `N$ ${sess.saldo ?? 0}`;
    } finally { spinner.style.display = 'none'; }

    // Altern√¢ncia de visibilidade do saldo
    function maskSaldo() {
      saldoLinhaEl.textContent = 'N$ ‚Ä¶';
    }
    function showSaldo() {
      const raw = saldoLinhaEl.dataset.raw ?? '';
      saldoLinhaEl.textContent = `N$ ${raw}`;
    }
    btnHide?.addEventListener('click', () => {
      btnHide.style.display = 'none';
      btnShow.style.display = 'inline-block';
      maskSaldo();
      try { avatarEl?.classList.add('hide-photo'); avatarPlaceholder && (avatarPlaceholder.style.display = 'grid'); } catch {}
    });
    btnShow?.addEventListener('click', () => {
      btnShow.style.display = 'none';
      btnHide.style.display = 'inline-block';
      showSaldo();
      try { avatarEl?.classList.remove('hide-photo'); avatarPlaceholder && (avatarPlaceholder.style.display = 'none'); } catch {}
    });

    // Controles do menu lateral
    const btnMenu = document.getElementById('btnMenu');
    const sidebar = document.getElementById('sidebar');
    const sidebarOverlay = document.getElementById('sidebarOverlay');
    const btnCloseSidebar = document.getElementById('btnCloseSidebar');
    const btnLogout = document.getElementById('btnLogout');

    btnMenu?.addEventListener('click', () => {
      sidebar.classList.add('open');
      sidebarOverlay.classList.add('open');
    });

    btnCloseSidebar?.addEventListener('click', () => {
      sidebar.classList.remove('open');
      sidebarOverlay.classList.remove('open');
    });

    sidebarOverlay?.addEventListener('click', () => {
      sidebar.classList.remove('open');
      sidebarOverlay.classList.remove('open');
    });

    btnLogout?.addEventListener('click', () => {
      localStorage.removeItem('bn.currentUser');
      window.location.href = 'index.html';
    });

    // Navega√ß√£o para extrato
    btnExtrato?.addEventListener('click', () => { window.location.href = 'extrato.html'; });

    // Controles de ocorr√™ncias
    const btnShowOcorrencias = document.getElementById('btnShowOcorrencias');
    const btnHideOcorrencias = document.getElementById('btnHideOcorrencias');
    const listaOcorrencias = document.getElementById('listaOcorrencias');

    btnShowOcorrencias?.addEventListener('click', async () => {
      btnShowOcorrencias.style.display = 'none';
      btnHideOcorrencias.style.display = 'inline-block';
      listaOcorrencias.style.display = 'block';
      
      // Carrega ocorr√™ncias do aluno
      try {
        const db = (() => { try { return getFirestore(app, 'bancodaneondb'); } catch { return getFirestore(app); } })();
        const ocorrenciasCol = collection(db, 'ocorrencias');
        const snap = await getDocs(ocorrenciasCol);
        
        let ocorrenciasAluno = [];
        
        // Busca ocorr√™ncias do aluno logado
        for (const doc of snap.docs) {
          if (doc.id === currentDocId) {
            const subCol = collection(db, 'ocorrencias', doc.id, 'ocorrenciaAluno');
            const subSnap = await getDocs(subCol);
            subSnap.forEach(subDoc => {
              const data = subDoc.data();
              ocorrenciasAluno.push({
                id: subDoc.id,
                data: data.datahoraOcorrencia?.toDate ? data.datahoraOcorrencia.toDate() : new Date(),
                tipo: data.falta,
                descricao: data.descricaoOcorrencia
              });
            });
            break;
          }
        }
        
        // Ordena por data (mais nova primeiro)
        ocorrenciasAluno.sort((a, b) => b.data - a.data);
        
        // Renderiza a lista
        if (ocorrenciasAluno.length === 0) {
          listaOcorrencias.innerHTML = '<div class="empty">Nenhuma ocorr√™ncia encontrada.</div>';
        } else {
          listaOcorrencias.innerHTML = ocorrenciasAluno.map(oc => `
            <div class="ocorrencia-item">
              <div class="ocorrencia-info">
                <div class="ocorrencia-tipo">Ocorr√™ncia ${oc.tipo.charAt(0).toUpperCase() + oc.tipo.slice(1)}</div>
                <div class="ocorrencia-data">${oc.data.toLocaleDateString('pt-BR')} √†s ${oc.data.toLocaleTimeString('pt-BR', {hour: '2-digit', minute: '2-digit'})}</div>
              </div>
            </div>
          `).join('');
        }
      } catch (e) {
        console.error('Erro ao carregar ocorr√™ncias:', e);
        listaOcorrencias.innerHTML = '<div class="error">Erro ao carregar ocorr√™ncias.</div>';
      }
    });

    btnHideOcorrencias?.addEventListener('click', () => {
      btnHideOcorrencias.style.display = 'none';
      btnShowOcorrencias.style.display = 'inline-block';
      listaOcorrencias.style.display = 'none';
    });

    // Modal de upload de foto (Firebase Storage)
    const overlay = document.createElement('div');
    overlay.className = 'modal-overlay';
    overlay.innerHTML = `
      <div class="modal">
        <h3>Editar foto</h3>
        <div class="preview"><img id="previewImg" src="semfoto.png" alt="Pr√©via"/></div>
        <input id="fileInput" type="file" accept="image/*" />
        <div class="actions" style="margin-top:12px;">
          <button id="btnClose" class="btn secondary">Cancelar</button>
          <button id="btnSave" class="btn">Salvar</button>
        </div>
      </div>
    `;
    document.body.appendChild(overlay);
    const fileInput = overlay.querySelector('#fileInput');
    const previewImg = overlay.querySelector('#previewImg');
    const btnClose = overlay.querySelector('#btnClose');
    const btnSave = overlay.querySelector('#btnSave');

    btnAvatarEdit?.addEventListener('click', () => {
      logU('Abrindo modal de edi√ß√£o de foto');
      previewImg.src = avatarImg.src || 'semfoto.png';
      overlay.style.display = 'flex';
    });
    btnClose?.addEventListener('click', () => { overlay.style.display = 'none'; });
    overlay.addEventListener('click', (e) => { if (e.target === overlay) overlay.style.display = 'none'; });
    fileInput?.addEventListener('change', () => {
      const f = fileInput.files?.[0];
      if (!f) return;
      logU('Arquivo selecionado', { name: f.name, type: f.type, size: f.size });
      const url = URL.createObjectURL(f);
      previewImg.src = url;
    });
    btnSave?.addEventListener('click', async () => {
      try {
        // Mostra spinner no modal imediatamente
        previewImg.style.opacity = '0.4';
        btnSave.disabled = true;
        btnClose.disabled = true;
        let modalSpinner = document.getElementById('modalSpinner');
        if (!modalSpinner) {
          previewImg.parentElement.insertAdjacentHTML('beforeend', '<div id="modalSpinner" class="spinner" style="position:absolute;inset:0;display:grid;place-items:center;"></div>');
        }

        if (!currentDocId) throw new Error('Usu√°rio n√£o resolvido.');
        const f = fileInput.files?.[0];
        if (!f) throw new Error('Selecione uma imagem.');

        // Upload direto da nova imagem
        const baseRef = ref(storage, `imagemAlunos/${currentDocId}`);
  // ...c√≥digo de backup removido, agora s√≥ o backend faz versionamento...
        logU('Subindo nova imagem para base');
        await uploadBytes(baseRef, f, { contentType: f.type });
        logU('Upload conclu√≠do. Obtendo URL p√∫blica');
        const url = await getDownloadURL(baseRef);
        await updateDoc(doc(db, 'alunos', currentDocId), { fotoUrl: url });
        logU('fotoUrl atualizada no Firestore', { url });

        // Atualiza a foto na interface
        avatarImg.src = url;
        avatarEl.classList.remove('hide-photo');
        avatarPlaceholder.style.display = 'none';
        avatarSpinner.style.display = 'none';
        avatarResolved = true;
        overlay.style.display = 'none';

        // Remove spinner do modal
        modalSpinner = document.getElementById('modalSpinner');
        if (modalSpinner) modalSpinner.remove();
        previewImg.style.opacity = '1';
        btnSave.disabled = false;
        btnClose.disabled = false;
        logU('Processo finalizado com sucesso');
      } catch (e) {
        const modalSpinner = document.getElementById('modalSpinner');
        if (modalSpinner) modalSpinner.remove();
        previewImg.style.opacity = '1';
        btnSave.disabled = false;
        btnClose.disabled = false;
        logU('Erro no upload', e);
        alert(e?.message || String(e));
      }
    });
  </script>
</body>
</html>


