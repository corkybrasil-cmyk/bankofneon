<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Loja ‚Ä¢ Banco da Neon</title>
  <link rel="icon" href="logotipo.svg" type="image/svg+xml" />
  <style>
    :root { 
      --primary:#5a039a; 
      --secondary:#b6f902; 
      --secondary-700:#8bb601; 
      --bg:#f7f7fb; 
      --card:#fff; 
      --text:#1a1a1a; 
      --muted:#5d5d6a; 
      --border:#e8e8ef; 
    }
    *{ box-sizing:border-box; }
    html, body{ 
      margin:0; 
      padding: 0;
      color:var(--text); 
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto; 
      background: var(--bg); 
      min-height: 100vh;
    }
    .header{ background:var(--primary); color:#fff; padding:12px 20px; display:flex; align-items:center; justify-content:space-between; box-shadow:0 8px 24px rgba(90,3,154,0.25); }
    #juntinhos { display: flex; align-items: center; gap: 30px; }
    .brand{ display:flex; align-items:center; gap:12px; }
    .logo-mask{ width:48px; height:48px; display:block; background-color:#b6f902; -webkit-mask:url('logotipo.svg') center/contain no-repeat; mask:url('logotipo.svg') center/contain no-repeat; }
    .brand a { display: inline-block; line-height: 0; }
    .header-actions { display: flex; align-items: center; gap: 20px; }
    .menu-btn { width: 30px; height: 30px; padding: 0; background: transparent; border: 0; transition: background-color 0.2s ease; display: flex; align-items: center; justify-content: center; }
    .menu-btn:hover { background: rgba(255,255,255,0.1); }
    .menu-icon { width: 20px; height: 20px; display: block; filter: brightness(0) invert(1); }
    /* Menu lateral */
    .sidebar { position: fixed; top: 0; left: -300px; width: 300px; height: 100vh; background: var(--card); border-right: 1px solid var(--border); box-shadow: 4px 0 20px rgba(0,0,0,0.1); transition: left 0.3s ease; z-index: 1000; }
    .sidebar.open { left: 0; }
    .sidebar-header { display: flex; align-items: center; justify-content: space-between; padding: 20px; border-bottom: 1px solid var(--border); }
    .sidebar-header h3 { margin: 0; color: var(--primary); }
    .btn-close { background: none; border: none; font-size: 24px; cursor: pointer; color: var(--muted); }
    .sidebar-nav { padding: 20px 0; }
    .nav-item { display: flex; align-items: center; gap: 12px; padding: 16px 20px; color: var(--text); text-decoration: none; transition: background-color 0.2s; }
    .nav-item:hover { background-color: var(--bg); }
    .nav-item.active { background-color: var(--primary); color: #fff; }
    .nav-icon { font-size: 20px; }
    .sidebar-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); opacity: 0; visibility: hidden; transition: all 0.3s ease; z-index: 999; }
    .sidebar-overlay.open { opacity: 1; visibility: visible; }
    .wrap{ 
      max-width:1200px; 
      margin:0 auto; 
      padding:20px; 
      min-height: 100vh;
    }
    .card{ 
      background:var(--card); 
      border:1px solid var(--border); 
      border-radius:20px; 
      padding:18px; 
      box-shadow:0 10px 30px rgba(16,20,40,0.08); 
      min-height: 200px;
    }
    h1{ margin:0 0 8px 0; font-size:24px; font-weight:800; }
    p.helper{ margin:0 0 16px 0; color:var(--muted); }
    .btn{ background:var(--primary); color:#fff; border:none; border-radius:9999px; padding:10px 16px; cursor:pointer; }
    .btn.secondary{ background:#202123; }
    .error{ color:#a20b0b; min-height:18px; margin-top:6px; }
    .ok{ color:#12805a; min-height:18px; margin-top:6px; }
    
    /* Estilos da loja */
    .products-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 20px;
      margin-top: 20px;
      min-height: 200px;
      padding: 20px;
    }
    .product-card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 20px;
      text-align: center;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
      margin: 10px;
    }
    .product-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 12px 32px rgba(16,20,40,0.12);
    }
    .product-image {
      max-width: 250px !important;
      max-height: 400px !important;
      width: 100%;
      height: auto;
      border-radius: 12px;
      margin: 0 auto 16px;
      display: block;
      object-fit: contain;
    }
    .product-title {
      font-size: 18px;
      font-weight: 700;
      margin-bottom: 8px;
      color: var(--text);
    }
    .product-description {
      font-size: 14px;
      color: var(--muted);
      margin-bottom: 16px;
      line-height: 1.4;
    }
    .product-price {
      font-size: 24px;
      font-weight: 800;
      color: var(--primary);
      margin-bottom: 16px;
    }
    .buy-btn {
      background: var(--secondary);
      color: var(--primary);
      border: none;
      border-radius: 9999px;
      padding: 12px 24px;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    .buy-btn:hover {
      background: var(--secondary-700);
      transform: scale(1.05);
    }
    .buy-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }
  </style>
</head>
<body>
  <div class="header">
    <div id="juntinhos">
      <div class="brand">
        <a href="dashboard.html" title="In√≠cio"><span class="logo-mask" aria-label="Neon"></span></a>
      </div>
      <button id="btnMenu" class="menu-btn" title="Menu">
        <img src="menu.svg" alt="Menu" class="menu-icon" />
      </button>
    </div>
    <div class="header-actions">
      <a href="dashboard.html" class="btn" style="background:rgba(255,255,255,0.12)">Voltar</a>
    </div>
  </div>

  <!-- Menu lateral -->
  <div id="sidebar" class="sidebar">
    <div class="sidebar-header">
      <h3>Menu</h3>
      <button id="btnCloseSidebar" class="btn-close">&times;</button>
    </div>
    <nav class="sidebar-nav">
      <a href="dashboard.html" class="nav-item">
        <span class="nav-icon">üè†</span>
        Dashboard
      </a>
      <a href="extrato.html" class="nav-item">
        <span class="nav-icon">üìä</span>
        Extrato
      </a>
      <a href="pix.html" class="nav-item">
        <span class="nav-icon">üí∏</span>
        PIX
      </a>
      <a href="loja.html" class="nav-item active">
        <span class="nav-icon">üõçÔ∏è</span>
        Loja
      </a>
      <a href="inventario.html" class="nav-item">
        <span class="nav-icon">üéí</span>
        Meu Invent√°rio
      </a>
      <a href="lojaconfig.html" class="nav-item">
        <span class="nav-icon">‚öôÔ∏è</span>
        Config Loja
      </a>
      <a href="ocorrencias.html" class="nav-item">
        <span class="nav-icon">‚ö†Ô∏è</span>
        Ocorr√™ncias
      </a>
      <a href="adicionarAluno.html" class="nav-item">
        <span class="nav-icon">üë§</span>
        Adicionar Aluno
      </a>
      <a href="dev.html" class="nav-item">
        <span class="nav-icon">üîß</span>
        Dev
      </a>
    </nav>
  </div>

  <!-- Overlay para fechar o menu -->
  <div id="sidebarOverlay" class="sidebar-overlay"></div>

  <div class="wrap">
    <div id="unauth" class="card" style="display:none; text-align:center;">
      <h1>Acesso n√£o autorizado</h1>
      <p class="helper">Fa√ßa login para acessar a loja.</p>
      <a class="btn" href="index.html">Ir para login</a>
    </div>

    <div id="content" class="card" style="display:none;">
      <h1>Loja Neon</h1>
      <p class="helper">Compre produtos exclusivos com seus Neon Dollars.</p>
      
      <div class="products-grid" id="productsGrid">
        <!-- Produtos ser√£o carregados dinamicamente -->
      </div>
      
      <div id="msg" class="ok"></div>
      <div id="err" class="error"></div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-analytics.js";
    import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";
    import { getFirestore, collection, query, where, limit, getDocs, addDoc, doc, updateDoc, serverTimestamp, orderBy, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";
    import { getStorage, ref, getDownloadURL } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-storage.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBHU6yFDCKp9jm9tPGyRqQJFS3amewuuQY",
      authDomain: "crmdaneon.firebaseapp.com",
      projectId: "crmdaneon",
      storageBucket: "crmdaneon.firebasestorage.app",
      messagingSenderId: "564595832938",
      appId: "1:564595832938:web:16fb660d8d433ae5f3f213",
      measurementId: "G-D3G4M9F17R"
    };

    const app = initializeApp(firebaseConfig);
    try { getAnalytics(app); } catch {}
    try { await signInAnonymously(getAuth(app)); } catch {}

    const sessRaw = localStorage.getItem('bn.currentUser');
    
    const unauthEl = document.getElementById('unauth');
    const contentEl = document.getElementById('content');
    const msgEl = document.getElementById('msg');
    const errEl = document.getElementById('err');
    const productsGrid = document.getElementById('productsGrid');
    
    let sess = null;
    try { sess = JSON.parse(sessRaw); } catch { sess = null; }

    // Controles do menu lateral
    const btnMenu = document.getElementById('btnMenu');
    const sidebar = document.getElementById('sidebar');
    const sidebarOverlay = document.getElementById('sidebarOverlay');
    const btnCloseSidebar = document.getElementById('btnCloseSidebar');

    btnMenu?.addEventListener('click', () => {
      sidebar.classList.add('open');
      sidebarOverlay.classList.add('open');
    });

    btnCloseSidebar?.addEventListener('click', () => {
      sidebar.classList.remove('open');
      sidebarOverlay.classList.remove('open');
    });

    sidebarOverlay?.addEventListener('click', () => {
      sidebar.classList.remove('open');
      sidebarOverlay.classList.remove('open');
    });

    if (!sess || !sess.user) {
      unauthEl.style.display = 'block';
    } else {
      contentEl.style.display = 'block';
      // Aguarda um pouco para garantir que o DOM esteja pronto
      setTimeout(() => {
        try {
          loadProducts();
        } catch (error) {
          console.error('Erro ao carregar produtos:', error);
        }
      }, 3000);
    }

    const db = (() => { try { return getFirestore(app, 'bancodaneondb'); } catch { return getFirestore(app); } })();
    const storage = getStorage(app);

    // Fun√ß√£o para obter emoji baseado na categoria do produto
    function getProductEmoji(categoryName) {
      if (!categoryName) return 'üì¶';
      
      const category = categoryName.toLowerCase();
      if (category.includes('roupa') || category.includes('vestu√°rio')) return 'üëï';
      if (category.includes('bebida') || category.includes('caf√©')) return '‚òï';
      if (category.includes('mochila') || category.includes('bolsa')) return 'üéí';
      if (category.includes('bon√©') || category.includes('chap√©u')) return 'üß¢';
      if (category.includes('eletr√¥nico') || category.includes('tech')) return 'üì±';
      if (category.includes('livro') || category.includes('papelaria')) return 'üìö';
      if (category.includes('esporte') || category.includes('fitness')) return '‚öΩ';
      if (category.includes('casa') || category.includes('decora√ß√£o')) return 'üè†';
      
      return 'üì¶'; // Emoji padr√£o
    }

    async function loadProducts() {
      if (!productsGrid) {
        console.error('Elemento productsGrid n√£o encontrado!');
        return;
      }
      
      productsGrid.innerHTML = '';
      
      try {
        // Buscar produtos da cole√ß√£o loja/config/produtos
        const produtosCol = collection(db, 'loja', 'config', 'produtos');
        
        // Buscar apenas produtos ativos
        const q = query(produtosCol, where('status', '==', 'active'));
        
        const snap = await getDocs(q);
        
        if (snap.empty) {
          productsGrid.innerHTML = '<p style="text-align: center; color: var(--muted); font-size: 16px; padding: 40px;">Nenhum produto dispon√≠vel no momento.</p>';
          return;
        }

        snap.docs.forEach(async doc => {
          const produto = doc.data();
          let imgTag = '';
          if (produto.imageUrl) {
            let imgSrc = produto.imageUrl;
            if (imgSrc.startsWith('gs://')) {
              const path = imgSrc.replace('gs://crmdaneon.firebasestorage.app/', '');
              try {
                imgSrc = await getDownloadURL(ref(storage, path));
              } catch (e) {
                imgSrc = 'semfoto.png';
              }
            }
            imgTag = `<img src="${imgSrc}" class="product-image" alt="${produto.name}" style="max-width:250px;max-height:250px;border-radius:8px;object-fit:contain;">`;
          } else {
            imgTag = `<div class="product-image">üì¶</div>`;
          }
          const productCard = document.createElement('div');
          productCard.className = 'product-card';
          productCard.innerHTML = `
            ${imgTag}
            <div class="product-title">${produto.name}</div>
            <div class="product-description">${produto.description || 'Produto da loja Neon'}</div>
            <div class="product-price">N$ ${produto.price?.toFixed(2) || '0.00'}</div>
            <button class="buy-btn" data-product-id="${doc.id}" data-price="${produto.price}" data-product-name="${produto.name}" data-category="${produto.categoryName || ''}" data-subcategory="${produto.subcategoryName || ''}">
              Comprar
            </button>
          `;
          
          productsGrid.appendChild(productCard);
        });
        
      } catch (error) {
        console.error('Erro ao carregar produtos do Firebase:', error);
        productsGrid.innerHTML = '<p style="text-align: center; color: #dc2626; font-size: 16px; padding: 40px;">Erro ao carregar produtos. Tente novamente mais tarde.</p>';
      }

      // Adicionar event listeners para os bot√µes de compra
      document.querySelectorAll('.buy-btn').forEach(btn => {
        btn.addEventListener('click', handlePurchase);
      });
    }

    async function handlePurchase(event) {
      const btn = event.target;
      const productId = btn.dataset.productId;
      const price = parseInt(btn.dataset.price);
      
      if (!confirm(`Confirmar compra de ${btn.previousElementSibling.textContent}?`)) {
        return;
      }

      try {
        btn.disabled = true;
        btn.textContent = 'Processando...';

        // Verificar saldo do usu√°rio
        const alunosCol = collection(db, 'alunos');
        const q = query(alunosCol, where('user', '==', sess.user), limit(1));
        const snap = await getDocs(q);
        
        if (snap.empty) {
          throw new Error('Usu√°rio n√£o encontrado');
        }

        const alunoDoc = snap.docs[0];
        const alunoData = alunoDoc.data();
        const saldoAtual = Number(alunoData?.saldo ?? 0);

        if (saldoAtual < price) {
          throw new Error('Saldo insuficiente para esta compra');
        }

        // Atualizar saldo
        const novoSaldo = saldoAtual - price;
        await updateDoc(doc(db, 'alunos', alunoDoc.id), { saldo: novoSaldo });

        // Adicionar ao extrato
        const extratoCol = collection(db, 'alunos', alunoDoc.id, 'extrato');
        const productName = btn.dataset.productName || 'Produto da loja';
        await addDoc(extratoCol, {
          amount: -price,
          dateTime: serverTimestamp(),
          description: `Compra na loja: ${productName}`,
          isEarn: false,
          saldoInicial: saldoAtual,
          saldoFinal: novoSaldo
        });

        // Adicionar ao invent√°rio do usu√°rio
        // Usar a nova estrutura: inventario/{docId}/inventarioAluno
        console.log('üì¶ Adicionando item ao invent√°rio...');
        console.log('üìç Caminho da cole√ß√£o: inventario/' + alunoDoc.id + '/inventarioAluno');
        console.log('üè∑Ô∏è Categoria do produto:', btn.dataset.category);
        console.log('üè∑Ô∏è Subcategoria do produto:', btn.dataset.subcategory);
        
        const inventarioCol = collection(db, 'inventario', alunoDoc.id, 'inventarioAluno');

        // Buscar dados do produto na loja/config/produtos
        const produtoRef = doc(db, 'loja', 'config', 'produtos', productId);
        const produtoSnap = await getDoc(produtoRef);
        let imageUrl = '';
        if (produtoSnap.exists()) {
          const produtoData = produtoSnap.data();
          imageUrl = produtoData.imageUrl || '';
        }

        // Definir categoria e subcategoria corretamente
        const productCategory = btn.dataset.category || 'Geral';
        const productSubcategory = btn.dataset.subcategory || '';

        // Buscar se o item j√° existe para atualizar quantidade
        const existingItemQuery = query(
          inventarioCol,
          where('productId', '==', productId)
        );
        const existingItemSnap = await getDocs(existingItemQuery);

        if (!existingItemSnap.empty) {
          // Item j√° existe, atualizar quantidade
          const existingItemDoc = existingItemSnap.docs[0];
          const existingData = existingItemDoc.data();
          const newQuantity = (existingData.quantity || 1) + 1;
          
          await updateDoc(doc(db, 'inventario', alunoDoc.id, 'inventarioAluno', existingItemDoc.id), {
            quantity: newQuantity,
            lastPurchaseDate: serverTimestamp(),
            totalSpent: (existingData.totalSpent || 0) + price,
            imageUrl: imageUrl // Atualiza imagem se necess√°rio
          });
        } else {
          // Item n√£o existe, criar novo com o mesmo nome/id do produto
          const itemData = {
            productId: productId,
            productName: productName,
            price: price,
            quantity: 1,
            category: productCategory,
            subcategory: productSubcategory,
            description: `Comprado por N$ ${price.toFixed(2)}`,
            firstPurchaseDate: serverTimestamp(),
            lastPurchaseDate: serverTimestamp(),
            totalSpent: price,
            status: 'active',
            imageUrl: imageUrl // Salva imagem do produto
          };

          // Usa setDoc para que o nome do documento seja igual ao nome do produto
          await setDoc(doc(db, 'inventario', alunoDoc.id, 'inventarioAluno', productName), itemData);
        }
        
        console.log('üéØ Item adicionado ao invent√°rio com sucesso!');
        console.log('üóÑÔ∏è INFORMA√á√ÉO IMPORTANTE: Dados enviados para a cole√ß√£o bancodaneondb/inventario/' + alunoDoc.id + '/inventarioAluno');

        // Atualizar localStorage
        const updatedUser = { ...sess, saldo: novoSaldo };
        localStorage.setItem('bn.currentUser', JSON.stringify(updatedUser));

        msgEl.textContent = 'Compra realizada com sucesso!';
        setTimeout(() => {
          msgEl.textContent = '';
        }, 3000);

        // Recarregar produtos para atualizar bot√µes
        loadProducts();

      } catch (e) {
        errEl.textContent = e?.message || String(e);
        console.error(e);
        
        // Reativar bot√£o em caso de erro
        btn.disabled = false;
        btn.textContent = 'Comprar';
        
        setTimeout(() => {
          errEl.textContent = '';
        }, 5000);
      }
    }

    // Novo c√≥digo para buscar produtos e exibir imagem correta
    async function loadAllProducts() {
      const productsCol = collection(db, 'loja', 'config', 'produtos');
      const q = query(productsCol, orderBy('name'));
      const snap = await getDocs(q);
      const products = [];
      for (const doc of snap.docs) {
        const data = doc.data();
        let imgSrc = 'semfoto.png';
        if (data.imageUrl) {
          if (data.imageUrl.startsWith('gs://')) {
            // Extrai o caminho relativo do Storage
            const path = data.imageUrl.replace('gs://crmdaneon.firebasestorage.app/', '');
            try {
              imgSrc = await getDownloadURL(ref(storage, path));
            } catch (e) {
              imgSrc = 'semfoto.png';
            }
          } else {
            imgSrc = data.imageUrl;
          }
        }
        products.push({ id: doc.id, ...data, imgSrc });
      }
      renderProducts(products);
    }

    function renderProducts(products) {
      const container = document.getElementById('productsGrid');
      container.innerHTML = '';
      products.forEach(product => {
        const card = document.createElement('div');
        card.className = 'product-card';
        card.innerHTML = `
          <img src="${product.imgSrc}" alt="${product.name}" class="product-image" style="width:120px;height:120px;object-fit:cover;border-radius:8px;">
          <h3>${product.name}</h3>
          <p>${product.description || ''}</p>
          <span>Pre√ßo: N$ ${product.price?.toFixed(2) || '0.00'}</span>
        `;
        container.appendChild(card);
      });
    }

    window.addEventListener('DOMContentLoaded', loadAllProducts);
  </script>
</body>
</html>
