<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Configura√ß√£o da Loja ‚Ä¢ Banco da Neon</title>
  <link rel="icon" href="logotipo.svg" type="image/svg+xml" />
  <style>
    :root { 
      --primary:#5a039a; 
      --secondary:#b6f902; 
      --secondary-700:#8bb601; 
      --bg:#f7f7fb; 
      --card:#fff; 
      --text:#1a1a1a; 
      --muted:#5d5d6a; 
      --border:#e8e8ef; 
      --success:#12805a;
      --warning:#f59e0b;
      --danger:#dc2626;
    }
    *{ box-sizing:border-box; }
    html, body{ 
      margin:0; 
      padding: 0;
      color:var(--text); 
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto; 
      background: var(--bg); 
      min-height: 100vh;
    }
    .header{ background:var(--primary); color:#fff; padding:12px 20px; display:flex; align-items:center; justify-content:space-between; box-shadow:0 8px 24px rgba(90,3,154,0.25); }
    #juntinhos { display: flex; align-items: center; gap: 30px; }
    .brand{ display:flex; align-items:center; gap:12px; }
    .logo-mask{ width:48px; height:48px; display:block; background-color:#b6f902; -webkit-mask:url('logotipo.svg') center/contain no-repeat; mask:url('logotipo.svg') center/contain no-repeat; }
    .brand a { display: inline-block; line-height: 0; }
    .header-actions { display: flex; align-items: center; gap: 20px; }
    .menu-btn { width: 30px; height: 30px; padding: 0; background: transparent; border: 0; transition: background-color 0.2s ease; display: flex; align-items: center; justify-content: center; }
    .menu-btn:hover { background: rgba(255,255,255,0.1); }
    .menu-icon { width: 20px; height: 20px; display: block; filter: brightness(0) invert(1); }
    
    /* Menu lateral */
    .sidebar { position: fixed; top: 0; left: -300px; width: 300px; height: 100vh; background: var(--card); border-right: 1px solid var(--border); box-shadow: 4px 0 20px rgba(0,0,0,0.1); transition: left 0.3s ease; z-index: 1000; }
    .sidebar.open { left: 0; }
    .sidebar-header { display: flex; align-items: center; justify-content: space-between; padding: 20px; border-bottom: 1px solid var(--border); }
    .sidebar-header h3 { margin: 0; color: var(--primary); }
    .btn-close { background: none; border: none; font-size: 24px; cursor: pointer; color: var(--muted); }
    .sidebar-nav { padding: 20px 0; }
    .nav-item { display: flex; align-items: center; gap: 12px; padding: 16px 20px; color: var(--text); text-decoration: none; transition: background-color 0.2s; }
    .nav-item:hover { background-color: var(--bg); }
    .nav-item.active { background-color: var(--primary); color: #fff; }
    .nav-icon { font-size: 20px; }
    .sidebar-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); opacity: 0; visibility: hidden; transition: all 0.3s ease; z-index: 999; }
    .sidebar-overlay.open { opacity: 1; visibility: visible; }
    
    .wrap{ max-width:1400px; margin:0 auto; padding:20px; }
    .card{ background:var(--card); border:1px solid var(--border); border-radius:20px; padding:18px; box-shadow:0 10px 30px rgba(16,20,40,0.08); margin-bottom: 20px; }
    h1{ margin:0 0 8px 0; font-size:24px; font-weight:800; }
    p.helper{ margin:0 0 16px 0; color:var(--muted); }
    .btn{ background:var(--primary); color:#fff; border:none; border-radius:9999px; padding:10px 16px; cursor:pointer; font-size: 14px; }
    .btn.secondary{ background:var(--muted); }
    .btn.success{ background:var(--success); }
    .btn.warning{ background:var(--warning); }
    .btn.danger{ background:var(--danger); }
    .btn.small{ padding: 6px 12px; font-size: 12px; }
    .error{ color:var(--danger); min-height:18px; margin-top:6px; }
    .ok{ color:var(--success); min-height:18px; margin-top:6px; }
    
    /* Modal de Edi√ß√£o */
    .modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: 2000;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      z-index: 1999;
    }
    
    .modal-content {
      background: var(--card);
      border-radius: 16px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      width: 90%;
      max-width: 600px;
      max-height: 90vh;
      overflow-y: auto;
    }
    
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 20px;
      border-bottom: 1px solid var(--border);
    }
    
    .modal-header h3 {
      margin: 0;
      color: var(--primary);
    }
    
    .modal-body {
      padding: 20px;
    }
    
    .modal-footer {
      display: flex;
      justify-content: flex-end;
      gap: 12px;
      padding: 20px;
      border-top: 1px solid var(--border);
    }
    
    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
    }
    
    /* Bot√µes de a√ß√£o */
    .action-buttons {
      display: flex;
      gap: 8px;
      justify-content: center;
    }
    
    .btn-icon {
      width: 32px;
      height: 32px;
      padding: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      border-radius: 6px;
    }
    
    .btn-icon.warning {
      background: var(--warning);
      color: white;
    }
    
    .btn-icon.danger {
      background: var(--danger);
      color: white;
    }
    
         .btn-icon:hover {
       opacity: 0.8;
       transform: scale(1.05);
     }
     
     /* Upload de imagem */
     .image-upload-container {
       border: 2px dashed var(--border);
       border-radius: 8px;
       padding: 20px;
       text-align: center;
       transition: border-color 0.3s ease;
       cursor: pointer;
     }
     
     .image-upload-container:hover {
       border-color: var(--primary);
     }
     
     .image-input {
       display: none;
     }
     
     .image-preview {
       position: relative;
       min-height: 120px;
       display: flex;
       align-items: center;
       justify-content: center;
     }
     
     .image-placeholder {
       display: flex;
       flex-direction: column;
       align-items: center;
       gap: 8px;
       color: var(--muted);
     }
     
     .image-placeholder span {
       font-size: 32px;
     }
     
     .image-placeholder p {
       margin: 0;
       font-size: 14px;
     }
     
     .image-preview img {
       border: 2px solid var(--border);
       border-radius: 8px;
     }
    
    /* Controles de tabela */
    .table-controls {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
      gap: 16px;
      flex-wrap: wrap;
    }
    
    .search-box {
      flex: 1;
      min-width: 200px;
    }
    
    .search-input {
      width: 100%;
      padding: 8px 12px;
      border: 1px solid var(--border);
      border-radius: 6px;
      font-size: 14px;
    }
    
    .filter-box {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }
    
    .filter-select {
      padding: 8px 12px;
      border: 1px solid var(--border);
      border-radius: 6px;
      font-size: 14px;
      min-width: 120px;
    }
    
    .pagination-controls {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .pagination-select {
      padding: 6px 8px;
      border: 1px solid var(--border);
      border-radius: 4px;
      font-size: 14px;
    }
    
    /* Pagina√ß√£o */
    .pagination {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 16px;
      margin-top: 20px;
      padding: 16px 0;
    }
    
    .page-info {
      font-size: 14px;
      color: var(--muted);
      min-width: 120px;
      text-align: center;
    }
    
         /* Layout da configura√ß√£o */
     .section-header {
       display: flex;
       justify-content: space-between;
       align-items: center;
       margin-bottom: 16px;
       padding-bottom: 12px;
       border-bottom: 1px solid var(--border);
     }
     .section-title {
       font-size: 18px;
       font-weight: 700;
       color: var(--primary);
     }
    
    /* Formul√°rios */
    .form-group {
      margin-bottom: 16px;
    }
    .form-group label {
      display: block;
      font-size: 14px;
      font-weight: 600;
      color: var(--text);
      margin-bottom: 6px;
    }
    .form-group input,
    .form-group select,
    .form-group textarea {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid var(--border);
      border-radius: 8px;
      font-size: 14px;
      background: var(--card);
      color: var(--text);
    }
    .form-group input:focus,
    .form-group select:focus,
    .form-group textarea:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(90,3,154,0.1);
    }
    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }
    
    /* Tabelas */
    .table-container {
      overflow-x: auto;
      margin-top: 16px;
    }
    .data-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 14px;
    }
    .data-table th,
    .data-table td {
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid var(--border);
    }
    .data-table th {
      background: var(--bg);
      font-weight: 600;
      color: var(--primary);
    }
    .data-table tr:hover {
      background: var(--bg);
    }
    
    /* Status badges */
    .status-badge {
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
    }
    .status-active { background: rgba(18,128,90,0.1); color: var(--success); }
    .status-inactive { background: rgba(220,38,38,0.1); color: var(--danger); }
    .status-low { background: rgba(245,158,11,0.1); color: var(--warning); }
    
    /* Bot√µes de a√ß√£o */
    .action-buttons {
      display: flex;
      gap: 8px;
    }
    .btn-icon {
      width: 32px;
      height: 32px;
      padding: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
    }
    
         /* Responsividade */
     @media (max-width: 768px) {
       .form-row {
         grid-template-columns: 1fr;
       }
     }
  </style>
</head>
<body>
  <div class="header">
    <div id="juntinhos">
      <div class="brand">
        <a href="dashboard.html" title="In√≠cio"><span class="logo-mask" aria-label="Neon"></span></a>
      </div>
      <button id="btnMenu" class="menu-btn" title="Menu">
        <img src="menu.svg" alt="Menu" class="menu-icon" />
      </button>
    </div>
    <div class="header-actions">
      <a href="dashboard.html" class="btn" style="background:rgba(255,255,255,0.12)">Voltar</a>
    </div>
  </div>

  <!-- Menu lateral -->
  <div id="sidebar" class="sidebar">
    <div class="sidebar-header">
      <h3>Menu</h3>
      <button id="btnCloseSidebar" class="btn-close">&times;</button>
    </div>
    <nav class="sidebar-nav">
      <a href="dashboard.html" class="nav-item">
        <span class="nav-icon">üè†</span>
        Dashboard
      </a>
      <a href="extrato.html" class="nav-item">
        <span class="nav-icon">üìä</span>
        Extrato
      </a>
      <a href="pix.html" class="nav-item">
        <span class="nav-icon">üí∏</span>
        PIX
      </a>
      <a href="loja.html" class="nav-item">
        <span class="nav-icon">üõçÔ∏è</span>
        Loja
      </a>
      <a href="inventario.html" class="nav-item">
        <span class="nav-icon">üéí</span>
        Meu Invent√°rio
      </a>
      <a href="lojaconfig.html" class="nav-item active">
        <span class="nav-icon">‚öôÔ∏è</span>
        Config Loja
      </a>
      <a href="ocorrencias.html" class="nav-item">
        <span class="nav-icon">‚ö†Ô∏è</span>
        Ocorr√™ncias
      </a>
      <a href="adicionarAluno.html" class="nav-item">
        <span class="nav-icon">üë§</span>
        Adicionar Aluno
      </a>
      <a href="dev.html" class="nav-item">
        <span class="nav-icon">üîß</span>
        Dev
      </a>
    </nav>
  </div>

  <!-- Overlay para fechar o menu -->
  <div id="sidebarOverlay" class="sidebar-overlay"></div>

  <div class="wrap">
    <div id="unauth" class="card" style="display:none; text-align:center;">
      <h1>Acesso n√£o autorizado</h1>
      <p class="helper">Apenas administradores podem acessar a configura√ß√£o da loja.</p>
      <a class="btn" href="index.html">Ir para login</a>
    </div>

    <div id="content" style="display:none;">
      <div class="card">
        <h1>Configura√ß√£o da Loja</h1>
        <p class="helper">Gerencie categorias, produtos e estoque da loja digital.</p>
      </div>

             <!-- Se√ß√£o de Categorias -->
       <div class="card">
         <div class="section-header">
           <h3 class="section-title">Categorias</h3>
           <button id="btnAddCategory" class="btn success">+ Nova Categoria</button>
         </div>
         
         <div class="table-container">
           <div class="table-controls">
             <div class="search-box">
               <input type="text" id="categorySearch" placeholder="üîç Buscar categoria..." class="search-input">
             </div>
           </div>
           <table class="data-table" id="categoriesTable">
             <thead>
               <tr>
                 <th>Nome</th>
                 <th>Descri√ß√£o</th>
                 <th>Produtos</th>
                 <th>A√ß√µes</th>
               </tr>
             </thead>
             <tbody id="categoriesTableBody">
               <!-- Categorias ser√£o carregadas aqui -->
             </tbody>
           </table>
         </div>
       </div>

       <!-- Se√ß√£o de Subcategorias -->
       <div class="card">
         <div class="section-header">
           <h3 class="section-title">Subcategorias</h3>
           <button id="btnAddSubcategory" class="btn success">+ Nova Subcategoria</button>
         </div>
         
                    <div class="table-container">
             <div class="table-controls">
               <div class="search-box">
                 <input type="text" id="subcategorySearch" placeholder="üîç Buscar subcategoria..." class="search-input">
               </div>
               <div class="filter-box">
                 <select id="subcategoryCategoryFilter" class="filter-select">
                   <option value="">Todas as categorias</option>
                 </select>
               </div>
             </div>
             <table class="data-table" id="subcategoriesTable">
               <thead>
                 <tr>
                   <th>Categoria</th>
                   <th>Subcategoria</th>
                   <th>Produtos</th>
                   <th>A√ß√µes</th>
                 </tr>
               </thead>
               <tbody id="subcategoriesTableBody">
                 <!-- Subcategorias ser√£o carregadas aqui -->
               </tbody>
             </table>
           </div>
       </div>

      <!-- Se√ß√£o de Produtos -->
      <div class="card">
        <div class="section-header">
          <h3 class="section-title">Produtos</h3>
          <button id="btnAddProduct" class="btn success">+ Novo Produto</button>
        </div>
        
        <div class="table-container">
          <div class="table-controls">
            <div class="search-box">
              <input type="text" id="productSearch" placeholder="üîç Buscar produto..." class="search-input">
            </div>
            <div class="filter-box">
              <select id="productCategoryFilter" class="filter-select">
                <option value="">Todas as categorias</option>
              </select>
              <select id="productSubcategoryFilter" class="filter-select">
                <option value="">Todas as subcategorias</option>
              </select>
              <select id="productStatusFilter" class="filter-select">
                <option value="">Todos os status</option>
                <option value="active">Ativo</option>
                <option value="inactive">Inativo</option>
              </select>
            </div>
            <div class="pagination-controls">
              <label for="itemsPerPage">Itens por p√°gina:</label>
              <select id="itemsPerPage" class="pagination-select">
                <option value="10">10</option>
                <option value="25">25</option>
                <option value="50">50</option>
              </select>
            </div>
          </div>
          <table class="data-table" id="productsTable">
                         <thead>
               <tr>
                 <th>Imagem</th>
                 <th>Nome</th>
                 <th>Categoria</th>
                 <th>Subcategoria</th>
                 <th>Pre√ßo</th>
                 <th>Estoque</th>
                 <th>Status</th>
                 <th>A√ß√µes</th>
               </tr>
             </thead>
            <tbody id="productsTableBody">
              <!-- Produtos ser√£o carregados aqui -->
            </tbody>
          </table>
          <div class="pagination">
            <button id="prevPage" class="btn secondary btn-small">‚Üê Anterior</button>
            <span id="pageInfo" class="page-info">P√°gina 1 de 1</span>
            <button id="nextPage" class="btn secondary btn-small">Pr√≥xima ‚Üí</button>
          </div>
        </div>
      </div>
      
      <div id="msg" class="ok"></div>
      <div id="err" class="error"></div>
    </div>
  </div>

  <!-- Modal de Edi√ß√£o de Produto -->
  <div id="editProductModal" class="modal" style="display: none;">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Editar Produto</h3>
        <button id="btnCloseEditModal" class="btn-close">&times;</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label for="editProductName">Nome do Produto</label>
          <input type="text" id="editProductName" placeholder="Ex.: Camiseta Neon">
        </div>
        
        <div class="form-group">
          <div class="form-row">
            <div>
              <label for="editProductCategory">Categoria</label>
              <select id="editProductCategory">
                <option value="">Selecione uma categoria</option>
              </select>
            </div>
            <div>
              <label for="editProductSubcategory">Subcategoria</label>
              <select id="editProductSubcategory">
                <option value="">Selecione uma subcategoria</option>
              </select>
            </div>
          </div>
        </div>
        
        <div class="form-group">
          <div class="form-row">
            <div>
              <label for="editProductPrice">Pre√ßo (N$)</label>
              <input type="number" id="editProductPrice" min="0" step="0.01" placeholder="0.00">
            </div>
            <div>
              <label for="editProductStock">Estoque</label>
              <input type="number" id="editProductStock" min="0" placeholder="0">
            </div>
          </div>
        </div>
        
                 <div class="form-group">
           <div class="form-row">
             <div>
               <label for="editProductStatus">Status</label>
               <select id="editProductStatus">
                 <option value="active">Ativo</option>
                 <option value="inactive">Inativo</option>
               </select>
             </div>
             <div>
               <label for="editProductDescription">Descri√ß√£o</label>
               <textarea id="editProductDescription" rows="3" placeholder="Descri√ß√£o detalhada do produto"></textarea>
             </div>
           </div>
         </div>
         
         <div class="form-group">
           <label for="editProductImage">Imagem do Produto</label>
           <div class="image-upload-container">
             <input type="file" id="editProductImage" accept="image/*" class="image-input">
             <div class="image-preview" id="editProductImagePreview">
               <img id="editProductCurrentImage" src="" alt="Imagem atual" style="display: none; max-width: 200px; max-height: 200px; border-radius: 8px;">
               <div class="image-placeholder" id="editProductImagePlaceholder">
                 <span>üì∑</span>
                 <p>Clique para selecionar uma imagem</p>
               </div>
             </div>
           </div>
         </div>
      </div>
      <div class="modal-footer">
        <button id="btnCancelEdit" class="btn secondary">Cancelar</button>
        <button id="btnSaveEdit" class="btn success">Salvar Altera√ß√µes</button>
      </div>
    </div>
  </div>

  <!-- Modal de Edi√ß√£o de Categoria -->
  <div id="editCategoryModal" class="modal" style="display: none;">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Editar Categoria</h3>
        <button id="btnCloseEditCategoryModal" class="btn-close">&times;</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label for="editCategoryName">Nome da Categoria</label>
          <input type="text" id="editCategoryName" placeholder="Ex.: Vestu√°rio">
        </div>
        
        <div class="form-group">
          <label for="editCategoryDescription">Descri√ß√£o</label>
          <textarea id="editCategoryDescription" rows="3" placeholder="Descri√ß√£o da categoria"></textarea>
        </div>
      </div>
      <div class="modal-footer">
        <button id="btnCancelEditCategory" class="btn secondary">Cancelar</button>
        <button id="btnSaveEditCategory" class="btn success">Salvar Altera√ß√µes</button>
      </div>
    </div>
  </div>

  <!-- Modal de Edi√ß√£o de Subcategoria -->
  <div id="editSubcategoryModal" class="modal" style="display: none;">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Editar Subcategoria</h3>
        <button id="btnCloseEditSubcategoryModal" class="btn-close">&times;</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <div class="form-row">
            <div>
              <label for="editSubcategoryCategory">Categoria Pai</label>
              <select id="editSubcategoryCategory">
                <option value="">Selecione uma categoria</option>
              </select>
            </div>
            <div>
              <label for="editSubcategoryName">Nome da Subcategoria</label>
              <input type="text" id="editSubcategoryName" placeholder="Ex.: Camisetas">
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button id="btnCancelEditSubcategory" class="btn secondary">Cancelar</button>
        <button id="btnSaveEditSubcategory" class="btn success">Salvar Altera√ß√µes</button>
      </div>
    </div>
  </div>

     <!-- Modal de Nova Categoria -->
   <div id="newCategoryModal" class="modal" style="display: none;">
     <div class="modal-content">
       <div class="modal-header">
         <h3>Nova Categoria</h3>
         <button id="btnCloseNewCategoryModal" class="btn-close">&times;</button>
       </div>
       <div class="modal-body">
         <div class="form-group">
           <label for="newCategoryName">Nome da Categoria</label>
           <input type="text" id="newCategoryName" placeholder="Ex.: Vestu√°rio">
         </div>
         
         <div class="form-group">
           <label for="newCategoryDescription">Descri√ß√£o</label>
           <textarea id="newCategoryDescription" rows="3" placeholder="Descri√ß√£o da categoria"></textarea>
         </div>
       </div>
       <div class="modal-footer">
         <button id="btnCancelNewCategory" class="btn secondary">Cancelar</button>
         <button id="btnSaveNewCategory" class="btn success">Salvar Categoria</button>
       </div>
     </div>
   </div>

   <!-- Modal de Nova Subcategoria -->
   <div id="newSubcategoryModal" class="modal" style="display: none;">
     <div class="modal-content">
       <div class="modal-header">
         <h3>Nova Subcategoria</h3>
         <button id="btnCloseNewSubcategoryModal" class="btn-close">&times;</button>
       </div>
       <div class="modal-body">
         <div class="form-group">
           <div class="form-row">
             <div>
               <label for="newSubcategoryCategory">Categoria Pai</label>
               <select id="newSubcategoryCategory">
                 <option value="">Selecione uma categoria</option>
               </select>
             </div>
             <div>
               <label for="newSubcategoryName">Nome da Subcategoria</label>
               <input type="text" id="newSubcategoryName" placeholder="Ex.: Camisetas">
             </div>
           </div>
         </div>
       </div>
       <div class="modal-footer">
         <button id="btnCancelNewSubcategory" class="btn secondary">Cancelar</button>
         <button id="btnSaveNewSubcategory" class="btn success">Salvar Subcategoria</button>
       </div>
     </div>
   </div>

   <!-- Modal de Novo Produto -->
   <div id="newProductModal" class="modal" style="display: none;">
     <div class="modal-content">
       <div class="modal-header">
         <h3>Novo Produto</h3>
         <button id="btnCloseNewProductModal" class="btn-close">&times;</button>
       </div>
       <div class="modal-body">
         <div class="form-group">
           <div class="form-row">
             <div>
               <label for="newProductName">Nome do Produto</label>
               <input type="text" id="newProductName" placeholder="Ex.: Camiseta Neon">
             </div>
             <div>
               <label for="newProductCategory">Categoria</label>
               <select id="newProductCategory">
                 <option value="">Selecione uma categoria</option>
               </select>
             </div>
           </div>
         </div>
         
         <div class="form-group">
           <div class="form-row">
             <div>
               <label for="newProductSubcategory">Subcategoria</label>
               <select id="newProductSubcategory">
                 <option value="">Selecione uma subcategoria</option>
               </select>
             </div>
             <div>
               <label for="newProductPrice">Pre√ßo (N$)</label>
               <input type="number" id="newProductPrice" min="0" step="0.01" placeholder="0.00">
             </div>
           </div>
         </div>
         
         <div class="form-group">
           <div class="form-row">
             <div>
               <label for="newProductStock">Estoque</label>
               <input type="number" id="newProductStock" min="0" placeholder="0">
             </div>
             <div>
               <label for="newProductStatus">Status</label>
               <select id="newProductStatus">
                 <option value="active">Ativo</option>
                 <option value="inactive">Inativo</option>
               </select>
             </div>
           </div>
         </div>
         
         <div class="form-group">
           <div class="form-row">
             <div>
               <label for="newProductConsumable">Consum√≠vel</label>
               <select id="newProductConsumable">
                 <option value="false">N√£o</option>
                 <option value="true">Sim</option>
               </select>
             </div>
             <div>
               <!-- Espa√ßador para manter o layout -->
             </div>
           </div>
         </div>
         
         <div class="form-group">
           <label for="newProductDescription">Descri√ß√£o</label>
           <textarea id="newProductDescription" rows="3" placeholder="Descri√ß√£o detalhada do produto"></textarea>
         </div>
         
         <div class="form-group">
           <label for="newProductImage">Imagem do Produto</label>
           <div class="image-upload-container">
             <input type="file" id="newProductImage" accept="image/*" class="image-input">
             <div class="image-preview" id="newProductImagePreview">
               <div class="image-placeholder" id="newProductImagePlaceholder">
                 <span>üì∑</span>
                 <p>Clique para selecionar uma imagem</p>
               </div>
             </div>
           </div>
         </div>
       </div>
       <div class="modal-footer">
         <button id="btnCancelNewProduct" class="btn secondary">Cancelar</button>
         <button id="btnSaveNewProduct" class="btn success">Salvar Produto</button>
       </div>
     </div>
   </div>

  <!-- Overlay do Modal -->
  <div id="modalOverlay" class="modal-overlay" style="display: none;"></div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-analytics.js";
    import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";
         import { getFirestore, collection, query, where, orderBy, getDocs, addDoc, doc, updateDoc, deleteDoc, serverTimestamp, setDoc } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";
     import { getStorage, ref, uploadBytes, getDownloadURL, deleteObject } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-storage.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBHU6yFDCKp9jm9tPGyRqQJFS3amewuuQY",
      authDomain: "crmdaneon.firebaseapp.com",
      projectId: "crmdaneon",
      storageBucket: "crmdaneon.firebasestorage.app",
      messagingSenderId: "564595832938",
      appId: "1:564595832938:web:16fb660d8d433ae5f3f213",
      measurementId: "G-D3G4M9F17R"
    };

         const app = initializeApp(firebaseConfig);
     
     try { getAnalytics(app); } catch {}
     try { await signInAnonymously(getAuth(app)); } catch {}
     
     // Inicializar Firebase Storage
     const storage = getStorage(app);

    // Estrutura do banco: bancodaneondb/loja/{categorias|subcategorias|produtos}
    const db = (() => { try { return getFirestore(app, 'bancodaneondb'); } catch { return getFirestore(app); } })();
    
    // Estrutura correta: bancodaneondb/loja/config/categorias/{docId}
    // Primeiro criamos um documento 'config' na cole√ß√£o 'loja'
    // Depois criamos subcole√ß√µes dentro dele
    
    // Elementos da interface
    const unauthEl = document.getElementById('unauth');
    const contentEl = document.getElementById('content');
    const msgEl = document.getElementById('msg');
    const errEl = document.getElementById('err');
    
         // Bot√µes de a√ß√£o
     const btnAddCategory = document.getElementById('btnAddCategory');
     const btnAddSubcategory = document.getElementById('btnAddSubcategory');
    
    // Formul√°rios de produto (removidos da p√°gina principal)
    const btnAddProduct = document.getElementById('btnAddProduct');
    
         // Elementos dos modais de nova categoria e subcategoria
     const newCategoryModal = document.getElementById('newCategoryModal');
     const newCategoryName = document.getElementById('newCategoryName');
     const newCategoryDescription = document.getElementById('newCategoryDescription');
     const btnCloseNewCategoryModal = document.getElementById('btnCloseNewCategoryModal');
     const btnCancelNewCategory = document.getElementById('btnCancelNewCategory');
     const btnSaveNewCategory = document.getElementById('btnSaveNewCategory');
     
     const newSubcategoryModal = document.getElementById('newSubcategoryModal');
     const newSubcategoryCategory = document.getElementById('newSubcategoryCategory');
     const newSubcategoryName = document.getElementById('newSubcategoryName');
     const btnCloseNewSubcategoryModal = document.getElementById('btnCloseNewSubcategoryModal');
     const btnCancelNewSubcategory = document.getElementById('btnCancelNewSubcategory');
     const btnSaveNewSubcategory = document.getElementById('btnSaveNewSubcategory');
     
     // Elementos do modal de novo produto
     const newProductModal = document.getElementById('newProductModal');
     const newProductName = document.getElementById('newProductName');
     const newProductCategory = document.getElementById('newProductCategory');
     const newProductSubcategory = document.getElementById('newProductSubcategory');
     const newProductPrice = document.getElementById('newProductPrice');
     const newProductStock = document.getElementById('newProductStock');
     const newProductStatus = document.getElementById('newProductStatus');
     const newProductConsumable = document.getElementById('newProductConsumable');
     const newProductDescription = document.getElementById('newProductDescription');
     const newProductImage = document.getElementById('newProductImage');
     const newProductImagePreview = document.getElementById('newProductImagePreview');
     const newProductImagePlaceholder = document.getElementById('newProductImagePlaceholder');
     const btnCloseNewProductModal = document.getElementById('btnCloseNewProductModal');
     const btnCancelNewProduct = document.getElementById('btnCancelNewProduct');
     const btnSaveNewProduct = document.getElementById('btnSaveNewProduct');
    
    // Elementos do modal de edi√ß√£o
    const editProductModal = document.getElementById('editProductModal');
    const modalOverlay = document.getElementById('modalOverlay');
    const editProductName = document.getElementById('editProductName');
    const editProductCategory = document.getElementById('editProductCategory');
    const editProductSubcategory = document.getElementById('editProductSubcategory');
    const editProductPrice = document.getElementById('editProductPrice');
    const editProductStock = document.getElementById('editProductStock');
         const editProductStatus = document.getElementById('editProductStatus');
     const editProductDescription = document.getElementById('editProductDescription');
     const editProductImage = document.getElementById('editProductImage');
     const editProductImagePreview = document.getElementById('editProductImagePreview');
     const editProductCurrentImage = document.getElementById('editProductCurrentImage');
     const editProductImagePlaceholder = document.getElementById('editProductImagePlaceholder');
     const btnCloseEditModal = document.getElementById('btnCloseEditModal');
    const btnCancelEdit = document.getElementById('btnCancelEdit');
    const btnSaveEdit = document.getElementById('btnSaveEdit');
    
    // Elementos dos modais de categoria e subcategoria
    const editCategoryModal = document.getElementById('editCategoryModal');
    const editSubcategoryModal = document.getElementById('editSubcategoryModal');
    const editCategoryName = document.getElementById('editCategoryName');
    const editCategoryDescription = document.getElementById('editCategoryDescription');
    const editSubcategoryCategory = document.getElementById('editSubcategoryCategory');
    const editSubcategoryName = document.getElementById('editSubcategoryName');
    const btnCloseEditCategoryModal = document.getElementById('btnCloseEditCategoryModal');
    const btnCancelEditCategory = document.getElementById('btnCancelEditCategory');
    const btnSaveEditCategory = document.getElementById('btnSaveEditCategory');
    const btnCloseEditSubcategoryModal = document.getElementById('btnCloseEditSubcategoryModal');
    const btnCancelEditSubcategory = document.getElementById('btnCancelEditSubcategory');
    const btnSaveEditSubcategory = document.getElementById('btnSaveEditSubcategory');
    
    // Elementos de busca e filtro
    const categorySearch = document.getElementById('categorySearch');
    const subcategorySearch = document.getElementById('subcategorySearch');
    const productSearch = document.getElementById('productSearch');
    const subcategoryCategoryFilter = document.getElementById('subcategoryCategoryFilter');
    const productCategoryFilter = document.getElementById('productCategoryFilter');
    const productSubcategoryFilter = document.getElementById('productSubcategoryFilter');
    const productStatusFilter = document.getElementById('productStatusFilter');
    
    // Elementos de pagina√ß√£o
    const itemsPerPage = document.getElementById('itemsPerPage');
    const prevPage = document.getElementById('prevPage');
    const nextPage = document.getElementById('nextPage');
    const pageInfo = document.getElementById('pageInfo');
    
    // Tabelas
    const categoriesTableBody = document.getElementById('categoriesTableBody');
    const subcategoriesTableBody = document.getElementById('subcategoriesTableBody');
    const productsTableBody = document.getElementById('productsTableBody');
    
    // Controles do menu lateral
    const btnMenu = document.getElementById('btnMenu');
    const sidebar = document.getElementById('sidebar');
    const sidebarOverlay = document.getElementById('sidebarOverlay');
    const btnCloseSidebar = document.getElementById('btnCloseSidebar');

    // Verifica√ß√£o de sess√£o
    const sessRaw = localStorage.getItem('bn.currentUser');
    
    let sess = null;
    try { sess = JSON.parse(sessRaw); } catch { sess = null; }

    // Verificar se √© administrador (classe: "professor")
    if (!sess || !sess.user || sess.classe !== 'professor') {
      if (unauthEl) {
        unauthEl.style.display = 'block';
      } else {
        console.error('‚ùå Elemento unauth n√£o encontrado!');
      }
    } else {
      if (contentEl) {
        contentEl.style.display = 'block';
        initializeLojaConfig();
      } else {
        console.error('‚ùå Elemento content n√£o encontrado!');
      }
    }

    // Inicializa√ß√£o da aplica√ß√£o
    async function initializeLojaConfig() {
      try {
        // Carregar categorias e subcategorias primeiro
        await loadCategories();
        await loadSubcategories();
        
        // Depois carregar produtos para contagem
        await loadProductsForCounting();
        
        // Atualizar contadores ap√≥s carregar produtos
        updateProductCounts();
        
        // Finalmente carregar produtos para exibi√ß√£o
        await loadProducts();
        
        setupEventListeners();
        setupMenuControls();
      } catch (error) {
        console.error('‚ùå Erro na inicializa√ß√£o:', error);
        showError('Erro ao inicializar aplica√ß√£o: ' + error.message);
      }
    }

    // Configura√ß√£o dos controles do menu
    function setupMenuControls() {
      if (btnMenu && sidebar && sidebarOverlay) {
        btnMenu.addEventListener('click', () => {
          sidebar.classList.add('open');
          sidebarOverlay.classList.add('open');
        });
      } else {
        console.error('‚ùå Elementos do menu n√£o encontrados');
      }

      if (btnCloseSidebar && sidebar && sidebarOverlay) {
        btnCloseSidebar.addEventListener('click', () => {
          sidebar.classList.remove('open');
          sidebarOverlay.classList.remove('open');
        });
      } else {
        console.error('‚ùå Elementos para fechar sidebar n√£o encontrados');
      }

      if (sidebarOverlay && sidebar) {
        sidebarOverlay.addEventListener('click', () => {
          sidebar.classList.remove('open');
          sidebarOverlay.classList.remove('open');
        });
      } else {
        console.error('‚ùå Elementos do overlay n√£o encontrados');
      }
    }

    
    
         // Configura√ß√£o dos event listeners
     function setupEventListeners() {
       // Categorias
       if (btnAddCategory) {
         btnAddCategory.addEventListener('click', () => {
           openNewCategoryModal();
         });
       } else {
         console.error('‚ùå btnAddCategory n√£o encontrado');
       }
       
       // Subcategorias
       if (btnAddSubcategory) {
         btnAddSubcategory.addEventListener('click', () => {
           openNewSubcategoryModal();
         });
       } else {
         console.error('‚ùå btnAddSubcategory n√£o encontrado');
       }
      
      // Produtos
      if (btnAddProduct) {
        btnAddProduct.addEventListener('click', () => {
          openNewProductModal();
        });
      } else {
        console.error('‚ùå btnAddProduct n√£o encontrado');
      }
      
      
      
      // Event listeners para o modal de edi√ß√£o
      if (btnCloseEditModal) {
        btnCloseEditModal.addEventListener('click', closeEditModal);
      } else {
        console.error('‚ùå btnCloseEditModal n√£o encontrado');
      }
      
      if (btnCancelEdit) {
        btnCancelEdit.addEventListener('click', closeEditModal);
      } else {
        console.error('‚ùå btnCancelEdit n√£o encontrado');
      }
      
      if (btnSaveEdit) {
        btnSaveEdit.addEventListener('click', handleSaveEdit);
      } else {
        console.error('‚ùå btnSaveEdit n√£o encontrado');
      }
      
             // Event listener para mudan√ßa de categoria no modal
       if (editProductCategory) {
         editProductCategory.addEventListener('change', updateEditSubcategoryOptions);
       } else {
         console.error('‚ùå editProductCategory n√£o encontrado');
       }
       
       // Event listeners para upload de imagem
       if (editProductImage) {
         editProductImage.addEventListener('change', handleEditProductImageChange);
       }
       
       if (newProductImage) {
         newProductImage.addEventListener('change', handleNewProductImageChange);
       }
       
       // Event listeners para clicar nos containers de imagem
       if (editProductImagePreview) {
         editProductImagePreview.addEventListener('click', () => editProductImage.click());
       }
       
       if (newProductImagePreview) {
         newProductImagePreview.addEventListener('click', () => newProductImage.click());
       }
      
             // Event listener para fechar modal clicando no overlay
       if (modalOverlay) {
         modalOverlay.addEventListener('click', () => {
           closeEditModal();
           closeEditCategoryModal();
           closeEditSubcategoryModal();
           closeNewProductModal();
           closeNewCategoryModal();
           closeNewSubcategoryModal();
         });
       } else {
         console.error('‚ùå modalOverlay n√£o encontrado');
       }
      
      // Event listeners para modais de categoria e subcategoria
      if (btnCloseEditCategoryModal) {
        btnCloseEditCategoryModal.addEventListener('click', closeEditCategoryModal);
      }
      
      if (btnCancelEditCategory) {
        btnCancelEditCategory.addEventListener('click', closeEditCategoryModal);
      }
      
      if (btnSaveEditCategory) {
        btnSaveEditCategory.addEventListener('click', handleSaveEditCategory);
      }
      
      if (btnCloseEditSubcategoryModal) {
        btnCloseEditSubcategoryModal.addEventListener('click', closeEditSubcategoryModal);
      }
      
      if (btnCancelEditSubcategory) {
        btnCancelEditSubcategory.addEventListener('click', closeEditSubcategoryModal);
      }
      
      if (btnSaveEditSubcategory) {
        btnSaveEditSubcategory.addEventListener('click', handleSaveEditSubcategory);
      }
      
             // Event listeners para os modais de nova categoria e subcategoria
       if (btnCloseNewCategoryModal) {
         btnCloseNewCategoryModal.addEventListener('click', closeNewCategoryModal);
       }
       
       if (btnCancelNewCategory) {
         btnCancelNewCategory.addEventListener('click', closeNewCategoryModal);
       }
       
       if (btnSaveNewCategory) {
         btnSaveNewCategory.addEventListener('click', handleSaveNewCategory);
       }
       
       if (btnCloseNewSubcategoryModal) {
         btnCloseNewSubcategoryModal.addEventListener('click', closeNewSubcategoryModal);
       }
       
       if (btnCancelNewSubcategory) {
         btnCancelNewSubcategory.addEventListener('click', closeNewSubcategoryModal);
       }
       
       if (btnSaveNewSubcategory) {
         btnSaveNewSubcategory.addEventListener('click', handleSaveNewSubcategory);
       }
       
       // Event listeners para o modal de novo produto
       if (btnCloseNewProductModal) {
         btnCloseNewProductModal.addEventListener('click', closeNewProductModal);
       }
       
       if (btnCancelNewProduct) {
         btnCancelNewProduct.addEventListener('click', closeNewProductModal);
       }
       
       if (btnSaveNewProduct) {
         btnSaveNewProduct.addEventListener('click', handleSaveNewProduct);
       }
      
      // Event listener para mudan√ßa de categoria no modal de novo produto
      if (newProductCategory) {
        newProductCategory.addEventListener('change', updateNewProductSubcategoryOptions);
      }
      
      // Event listeners para busca e filtros
      if (categorySearch) {
        categorySearch.addEventListener('input', filterCategories);
      }
      
      if (subcategorySearch) {
        subcategorySearch.addEventListener('input', filterSubcategories);
      }
      
      if (productSearch) {
        productSearch.addEventListener('input', filterProducts);
      }
      
      if (productCategoryFilter) {
        productCategoryFilter.addEventListener('change', filterProducts);
      }
      
      if (productSubcategoryFilter) {
        productSubcategoryFilter.addEventListener('change', filterProducts);
      }
      
      if (productStatusFilter) {
        productStatusFilter.addEventListener('change', filterProducts);
      }
      
      if (subcategoryCategoryFilter) {
        subcategoryCategoryFilter.addEventListener('change', filterSubcategories);
      }
      
      // Event listeners para pagina√ß√£o
      if (itemsPerPage) {
        itemsPerPage.addEventListener('change', changeItemsPerPage);
      }
      
      if (prevPage) {
        prevPage.addEventListener('click', prevPageProducts);
      }
      
      if (nextPage) {
        nextPage.addEventListener('click', nextPageProducts);
      }
    }

    // ===== FUN√á√ïES DE CATEGORIA =====
    async function loadCategories() {
      try {
        // Primeiro, garantir que o documento 'config' existe
        const configDocRef = doc(db, 'loja', 'config');
        try {
          await getDocs(collection(configDocRef, 'categorias'));
        } catch {
          // Se n√£o existir, criar o documento config
          await setDoc(configDocRef, { createdAt: serverTimestamp() });
        }
        
        const categoriesCol = collection(db, 'loja', 'config', 'categorias');
        
        const q = query(categoriesCol, orderBy('name'));
        
        const snap = await getDocs(q);
        
        const categories = [];
        snap.forEach(doc => {
          const data = doc.data();
          categories.push({ id: doc.id, ...data });
        });
        
        // Armazenar categorias para filtros
        allCategories = categories;
        
        
        
        renderCategoriesTable(categories);
        updateCategorySelects(categories);
      } catch (error) {
        console.error('‚ùå Erro ao carregar categorias:', error);
        showError('Erro ao carregar categorias: ' + error.message);
      }
    }

    function renderCategoriesTable(categories) {
      if (!categoriesTableBody) {
        console.error('‚ùå categoriesTableBody n√£o encontrado');
        return;
      }
      
      categoriesTableBody.innerHTML = '';
      
      if (categories.length === 0) {
        const row = document.createElement('tr');
        row.innerHTML = '<td colspan="4" style="text-align: center; color: var(--muted);">Nenhuma categoria encontrada</td>';
        categoriesTableBody.appendChild(row);
        return;
      }
      
      categories.forEach((category, index) => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${category.name}</td>
          <td>${category.description || '-'}</td>
          <td>${category.productCount || 0}</td>
          <td>
            <div class="action-buttons">
              <button class="btn btn-icon warning" onclick="editCategory('${category.id}')" title="Editar">‚úèÔ∏è</button>
              <button class="btn btn-icon danger" onclick="deleteCategory('${category.id}')" title="Excluir">üóëÔ∏è</button>
            </div>
          </td>
        `;
        categoriesTableBody.appendChild(row);
      });
    }

    

    // ===== FUN√á√ïES DE SUBCATEGORIA =====
    
         // Fun√ß√£o para atualizar selects de subcategoria
     function updateSubcategorySelects(subcategories) {
       // Esta fun√ß√£o √© chamada quando subcategorias s√£o carregadas
       // Por enquanto, apenas verifica se o elemento existe
       // A l√≥gica de atualiza√ß√£o ser√° implementada quando necess√°rio
     }
    
    async function loadSubcategories() {
      try {
        const subcategoriesCol = collection(db, 'loja', 'config', 'subcategorias');
        
        const q = query(subcategoriesCol, orderBy('name'));
        
        const snap = await getDocs(q);
        
        const subcategories = [];
        snap.forEach(doc => {
          const data = doc.data();
          subcategories.push({ id: doc.id, ...data });
        });
        
        // Armazenar subcategorias para filtros
        allSubcategories = subcategories;
        
        
        renderSubcategoriesTable(subcategories);
        updateSubcategorySelects(subcategories);
      } catch (error) {
        console.error('‚ùå Erro ao carregar subcategorias:', error);
        showError('Erro ao carregar subcategorias: ' + error.message);
      }
    }

    function renderSubcategoriesTable(subcategories) {
      if (!subcategoriesTableBody) {
        console.error('‚ùå subcategoriesTableBody n√£o encontrado');
        return;
      }
      
      subcategoriesTableBody.innerHTML = '';
      
      if (subcategories.length === 0) {
        const row = document.createElement('tr');
        row.innerHTML = '<td colspan="4" style="text-align: center; color: var(--muted);">Nenhuma subcategoria encontrada</td>';
        subcategoriesTableBody.appendChild(row);
        return;
      }
      
      subcategories.forEach((subcategory, index) => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${subcategory.categoryName || '-'}</td>
          <td>${subcategory.name}</td>
          <td>${subcategory.productCount || 0}</td>
          <td>
            <div class="action-buttons">
              <button class="btn btn-icon warning" onclick="editSubcategory('${subcategory.id}')" title="Editar">‚úèÔ∏è</button>
              <button class="btn btn-icon danger" onclick="deleteSubcategory('${subcategory.id}')" title="Excluir">üóëÔ∏è</button>
            </div>
          </td>
        `;
        subcategoriesTableBody.appendChild(row);
      });
    }

    

    // ===== FUN√á√ïES DE PRODUTO =====
    
    // Fun√ß√£o para carregar produtos apenas para contagem (sem renderizar)
    async function loadProductsForCounting() {
      try {
        
        const productsCol = collection(db, 'loja', 'config', 'produtos');
        
        const q = query(productsCol, orderBy('name'));
        
        const snap = await getDocs(q);
        
        const products = [];
        snap.forEach(doc => {
          const data = doc.data();
          products.push({ id: doc.id, ...data });
        });
        
        
        // Armazenar produtos para contagem
        allProducts = products;
        
      } catch (error) {
        console.error('‚ùå Erro ao carregar produtos para contagem:', error);
      }
    }
    
    // Fun√ß√£o para atualizar contadores de produtos em categorias e subcategorias
    function updateProductCounts() {
      if (!allProducts || !allCategories || !allSubcategories) {
        console.error('‚ùå Dados insuficientes para atualizar contadores:', {
          produtos: allProducts?.length || 0,
          categorias: allCategories?.length || 0,
          subcategorias: allSubcategories?.length || 0
        });
        return;
      }
      
      
      // Contar produtos por categoria
      allCategories.forEach(category => {
        const productCount = allProducts.filter(product => 
          product.categoryId === category.id
        ).length;
        
        category.productCount = productCount;
      });
      
      // Contar produtos por subcategoria
      allSubcategories.forEach(subcategory => {
        const productCount = allProducts.filter(product => 
          product.subcategoryId === subcategory.id
        ).length;
        
        subcategory.productCount = productCount;
      });
      
    }
    
    async function loadProducts() {
      try {
        const productsCol = collection(db, 'loja', 'config', 'produtos');
        
        const q = query(productsCol, orderBy('name'));
        
        const snap = await getDocs(q);
        
        const products = [];
        snap.forEach(doc => {
          const data = doc.data();
          products.push({ id: doc.id, ...data });
        });
        
        // Armazenar todos os produtos para filtros
        allProducts = products;
        filteredProducts = products;
        
        
        // Console log para mostrar informa√ß√µes dos produtos

        products.forEach((product, index) => {

        });
        
        // Renderizar com pagina√ß√£o
        renderProductsTablePaginated();
        
        // Popular selects do modal de edi√ß√£o
        await populateEditCategorySelects();
        
        // Atualizar contadores de categorias e subcategorias
        updateProductCounts();
        
        // Re-renderizar tabelas com contadores atualizados
        renderCategoriesTable(allCategories);
        renderSubcategoriesTable(allSubcategories);
      } catch (error) {
        console.error('‚ùå Erro ao carregar produtos:', error);
        showError('Erro ao carregar produtos: ' + error.message);
      }
    }

    function renderProductsTable(products) {
      if (!productsTableBody) {
        console.error('‚ùå productsTableBody n√£o encontrado');
        return;
      }
      
      productsTableBody.innerHTML = '';
      
             if (products.length === 0) {
         const row = document.createElement('tr');
         row.innerHTML = '<td colspan="8" style="text-align: center; color: var(--muted);">Nenhum produto encontrado</td>';
         productsTableBody.appendChild(row);
         return;
       }
      
             products.forEach((product, index) => {
         const row = document.createElement('tr');
         const stockClass = product.stock <= 5 ? 'status-low' : 'status-active';
         const statusClass = product.status === 'active' ? 'status-active' : 'status-inactive';
         
         // Preparar imagem do produto
         const imageCell = product.imageUrl 
           ? `<img src="${product.imageUrl}" alt="${product.name}" style="width: 50px; height: 50px; object-fit: cover; border-radius: 4px; border: 1px solid var(--border);">`
           : '<span style="color: var(--muted); font-size: 12px;">Sem imagem</span>';
         
         row.innerHTML = `
           <td style="text-align: center;">${imageCell}</td>
           <td>${product.name}</td>
           <td>${product.categoryName || '-'}</td>
           <td>${product.subcategoryName || '-'}</td>
           <td>N$ ${product.price?.toFixed(2) || '0.00'}</td>
           <td><span class="status-badge ${stockClass}">${product.stock || 0}</span></td>
           <td><span class="status-badge ${statusClass}">${product.status === 'active' ? 'Ativo' : 'Inativo'}</span></td>
           <td>
             <div class="action-buttons">
               <button class="btn btn-icon warning" onclick="editProduct('${product.id}')" title="Editar">‚úèÔ∏è</button>
               <button class="btn btn-icon danger" onclick="deleteProduct('${product.id}')" title="Excluir">üóëÔ∏è</button>
             </div>
           </td>
         `;
         productsTableBody.appendChild(row);
       });
    }



    // ===== FUN√á√ïES AUXILIARES =====
         function updateCategorySelects(categories) {
       // Atualizar o select do modal de novo produto
       if (newProductCategory) {
         const options = ['<option value="">Selecione uma categoria</option>'];
         categories.forEach(cat => {
           options.push(`<option value="${cat.id}">${cat.name}</option>`);
         });
         newProductCategory.innerHTML = options.join('');
       }
       
       // Atualizar o select do modal de nova subcategoria
       if (newSubcategoryCategory) {
         const options = ['<option value="">Selecione uma categoria</option>'];
         categories.forEach(cat => {
           options.push(`<option value="${cat.id}">${cat.name}</option>`);
         });
         newSubcategoryCategory.innerHTML = options.join('');
       }
     }

    // Fun√ß√£o para atualizar subcategorias no modal de edi√ß√£o
    async function updateEditSubcategoryOptions() {
      const categoryId = editProductCategory?.value;
      const subcategorySelect = editProductSubcategory;
      
      if (!subcategorySelect) {
        console.error('‚ùå Select de subcategoria do modal n√£o encontrado');
        return;
      }
      
      if (!categoryId) {
        subcategorySelect.innerHTML = '<option value="">Selecione uma subcategoria</option>';
        return;
      }
      
      try {
        const snap = await getDocs(collection(db, 'loja', 'config', 'subcategorias'));
        const options = ['<option value="">Selecione uma subcategoria</option>'];
        snap.forEach(doc => {
          const data = doc.data();
          if (data.categoryId === categoryId) {
            options.push(`<option value="${doc.id}">${data.name}</option>`);
          }
        });
        subcategorySelect.innerHTML = options.join('');
      } catch (error) {
        console.error('‚ùå Erro ao buscar subcategorias do modal:', error);
      }
    }

    function showSuccess(message) {
      if (msgEl) {
        msgEl.textContent = message;
        msgEl.style.display = 'block';
        if (errEl) errEl.style.display = 'none';
        setTimeout(() => {
          msgEl.style.display = 'none';
        }, 3000);
      } else {
        console.error('‚ùå Elemento msg n√£o encontrado');
      }
    }

    function showError(message) {
      console.error('‚ùå Erro:', message);
      if (errEl) {
        errEl.textContent = message;
        errEl.style.display = 'block';
        if (msgEl) msgEl.style.display = 'none';
        setTimeout(() => {
          errEl.style.display = 'none';
        }, 5000);
      } else {
        console.error('‚ùå Elemento err n√£o encontrado');
      }
    }

    // Vari√°veis globais para edi√ß√£o
    let currentEditCategory = null;
    let currentEditSubcategory = null;
    
    // Fun√ß√µes globais para os bot√µes de a√ß√£o
    window.editCategory = async function(id) {
      try {
        // Buscar dados da categoria no Firestore
        const categoryDoc = await getDocs(collection(db, 'loja', 'config', 'categorias'));
        let categoryData = null;
        
        categoryDoc.forEach(doc => {
          if (doc.id === id) {
            categoryData = { id: doc.id, ...doc.data() };
          }
        });
        
        if (!categoryData) {
          showError('Categoria n√£o encontrada');
          return;
        }
        
        // Armazenar categoria atual para edi√ß√£o
        currentEditCategory = categoryData;
        
        // Preencher formul√°rio de edi√ß√£o
        editCategoryName.value = categoryData.name || '';
        editCategoryDescription.value = categoryData.description || '';
        
        // Mostrar modal
        editCategoryModal.style.display = 'flex';
        modalOverlay.style.display = 'block';
        
      } catch (error) {
        console.error('‚ùå Erro ao abrir modal de edi√ß√£o de categoria:', error);
        showError('Erro ao abrir modal de edi√ß√£o: ' + error.message);
      }
    };

    window.deleteCategory = async function(id) {
      if (confirm('Tem certeza que deseja excluir esta categoria?')) {
        try {
          await deleteDoc(doc(db, 'loja', 'config', 'categorias', id));
          showSuccess('Categoria exclu√≠da com sucesso!');
          await loadCategories();
          
          // Atualizar contadores ap√≥s excluir categoria
          if (allProducts && allProducts.length > 0) {
            updateProductCounts();
            renderCategoriesTable(allCategories);
            renderSubcategoriesTable(allSubcategories);
          }
        } catch (error) {
          console.error('‚ùå Erro ao excluir categoria:', error);
          showError('Erro ao excluir categoria: ' + error.message);
        }
      }
    };

    window.editSubcategory = async function(id) {
      try {
        // Buscar dados da subcategoria no Firestore
        const subcategoryDoc = await getDocs(collection(db, 'loja', 'config', 'subcategorias'));
        let subcategoryData = null;
        
        subcategoryDoc.forEach(doc => {
          if (doc.id === id) {
            subcategoryData = { id: doc.id, ...doc.data() };
          }
        });
        
        if (!subcategoryData) {
          showError('Subcategoria n√£o encontrada');
          return;
        }
        
        // Armazenar subcategoria atual para edi√ß√£o
        currentEditSubcategory = subcategoryData;
        
        // Preencher formul√°rio de edi√ß√£o
        editSubcategoryCategory.value = subcategoryData.categoryId || '';
        editSubcategoryName.value = subcategoryData.name || '';
        
        // Mostrar modal
        editSubcategoryModal.style.display = 'flex';
        modalOverlay.style.display = 'block';
        
      } catch (error) {
        console.error('‚ùå Erro ao abrir modal de edi√ß√£o de subcategoria:', error);
        showError('Erro ao abrir modal de edi√ß√£o: ' + error.message);
      }
    };

    window.deleteSubcategory = async function(id) {
      if (confirm('Tem certeza que deseja excluir esta subcategoria?')) {
        try {
          await deleteDoc(doc(db, 'loja', 'config', 'subcategorias', id));
          showSuccess('Subcategoria exclu√≠da com sucesso!');
          await loadSubcategories();
          
          // Atualizar contadores ap√≥s excluir subcategoria
          if (allProducts && allProducts.length > 0) {
            updateProductCounts();
            renderCategoriesTable(allCategories);
            renderSubcategoriesTable(allSubcategories);
          }
        } catch (error) {
          console.error('‚ùå Erro ao excluir subcategoria:', error);
          showError('Erro ao excluir subcategoria: ' + error.message);
        }
      }
    };

    // Vari√°vel global para armazenar o produto sendo editado
    let currentEditProduct = null;

    window.editProduct = async function(id) {
      try {
        // Buscar dados do produto no Firestore
        const productDoc = await getDocs(collection(db, 'loja', 'config', 'produtos'));
        let productData = null;
        
        productDoc.forEach(doc => {
          if (doc.id === id) {
            productData = { id: doc.id, ...doc.data() };
          }
        });
        
        if (!productData) {
          showError('Produto n√£o encontrado');
          return;
        }
        
        // Armazenar produto atual para edi√ß√£o
        currentEditProduct = productData;
        
                 // Preencher formul√°rio de edi√ß√£o
         editProductName.value = productData.name || '';
         editProductCategory.value = productData.categoryId || '';
         editProductSubcategory.value = productData.subcategoryId || '';
         editProductPrice.value = productData.price || '';
         editProductStock.value = productData.stock || '';
         editProductStatus.value = productData.status || 'active';
         editProductDescription.value = productData.description || '';
         
         // Preencher imagem atual se existir
         if (productData.imageUrl) {
           editProductCurrentImage.src = productData.imageUrl;
           editProductCurrentImage.style.display = 'block';
           editProductImagePlaceholder.style.display = 'none';
         } else {
           editProductCurrentImage.style.display = 'none';
           editProductImagePlaceholder.style.display = 'flex';
         }
        
        // Atualizar op√ß√µes de subcategoria baseado na categoria selecionada
        await updateEditSubcategoryOptions();
        
        // Mostrar modal
        editProductModal.style.display = 'flex';
        modalOverlay.style.display = 'block';
        
      } catch (error) {
        console.error('‚ùå Erro ao abrir modal de edi√ß√£o:', error);
        showError('Erro ao abrir modal de edi√ß√£o: ' + error.message);
      }
    };

    window.deleteProduct = async function(id) {
      if (confirm('Tem certeza que deseja excluir este produto? Esta a√ß√£o n√£o pode ser desfeita.')) {
        try {
          await deleteDoc(doc(db, 'loja', 'config', 'produtos', id));
          showSuccess('Produto exclu√≠do com sucesso!');
          await loadProducts(); // Recarregar lista de produtos
          
          // Atualizar contadores de categorias e subcategorias
          updateProductCounts();
          renderCategoriesTable(allCategories);
          renderSubcategoriesTable(allSubcategories);
        } catch (error) {
          console.error('‚ùå Erro ao excluir produto:', error);
          showError('Erro ao excluir produto: ' + error.message);
        }
      }
    };
    
    // ===== FUN√á√ïES DO MODAL DE EDI√á√ÉO =====
    
         // Fun√ß√£o para fechar o modal de produto
     function closeEditModal() {
       editProductModal.style.display = 'none';
       modalOverlay.style.display = 'none';
       currentEditProduct = null;
       
       // Limpar campo de imagem
       if (editProductImage) editProductImage.value = '';
       if (editProductCurrentImage) editProductCurrentImage.style.display = 'none';
       if (editProductImagePlaceholder) editProductImagePlaceholder.style.display = 'flex';
     }
    
    // Fun√ß√£o para fechar o modal de categoria
    function closeEditCategoryModal() {
      editCategoryModal.style.display = 'none';
      modalOverlay.style.display = 'none';
      currentEditCategory = null;
    }
    
    // Fun√ß√£o para fechar o modal de subcategoria
    function closeEditSubcategoryModal() {
      editSubcategoryModal.style.display = 'none';
      modalOverlay.style.display = 'none';
      currentEditSubcategory = null;
    }
    
    // Fun√ß√£o para salvar as altera√ß√µes do produto
    async function handleSaveEdit() {
      if (!currentEditProduct) {
        console.error('‚ùå Nenhum produto selecionado para edi√ß√£o');
        showError('Nenhum produto selecionado para edi√ß√£o');
        return;
      }
      
      const name = editProductName?.value?.trim();
      const categoryId = editProductCategory?.value;
      const subcategoryId = editProductSubcategory?.value;
      const price = parseFloat(editProductPrice?.value) || 0;
      const stock = parseInt(editProductStock?.value) || 0;
      const status = editProductStatus?.value;
      const description = editProductDescription?.value?.trim();
      
      if (!name || !categoryId) {
        console.error('‚ùå Nome e categoria s√£o obrigat√≥rios');
        showError('Nome e categoria s√£o obrigat√≥rios');
        return;
      }
      
      // Verificar se j√° existe um produto com o mesmo nome (excluindo o produto atual)
      const nameExists = await checkProductNameExists(name, currentEditProduct.id);
      if (nameExists) {
        showError('J√° existe um produto com este nome. Por favor, escolha um nome √∫nico.');
        return;
      }
      
      try {
         // Buscar nomes das categorias
         const categoryDoc = await getDocs(collection(db, 'loja', 'config', 'categorias'));
         let categoryName = '';
         categoryDoc.forEach(doc => {
           if (doc.id === categoryId) {
             categoryName = doc.data().name;
           }
         });
         
         const subcategoryDoc = await getDocs(collection(db, 'loja', 'config', 'subcategorias'));
         let subcategoryName = '';
         subcategoryDoc.forEach(doc => {
           if (doc.id === subcategoryId) {
             subcategoryName = doc.data().name;
           }
         });
         
         // Verificar se h√° nova imagem para upload
         let imageUrl = currentEditProduct.imageUrl || null;
         if (editProductImage.files && editProductImage.files[0]) {
           try {
             imageUrl = await uploadProductImage(editProductImage.files[0], name, currentEditProduct.id);
           } catch (error) {
             showError('Erro ao fazer upload da imagem: ' + error.message);
             return;
           }
         }
         
         const updatedProductData = {
           name,
           categoryId,
           categoryName,
           subcategoryId,
           subcategoryName,
           price,
           stock,
           status,
           description,
           imageUrl,
           updatedAt: serverTimestamp()
         };
        
        // Atualizar documento no Firestore
        const productDocRef = doc(db, 'loja', 'config', 'produtos', currentEditProduct.id);
        await updateDoc(productDocRef, updatedProductData);
        
        showSuccess('Produto atualizado com sucesso!');
        
        // Fechar modal e recarregar produtos
        closeEditModal();
        await loadProducts();
        
        // Atualizar contadores de categorias e subcategorias
        updateProductCounts();
        renderCategoriesTable(allCategories);
        renderSubcategoriesTable(allSubcategories);
        
      } catch (error) {
        console.error('‚ùå Erro ao atualizar produto:', error);
        showError('Erro ao atualizar produto: ' + error.message);
      }
    }
    
         // ===== FUN√á√ïES DE UPLOAD DE IMAGEM =====
     // 
     
     // ESTRAT√âGIA IMPLEMENTADA:
     // 1. VALIDA√á√ÉO DE NOMES √öNICOS: N√£o permite produtos com nomes duplicados
     // 2. NOMENCLATURA CONSISTENTE: Imagens salvas como "nome_produto_timestamp.extensao"
     // 3. BUSCA POR NOME: Fun√ß√µes para encontrar produtos por nome ou ID
     // 4. COMPATIBILIDADE: As 3 p√°ginas (lojaconfig, loja, inventario) podem buscar pelo mesmo produto
     // 5. ARMAZENAMENTO: Imagens salvas em gs://crmdaneon.firebasestorage.app/imagemLoja/
     //
     
     // Fun√ß√£o para lidar com mudan√ßa de imagem no modal de edi√ß√£o
     function handleEditProductImageChange(event) {
       const file = event.target.files[0];
       if (file) {
         displayImagePreview(file, editProductCurrentImage, editProductImagePlaceholder);
       }
     }
     
     // Fun√ß√£o para lidar com mudan√ßa de imagem no modal de novo produto
     function handleNewProductImageChange(event) {
       const file = event.target.files[0];
       if (file) {
         displayImagePreview(file, null, newProductImagePlaceholder);
       }
     }
     
     // Fun√ß√£o para exibir preview da imagem
     function displayImagePreview(file, currentImageElement, placeholderElement) {
       if (!file) return;
       
       const reader = new FileReader();
       reader.onload = function(e) {
         if (currentImageElement) {
           currentImageElement.src = e.target.result;
           currentImageElement.style.display = 'block';
         }
         if (placeholderElement) {
           placeholderElement.style.display = 'none';
         }
       };
       reader.readAsDataURL(file);
     }
     
     // Fun√ß√£o para fazer upload da imagem para o Firebase Storage
     async function uploadProductImage(file, productName, productId) {
       if (!file) return null;
       
       try {
         // Criar nome √∫nico para a imagem baseado no nome do produto
         const sanitizedName = productName.replace(/[^a-zA-Z0-9]/g, '_').toLowerCase();
         const timestamp = Date.now();
         const fileExtension = file.name.split('.').pop();
         
         // Formato: imagemLoja/nome_produto_timestamp.extensao
         const storageRef = ref(storage, `imagemLoja/${sanitizedName}_${timestamp}.${fileExtension}`);
         
         // Fazer upload do arquivo
         const snapshot = await uploadBytes(storageRef, file);
         
         // Obter URL de download
         const downloadURL = await getDownloadURL(snapshot.ref);
         
         return downloadURL;
       } catch (error) {
         console.error('‚ùå Erro ao fazer upload da imagem:', error);
         throw error;
       }
     }
     
     // Fun√ß√£o para verificar se j√° existe um produto com o mesmo nome
     async function checkProductNameExists(productName, excludeProductId = null) {
       try {
         const productsCol = collection(db, 'loja', 'config', 'produtos');
         const q = query(productsCol, where('name', '==', productName));
         const snap = await getDocs(q);
         
         // Verificar se existe algum produto com o mesmo nome (excluindo o produto atual se estiver editando)
         let exists = false;
         snap.forEach(doc => {
           if (doc.id !== excludeProductId) {
             exists = true;
           }
         });
         
         return exists;
       } catch (error) {
         console.error('‚ùå Erro ao verificar nome do produto:', error);
         return false;
       }
     }
     
     // Fun√ß√£o para buscar produto por nome (√∫til para outras p√°ginas)
     async function findProductByName(productName) {
       try {
         const productsCol = collection(db, 'loja', 'config', 'produtos');
         const q = query(productsCol, where('name', '==', productName));
         const snap = await getDocs(q);
         
         if (!snap.empty) {
           const doc = snap.docs[0];
           return { id: doc.id, ...doc.data() };
         }
         
         return null;
       } catch (error) {
         console.error('‚ùå Erro ao buscar produto por nome:', error);
         return null;
       }
     }
     
     // Fun√ß√£o para buscar produto por ID (√∫til para outras p√°ginas)
     async function findProductById(productId) {
       try {
         const productDoc = doc(db, 'loja', 'config', 'produtos', productId);
         const productSnap = await getDocs(collection(db, 'loja', 'config', 'produtos'));
         
         let productData = null;
         productSnap.forEach(doc => {
           if (doc.id === productId) {
             productData = { id: doc.id, ...doc.data() };
           }
         });
         
         return productData;
       } catch (error) {
         console.error('‚ùå Erro ao buscar produto por ID:', error);
         return null;
       }
     }
     
     // Fun√ß√£o para popular os selects do modal com categorias
     async function populateEditCategorySelects() {
      try {
        const categoriesSnap = await getDocs(collection(db, 'loja', 'config', 'categorias'));
        const options = ['<option value="">Selecione uma categoria</option>'];
        
        categoriesSnap.forEach(doc => {
          const data = doc.data();
          options.push(`<option value="${doc.id}">${data.name}</option>`);
        });
        
        if (editProductCategory) {
          editProductCategory.innerHTML = options.join('');
        }
        
        // Popular tamb√©m os selects dos outros modais
        if (editSubcategoryCategory) {
          editSubcategoryCategory.innerHTML = options.join('');
        }
        
        // Popular filtros
        if (productCategoryFilter) {
          productCategoryFilter.innerHTML = '<option value="">Todas as categorias</option>' + options.slice(1).join('');
        }
        if (subcategoryCategoryFilter) {
          subcategoryCategoryFilter.innerHTML = '<option value="">Todas as categorias</option>' + options.slice(1).join('');
        }
        
      } catch (error) {
        console.error('‚ùå Erro ao popular categorias do modal:', error);
      }
    }
    
         // ===== FUN√á√ïES DOS MODAIS DE NOVA CATEGORIA E SUBCATEGORIA =====
     
     // Fun√ß√£o para abrir o modal de nova categoria
     function openNewCategoryModal() {
       // Limpar formul√°rio
       clearNewCategoryForm();
       
       // Mostrar modal
       newCategoryModal.style.display = 'flex';
       modalOverlay.style.display = 'block';
     }
     
     // Fun√ß√£o para fechar o modal de nova categoria
     function closeNewCategoryModal() {
       newCategoryModal.style.display = 'none';
       modalOverlay.style.display = 'none';
     }
     
     // Fun√ß√£o para limpar o formul√°rio de nova categoria
     function clearNewCategoryForm() {
       if (newCategoryName) newCategoryName.value = '';
       if (newCategoryDescription) newCategoryDescription.value = '';
     }
     
     // Fun√ß√£o para abrir o modal de nova subcategoria
     function openNewSubcategoryModal() {
       // Limpar formul√°rio
       clearNewSubcategoryForm();
       
       // Mostrar modal
       newSubcategoryModal.style.display = 'flex';
       modalOverlay.style.display = 'block';
     }
     
     // Fun√ß√£o para fechar o modal de nova subcategoria
     function closeNewSubcategoryModal() {
       newSubcategoryModal.style.display = 'none';
       modalOverlay.style.display = 'none';
     }
     
     // Fun√ß√£o para limpar o formul√°rio de nova subcategoria
     function clearNewSubcategoryForm() {
       if (newSubcategoryCategory) newSubcategoryCategory.value = '';
       if (newSubcategoryName) newSubcategoryName.value = '';
     }
     
     // Fun√ß√£o para salvar nova categoria
     async function handleSaveNewCategory() {
       const name = newCategoryName?.value?.trim();
       const description = newCategoryDescription?.value?.trim();
       
       if (!name) {
         console.error('‚ùå Nome da categoria √© obrigat√≥rio');
         showError('Nome da categoria √© obrigat√≥rio');
         return;
       }
       
       try {
         const categoryData = {
           name,
           description,
           createdAt: serverTimestamp(),
           updatedAt: serverTimestamp()
         };
         
         const categoriesCol = collection(db, 'loja', 'config', 'categorias');
         
         const docRef = await addDoc(categoriesCol, categoryData);
         
         showSuccess('Categoria criada com sucesso!');
         closeNewCategoryModal();
         await loadCategories();
         
         // Atualizar contadores ap√≥s criar nova categoria
         if (allProducts && allProducts.length > 0) {
           updateProductCounts();
           renderCategoriesTable(allCategories);
           renderSubcategoriesTable(allSubcategories);
         }
         
       } catch (error) {
         console.error('‚ùå Erro ao criar categoria:', error);
         showError('Erro ao criar categoria: ' + error.message);
       }
     }
     
     // Fun√ß√£o para salvar nova subcategoria
     async function handleSaveNewSubcategory() {
       const categoryId = newSubcategoryCategory?.value;
       const name = newSubcategoryName?.value?.trim();
       
       if (!categoryId || !name) {
         console.error('‚ùå Categoria e nome s√£o obrigat√≥rios');
         showError('Categoria e nome s√£o obrigat√≥rios');
         return;
       }
       
       try {
         // Buscar nome da categoria
         const categoryDoc = await getDocs(collection(db, 'loja', 'config', 'categorias'));
         let categoryName = '';
         categoryDoc.forEach(doc => {
           if (doc.id === categoryId) {
             categoryName = doc.data().name;
           }
         });
         
         const subcategoryData = {
           categoryId,
           categoryName,
           name,
           createdAt: serverTimestamp(),
           updatedAt: serverTimestamp()
         };
         
         const subcategoriesCol = collection(db, 'loja', 'config', 'subcategorias');
         
         const docRef = await addDoc(subcategoriesCol, subcategoryData);
         
         showSuccess('Subcategoria criada com sucesso!');
         closeNewSubcategoryModal();
         await loadSubcategories();
         
         // Atualizar contadores ap√≥s criar nova subcategoria
         if (allProducts && allProducts.length > 0) {
           updateProductCounts();
           renderCategoriesTable(allCategories);
           renderSubcategoriesTable(allSubcategories);
         }
         
       } catch (error) {
         console.error('‚ùå Erro ao criar subcategoria:', error);
         showError('Erro ao criar subcategoria: ' + error.message);
       }
     }
     
     // ===== FUN√á√ïES DO MODAL DE NOVO PRODUTO =====
     
     // Fun√ß√£o para abrir o modal de novo produto
     function openNewProductModal() {
       // Limpar formul√°rio
       clearNewProductForm();
       
       // Mostrar modal
       newProductModal.style.display = 'flex';
       modalOverlay.style.display = 'block';
     }
    
    // Fun√ß√£o para fechar o modal de novo produto
    function closeNewProductModal() {
      newProductModal.style.display = 'none';
      modalOverlay.style.display = 'none';
    }
    
         // Fun√ß√£o para limpar o formul√°rio de novo produto
     function clearNewProductForm() {
       if (newProductName) newProductName.value = '';
       if (newProductCategory) newProductCategory.value = '';
       if (newProductSubcategory) newProductSubcategory.value = '';
       if (newProductPrice) newProductPrice.value = '';
       if (newProductStock) newProductStock.value = '';
       if (newProductStatus) newProductStatus.value = 'active';
       if (newProductConsumable) newProductConsumable.value = 'false';
       if (newProductDescription) newProductDescription.value = '';
       
       // Limpar campo de imagem
       if (newProductImage) newProductImage.value = '';
       if (newProductImagePlaceholder) newProductImagePlaceholder.style.display = 'flex';
     }
    
    // Fun√ß√£o para atualizar op√ß√µes de subcategoria no modal de novo produto
    async function updateNewProductSubcategoryOptions() {
      const categoryId = newProductCategory?.value;
      const subcategorySelect = newProductSubcategory;
      
      if (!subcategorySelect) {
        console.error('‚ùå Select de subcategoria do modal n√£o encontrado');
        return;
      }
      
      if (!categoryId) {
        subcategorySelect.innerHTML = '<option value="">Selecione uma subcategoria</option>';
        return;
      }
      
      try {
        const snap = await getDocs(collection(db, 'loja', 'config', 'subcategorias'));
        const options = ['<option value="">Selecione uma subcategoria</option>'];
        snap.forEach(doc => {
          const data = doc.data();
          if (data.categoryId === categoryId) {
            options.push(`<option value="${doc.id}">${data.name}</option>`);
          }
        });
        subcategorySelect.innerHTML = options.join('');
      } catch (error) {
        console.error('‚ùå Erro ao buscar subcategorias do modal:', error);
      }
    }
    
    // Fun√ß√£o para salvar novo produto
    async function handleSaveNewProduct() {
      const name = newProductName?.value?.trim();
      const categoryId = newProductCategory?.value;
      const subcategoryId = newProductSubcategory?.value;
      const price = parseFloat(newProductPrice?.value) || 0;
      const stock = parseInt(newProductStock?.value) || 0;
      const status = newProductStatus?.value;
      const consumable = newProductConsumable?.value === 'true';
      const description = newProductDescription?.value?.trim();
      
      if (!name || !categoryId) {
        console.error('‚ùå Nome e categoria s√£o obrigat√≥rios');
        showError('Nome e categoria s√£o obrigat√≥rios');
        return;
      }
      
      // Verificar se j√° existe um produto com o mesmo nome
      const nameExists = await checkProductNameExists(name);
      if (nameExists) {
        showError('J√° existe um produto com este nome. Por favor, escolha um nome √∫nico.');
        return;
      }
      
      try {
         // Buscar nomes das categorias
         const categoryDoc = await getDocs(collection(db, 'loja', 'config', 'categorias'));
         let categoryName = '';
         categoryDoc.forEach(doc => {
           if (doc.id === categoryId) {
             categoryName = doc.data().name;
           }
         });
         
         const subcategoryDoc = await getDocs(collection(db, 'loja', 'config', 'subcategorias'));
         let subcategoryName = '';
         subcategoryDoc.forEach(doc => {
           if (doc.id === subcategoryId) {
             subcategoryName = doc.data().name;
           }
         });
         
         // Criar produto primeiro para obter o ID
         const productsCol = collection(db, 'loja', 'config', 'produtos');
         const productDocRef = doc(productsCol, name); // Usa o nome do produto como ID
         await setDoc(productDocRef, {
           name,
           categoryId,
           categoryName,
           subcategoryId,
           subcategoryName,
           price,
           stock,
           status,
           consumable,
           description,
           createdAt: serverTimestamp(),
           updatedAt: serverTimestamp()
         });
         // Verificar se h√° imagem para upload
         let imageUrl = null;
         if (newProductImage.files && newProductImage.files[0]) {
           try {
             imageUrl = await uploadProductImage(newProductImage.files[0], name, name);
             // Atualizar produto com a URL da imagem
             await updateDoc(productDocRef, { imageUrl });
           } catch (error) {
             console.error('‚ùå Erro ao fazer upload da imagem:', error);
             // Continuar mesmo se o upload falhar
           }
         }
         
                  showSuccess('Produto criado com sucesso!');
         closeNewProductModal();
         await loadProducts();
         
         // Atualizar contadores de categorias e subcategorias
         updateProductCounts();
         renderCategoriesTable(allCategories);
         renderSubcategoriesTable(allSubcategories);
        
        showSuccess('Produto criado com sucesso!');
        closeNewProductModal();
        await loadProducts();
        
        // Atualizar contadores de categorias e subcategorias
        updateProductCounts();
        renderCategoriesTable(allCategories);
        renderSubcategoriesTable(allSubcategories);
      } catch (error) {
        console.error('‚ùå Erro ao salvar produto:', error);
        showError('Erro ao salvar produto: ' + error.message);
      }
    }
    
    // Sistema de pagina√ß√£o e filtros para produtos
    let currentPage = 1;
    let itemsPerPageValue = 10;
    let filteredProducts = [];
    let allProducts = [];
    
    // Vari√°veis para filtros de categoria e subcategoria
    let allCategories = [];
    let allSubcategories = [];
    
    // Fun√ß√£o para filtrar produtos
    function filterProducts() {
      const searchTerm = productSearch?.value?.toLowerCase() || '';
      const categoryFilter = productCategoryFilter?.value || '';
      const subcategoryFilter = productSubcategoryFilter?.value || '';
      const statusFilter = productStatusFilter?.value || '';
      
      filteredProducts = allProducts.filter(product => {
        const matchesSearch = !searchTerm || 
          product.name.toLowerCase().includes(searchTerm) ||
          product.description?.toLowerCase().includes(searchTerm);
        
        const matchesCategory = !categoryFilter || product.categoryId === categoryFilter;
        const matchesSubcategory = !subcategoryFilter || product.subcategoryId === subcategoryFilter;
        const matchesStatus = !statusFilter || product.status === statusFilter;
        
        return matchesSearch && matchesCategory && matchesSubcategory && matchesStatus;
      });
      currentPage = 1;
      renderProductsTablePaginated();
    }
    
    // Fun√ß√£o para renderizar produtos com pagina√ß√£o
    function renderProductsTablePaginated() {
      const startIndex = (currentPage - 1) * itemsPerPageValue;
      const endIndex = startIndex + itemsPerPageValue;
      const productsToShow = filteredProducts.slice(startIndex, endIndex);
      
      renderProductsTable(productsToShow);
      updatePagination();
    }
    
    // Fun√ß√£o para atualizar controles de pagina√ß√£o
    function updatePagination() {
      const totalPages = Math.ceil(filteredProducts.length / itemsPerPageValue);
      
      if (pageInfo) {
        pageInfo.textContent = `P√°gina ${currentPage} de ${totalPages}`;
      }
      
      if (prevPage) {
        prevPage.disabled = currentPage <= 1;
      }
      
      if (nextPage) {
        nextPage.disabled = currentPage >= totalPages;
      }
    }
    
    // Fun√ß√£o para ir para pr√≥xima p√°gina
    function nextPageProducts() {
      const totalPages = Math.ceil(filteredProducts.length / itemsPerPageValue);
      if (currentPage < totalPages) {
        currentPage++;
        renderProductsTablePaginated();
      }
    }
    
    // Fun√ß√£o para ir para p√°gina anterior
    function prevPageProducts() {
      if (currentPage > 1) {
        currentPage--;
        renderProductsTablePaginated();
      }
    }
    
    // Fun√ß√£o para alterar itens por p√°gina
    function changeItemsPerPage() {
      itemsPerPageValue = parseInt(itemsPerPage?.value || 10);
      currentPage = 1;
      renderProductsTablePaginated();
    }
    
    // Fun√ß√£o para filtrar categorias
    function filterCategories() {
      const searchTerm = categorySearch?.value?.toLowerCase() || '';
      
      const filteredCategories = allCategories.filter(category => 
        category.name.toLowerCase().includes(searchTerm) ||
        category.description?.toLowerCase().includes(searchTerm)
      );
      
      renderCategoriesTable(filteredCategories);
    }
    
    // Fun√ß√£o para filtrar subcategorias
    function filterSubcategories() {
      const searchTerm = subcategorySearch?.value?.toLowerCase() || '';
      const categoryFilter = subcategoryCategoryFilter?.value || '';
      
      let filteredSubcategories = allSubcategories;
      
      if (searchTerm) {
        filteredSubcategories = filteredSubcategories.filter(subcategory =>
          subcategory.name.toLowerCase().includes(searchTerm) ||
          subcategory.categoryName?.toLowerCase().includes(searchTerm)
        );
      }
      
      if (categoryFilter) {
        filteredSubcategories = filteredSubcategories.filter(subcategory =>
          subcategory.categoryId === categoryFilter
        );
      }
      
      renderSubcategoriesTable(filteredSubcategories);
    }
    
    // Fun√ß√£o para salvar edi√ß√£o de categoria
    async function handleSaveEditCategory() {
      if (!currentEditCategory) {
        console.error('‚ùå Nenhuma categoria selecionada para edi√ß√£o');
        showError('Nenhuma categoria selecionada para edi√ß√£o');
        return;
      }
      
      const name = editCategoryName?.value?.trim();
      const description = editCategoryDescription?.value?.trim();
      
      if (!name) {
        console.error('‚ùå Nome da categoria √© obrigat√≥rio');
        showError('Nome da categoria √© obrigat√≥rio');
        return;
      }
      
      try {
        const updatedCategoryData = {
          name,
          description,
          updatedAt: serverTimestamp()
        };
        
        // Atualizar documento no Firestore
        const categoryDocRef = doc(db, 'loja', 'config', 'categorias', currentEditCategory.id);
        await updateDoc(categoryDocRef, updatedCategoryData);
        showSuccess('Categoria atualizada com sucesso!');
        
        // Fechar modal e recarregar categorias
        closeEditCategoryModal();
        await loadCategories();
        
        // Atualizar contadores ap√≥s editar categoria
        if (allProducts && allProducts.length > 0) {
          updateProductCounts();
          renderCategoriesTable(allCategories);
          renderSubcategoriesTable(allSubcategories);
        }
        
      } catch (error) {
        console.error('‚ùå Erro ao atualizar categoria:', error);
        showError('Erro ao atualizar categoria: ' + error.message);
      }
    }
    
    // Fun√ß√£o para salvar edi√ß√£o de subcategoria
    async function handleSaveEditSubcategory() {
      if (!currentEditSubcategory) {
        console.error('‚ùå Nenhuma subcategoria selecionada para edi√ß√£o');
        showError('Nenhuma subcategoria selecionada para edi√ß√£o');
        return;
      }
      
      const categoryId = editSubcategoryCategory?.value;
      const name = editSubcategoryName?.value?.trim();
      
      if (!categoryId || !name) {
        console.error('‚ùå Categoria e nome s√£o obrigat√≥rios');
        showError('Categoria e nome s√£o obrigat√≥rios');
        return;
      }
      
      try {
        // Buscar nome da categoria
        const categoryDoc = await getDocs(collection(db, 'loja', 'config', 'categorias'));
        let categoryName = '';
        categoryDoc.forEach(doc => {
          if (doc.id === categoryId) {
            categoryName = doc.data().name;
          }
        });
        
        const updatedSubcategoryData = {
          categoryId,
          categoryName,
          name,
          updatedAt: serverTimestamp()
        };
        
        // Atualizar documento no Firestore
        const subcategoryDocRef = doc(db, 'loja', 'config', 'subcategorias', currentEditSubcategory.id);
        await updateDoc(subcategoryDocRef, updatedSubcategoryData);
        
        showSuccess('Subcategoria atualizada com sucesso!');
        
        // Fechar modal e recarregar subcategorias
        closeEditSubcategoryModal();
        await loadSubcategories();
        
        // Atualizar contadores ap√≥s editar subcategoria
        if (allProducts && allProducts.length > 0) {
          updateProductCounts();
          renderCategoriesTable(allCategories);
          renderSubcategoriesTable(allSubcategories);
        }
        
      } catch (error) {
        console.error('‚ùå Erro ao atualizar subcategoria:', error);
        showError('Erro ao atualizar subcategoria: ' + error.message);
      }
    }
    
  </script>
</body>
</html>
