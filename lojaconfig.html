<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Configura√ß√£o da Loja ‚Ä¢ Banco da Neon</title>
  <link rel="icon" href="logotipo.svg" type="image/svg+xml" />
  <style>
    :root { 
      --primary:#5a039a; 
      --secondary:#b6f902; 
      --secondary-700:#8bb601; 
      --bg:#f7f7fb; 
      --card:#fff; 
      --text:#1a1a1a; 
      --muted:#5d5d6a; 
      --border:#e8e8ef; 
      --success:#12805a;
      --warning:#f59e0b;
      --danger:#dc2626;
    }
    *{ box-sizing:border-box; }
    html, body{ 
      margin:0; 
      padding: 0;
      color:var(--text); 
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto; 
      background: var(--bg); 
      min-height: 100vh;
    }
    .header{ background:var(--primary); color:#fff; padding:12px 20px; display:flex; align-items:center; justify-content:space-between; box-shadow:0 8px 24px rgba(90,3,154,0.25); }
    #juntinhos { display: flex; align-items: center; gap: 30px; }
    .brand{ display:flex; align-items:center; gap:12px; }
    .logo-mask{ width:48px; height:48px; display:block; background-color:#b6f902; -webkit-mask:url('logotipo.svg') center/contain no-repeat; mask:url('logotipo.svg') center/contain no-repeat; }
    .brand a { display: inline-block; line-height: 0; }
    .header-actions { display: flex; align-items: center; gap: 20px; }
    .menu-btn { width: 30px; height: 30px; padding: 0; background: transparent; border: 0; transition: background-color 0.2s ease; display: flex; align-items: center; justify-content: center; }
    .menu-btn:hover { background: rgba(255,255,255,0.1); }
    .menu-icon { width: 20px; height: 20px; display: block; filter: brightness(0) invert(1); }
    
    /* Menu lateral */
    .sidebar { position: fixed; top: 0; left: -300px; width: 300px; height: 100vh; background: var(--card); border-right: 1px solid var(--border); box-shadow: 4px 0 20px rgba(0,0,0,0.1); transition: left 0.3s ease; z-index: 1000; }
    .sidebar.open { left: 0; }
    .sidebar-header { display: flex; align-items: center; justify-content: space-between; padding: 20px; border-bottom: 1px solid var(--border); }
    .sidebar-header h3 { margin: 0; color: var(--primary); }
    .btn-close { background: none; border: none; font-size: 24px; cursor: pointer; color: var(--muted); }
    .sidebar-nav { padding: 20px 0; }
    .nav-item { display: flex; align-items: center; gap: 12px; padding: 16px 20px; color: var(--text); text-decoration: none; transition: background-color 0.2s; }
    .nav-item:hover { background-color: var(--bg); }
    .nav-item.active { background-color: var(--primary); color: #fff; }
    .nav-icon { font-size: 20px; }
    .sidebar-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); opacity: 0; visibility: hidden; transition: all 0.3s ease; z-index: 999; }
    .sidebar-overlay.open { opacity: 1; visibility: visible; }
    
    .wrap{ max-width:1400px; margin:0 auto; padding:20px; }
    .card{ background:var(--card); border:1px solid var(--border); border-radius:20px; padding:18px; box-shadow:0 10px 30px rgba(16,20,40,0.08); margin-bottom: 20px; }
    h1{ margin:0 0 8px 0; font-size:24px; font-weight:800; }
    p.helper{ margin:0 0 16px 0; color:var(--muted); }
    .btn{ background:var(--primary); color:#fff; border:none; border-radius:9999px; padding:10px 16px; cursor:pointer; font-size: 14px; }
    .btn.secondary{ background:var(--muted); }
    .btn.success{ background:var(--success); }
    .btn.warning{ background:var(--warning); }
    .btn.danger{ background:var(--danger); }
    .btn.small{ padding: 6px 12px; font-size: 12px; }
    .error{ color:var(--danger); min-height:18px; margin-top:6px; }
    .ok{ color:var(--success); min-height:18px; margin-top:6px; }
    
    /* Modal de Edi√ß√£o */
    .modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: 2000;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      z-index: 1999;
    }
    
    .modal-content {
      background: var(--card);
      border-radius: 16px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      width: 90%;
      max-width: 600px;
      max-height: 90vh;
      overflow-y: auto;
    }
    
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 20px;
      border-bottom: 1px solid var(--border);
    }
    
    .modal-header h3 {
      margin: 0;
      color: var(--primary);
    }
    
    .modal-body {
      padding: 20px;
    }
    
    .modal-footer {
      display: flex;
      justify-content: flex-end;
      gap: 12px;
      padding: 20px;
      border-top: 1px solid var(--border);
    }
    
    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
    }
    
    /* Bot√µes de a√ß√£o */
    .action-buttons {
      display: flex;
      gap: 8px;
      justify-content: center;
    }
    
    .btn-icon {
      width: 32px;
      height: 32px;
      padding: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      border-radius: 6px;
    }
    
    .btn-icon.warning {
      background: var(--warning);
      color: white;
    }
    
    .btn-icon.danger {
      background: var(--danger);
      color: white;
    }
    
    .btn-icon:hover {
      opacity: 0.8;
      transform: scale(1.05);
    }
    
    /* Controles de tabela */
    .table-controls {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
      gap: 16px;
      flex-wrap: wrap;
    }
    
    .search-box {
      flex: 1;
      min-width: 200px;
    }
    
    .search-input {
      width: 100%;
      padding: 8px 12px;
      border: 1px solid var(--border);
      border-radius: 6px;
      font-size: 14px;
    }
    
    .filter-box {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }
    
    .filter-select {
      padding: 8px 12px;
      border: 1px solid var(--border);
      border-radius: 6px;
      font-size: 14px;
      min-width: 120px;
    }
    
    .pagination-controls {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .pagination-select {
      padding: 6px 8px;
      border: 1px solid var(--border);
      border-radius: 4px;
      font-size: 14px;
    }
    
    /* Pagina√ß√£o */
    .pagination {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 16px;
      margin-top: 20px;
      padding: 16px 0;
    }
    
    .page-info {
      font-size: 14px;
      color: var(--muted);
      min-width: 120px;
      text-align: center;
    }
    
    /* Layout da configura√ß√£o */
    .config-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
    }
    .config-section {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 20px;
    }
    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
      padding-bottom: 12px;
      border-bottom: 1px solid var(--border);
    }
    .section-title {
      font-size: 18px;
      font-weight: 700;
      color: var(--primary);
    }
    
    /* Formul√°rios */
    .form-group {
      margin-bottom: 16px;
    }
    .form-group label {
      display: block;
      font-size: 14px;
      font-weight: 600;
      color: var(--text);
      margin-bottom: 6px;
    }
    .form-group input,
    .form-group select,
    .form-group textarea {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid var(--border);
      border-radius: 8px;
      font-size: 14px;
      background: var(--card);
      color: var(--text);
    }
    .form-group input:focus,
    .form-group select:focus,
    .form-group textarea:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(90,3,154,0.1);
    }
    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }
    
    /* Tabelas */
    .table-container {
      overflow-x: auto;
      margin-top: 16px;
    }
    .data-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 14px;
    }
    .data-table th,
    .data-table td {
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid var(--border);
    }
    .data-table th {
      background: var(--bg);
      font-weight: 600;
      color: var(--primary);
    }
    .data-table tr:hover {
      background: var(--bg);
    }
    
    /* Status badges */
    .status-badge {
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
    }
    .status-active { background: rgba(18,128,90,0.1); color: var(--success); }
    .status-inactive { background: rgba(220,38,38,0.1); color: var(--danger); }
    .status-low { background: rgba(245,158,11,0.1); color: var(--warning); }
    
    /* Bot√µes de a√ß√£o */
    .action-buttons {
      display: flex;
      gap: 8px;
    }
    .btn-icon {
      width: 32px;
      height: 32px;
      padding: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
    }
    
    /* Responsividade */
    @media (max-width: 768px) {
      .config-grid {
        grid-template-columns: 1fr;
      }
      .form-row {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <div class="header">
    <div id="juntinhos">
      <div class="brand">
        <a href="dashboard.html" title="In√≠cio"><span class="logo-mask" aria-label="Neon"></span></a>
      </div>
      <button id="btnMenu" class="menu-btn" title="Menu">
        <img src="menu.svg" alt="Menu" class="menu-icon" />
      </button>
    </div>
    <div class="header-actions">
      <a href="dashboard.html" class="btn" style="background:rgba(255,255,255,0.12)">Voltar</a>
    </div>
  </div>

  <!-- Menu lateral -->
  <div id="sidebar" class="sidebar">
    <div class="sidebar-header">
      <h3>Menu</h3>
      <button id="btnCloseSidebar" class="btn-close">&times;</button>
    </div>
    <nav class="sidebar-nav">
      <a href="dashboard.html" class="nav-item">
        <span class="nav-icon">üè†</span>
        Dashboard
      </a>
      <a href="extrato.html" class="nav-item">
        <span class="nav-icon">üìä</span>
        Extrato
      </a>
      <a href="pix.html" class="nav-item">
        <span class="nav-icon">üí∏</span>
        PIX
      </a>
      <a href="loja.html" class="nav-item">
        <span class="nav-icon">üõçÔ∏è</span>
        Loja
      </a>
      <a href="inventario.html" class="nav-item">
        <span class="nav-icon">üéí</span>
        Meu Invent√°rio
      </a>
      <a href="lojaconfig.html" class="nav-item active">
        <span class="nav-icon">‚öôÔ∏è</span>
        Config Loja
      </a>
      <a href="ocorrencias.html" class="nav-item">
        <span class="nav-icon">‚ö†Ô∏è</span>
        Ocorr√™ncias
      </a>
      <a href="adicionarAluno.html" class="nav-item">
        <span class="nav-icon">üë§</span>
        Adicionar Aluno
      </a>
      <a href="dev.html" class="nav-item">
        <span class="nav-icon">üîß</span>
        Dev
      </a>
    </nav>
  </div>

  <!-- Overlay para fechar o menu -->
  <div id="sidebarOverlay" class="sidebar-overlay"></div>

  <div class="wrap">
    <div id="unauth" class="card" style="display:none; text-align:center;">
      <h1>Acesso n√£o autorizado</h1>
      <p class="helper">Apenas administradores podem acessar a configura√ß√£o da loja.</p>
      <a class="btn" href="index.html">Ir para login</a>
    </div>

    <div id="content" style="display:none;">
      <div class="card">
        <h1>Configura√ß√£o da Loja</h1>
        <p class="helper">Gerencie categorias, produtos e estoque da loja digital.</p>
      </div>

      <div class="config-grid">
        <!-- Se√ß√£o de Categorias -->
        <div class="config-section">
          <div class="section-header">
            <h3 class="section-title">Categorias</h3>
            <button id="btnAddCategory" class="btn success btn-small">+ Nova Categoria</button>
          </div>
          
          <div class="form-group">
            <label for="categoryName">Nome da Categoria</label>
            <input type="text" id="categoryName" placeholder="Ex.: Vestu√°rio">
          </div>
          
          <div class="form-group">
            <label for="categoryDescription">Descri√ß√£o</label>
            <textarea id="categoryDescription" rows="2" placeholder="Descri√ß√£o da categoria"></textarea>
          </div>
          
          <div class="form-group">
            <button id="btnSaveCategory" class="btn success">Salvar Categoria</button>
          </div>
          
          <div class="table-container">
            <div class="table-controls">
              <div class="search-box">
                <input type="text" id="categorySearch" placeholder="üîç Buscar categoria..." class="search-input">
              </div>
            </div>
            <table class="data-table" id="categoriesTable">
              <thead>
                <tr>
                  <th>Nome</th>
                  <th>Descri√ß√£o</th>
                  <th>Produtos</th>
                  <th>A√ß√µes</th>
                </tr>
              </thead>
              <tbody id="categoriesTableBody">
                <!-- Categorias ser√£o carregadas aqui -->
              </tbody>
            </table>
          </div>
        </div>

        <!-- Se√ß√£o de Subcategorias -->
        <div class="config-section">
          <div class="section-header">
            <h3 class="section-title">Subcategorias</h3>
            <button id="btnAddSubcategory" class="btn success btn-small">+ Nova Subcategoria</button>
          </div>
          
          <div class="form-group">
            <label for="subcategoryCategory">Categoria Pai</label>
            <select id="subcategoryCategory">
              <option value="">Selecione uma categoria</option>
            </select>
          </div>
          
          <div class="form-group">
            <label for="subcategoryName">Nome da Subcategoria</label>
            <input type="text" id="subcategoryName" placeholder="Ex.: Camisetas">
          </div>
          
          <div class="form-group">
            <button id="btnSaveSubcategory" class="btn success">Salvar Subcategoria</button>
          </div>
          
          <div class="table-container">
            <div class="table-controls">
              <div class="search-box">
                <input type="text" id="subcategorySearch" placeholder="üîç Buscar subcategoria..." class="search-input">
              </div>
              <div class="filter-box">
                <select id="subcategoryCategoryFilter" class="filter-select">
                  <option value="">Todas as categorias</option>
                </select>
              </div>
            </div>
            <table class="data-table" id="subcategoriesTable">
              <thead>
                <tr>
                  <th>Categoria</th>
                  <th>Subcategoria</th>
                  <th>Produtos</th>
                  <th>A√ß√µes</th>
                </tr>
              </thead>
              <tbody id="subcategoriesTableBody">
                <!-- Subcategorias ser√£o carregadas aqui -->
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Se√ß√£o de Produtos -->
      <div class="card">
        <div class="section-header">
          <h3 class="section-title">Produtos</h3>
          <button id="btnAddProduct" class="btn success">+ Novo Produto</button>
        </div>
        
        <div class="form-group">
          <div class="form-row">
            <div>
              <label for="productName">Nome do Produto</label>
              <input type="text" id="productName" placeholder="Ex.: Camiseta Neon">
            </div>
            <div>
              <label for="productCategory">Categoria</label>
              <select id="productCategory">
                <option value="">Selecione uma categoria</option>
              </select>
            </div>
          </div>
        </div>
        
        <div class="form-group">
          <div class="form-row">
            <div>
              <label for="productSubcategory">Subcategoria</label>
              <select id="productSubcategory">
                <option value="">Selecione uma subcategoria</option>
              </select>
            </div>
            <div>
              <label for="productPrice">Pre√ßo (N$)</label>
              <input type="number" id="productPrice" min="0" step="0.01" placeholder="0.00">
            </div>
          </div>
        </div>
        
        <div class="form-group">
          <div class="form-row">
            <div>
              <label for="productStock">Estoque</label>
              <input type="number" id="productStock" min="0" placeholder="0">
            </div>
            <div>
              <label for="productStatus">Status</label>
              <select id="productStatus">
                <option value="active">Ativo</option>
                <option value="inactive">Inativo</option>
              </select>
            </div>
          </div>
        </div>
        
        <div class="form-group">
          <label for="productDescription">Descri√ß√£o</label>
          <textarea id="productDescription" rows="3" placeholder="Descri√ß√£o detalhada do produto"></textarea>
        </div>
        
        <div class="form-group">
          <button id="btnSaveProduct" class="btn success">Salvar Produto</button>
        </div>
        
        <div class="table-container">
          <div class="table-controls">
            <div class="search-box">
              <input type="text" id="productSearch" placeholder="üîç Buscar produto..." class="search-input">
            </div>
            <div class="filter-box">
              <select id="productCategoryFilter" class="filter-select">
                <option value="">Todas as categorias</option>
              </select>
              <select id="productSubcategoryFilter" class="filter-select">
                <option value="">Todas as subcategorias</option>
              </select>
              <select id="productStatusFilter" class="filter-select">
                <option value="">Todos os status</option>
                <option value="active">Ativo</option>
                <option value="inactive">Inativo</option>
              </select>
            </div>
            <div class="pagination-controls">
              <label for="itemsPerPage">Itens por p√°gina:</label>
              <select id="itemsPerPage" class="pagination-select">
                <option value="10">10</option>
                <option value="25">25</option>
                <option value="50">50</option>
              </select>
            </div>
          </div>
          <table class="data-table" id="productsTable">
            <thead>
              <tr>
                <th>Nome</th>
                <th>Categoria</th>
                <th>Subcategoria</th>
                <th>Pre√ßo</th>
                <th>Estoque</th>
                <th>Status</th>
                <th>A√ß√µes</th>
              </tr>
            </thead>
            <tbody id="productsTableBody">
              <!-- Produtos ser√£o carregados aqui -->
            </tbody>
          </table>
          <div class="pagination">
            <button id="prevPage" class="btn secondary btn-small">‚Üê Anterior</button>
            <span id="pageInfo" class="page-info">P√°gina 1 de 1</span>
            <button id="nextPage" class="btn secondary btn-small">Pr√≥xima ‚Üí</button>
          </div>
        </div>
      </div>
      
      <div id="msg" class="ok"></div>
      <div id="err" class="error"></div>
    </div>
  </div>

  <!-- Modal de Edi√ß√£o de Produto -->
  <div id="editProductModal" class="modal" style="display: none;">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Editar Produto</h3>
        <button id="btnCloseEditModal" class="btn-close">&times;</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label for="editProductName">Nome do Produto</label>
          <input type="text" id="editProductName" placeholder="Ex.: Camiseta Neon">
        </div>
        
        <div class="form-group">
          <div class="form-row">
            <div>
              <label for="editProductCategory">Categoria</label>
              <select id="editProductCategory">
                <option value="">Selecione uma categoria</option>
              </select>
            </div>
            <div>
              <label for="editProductSubcategory">Subcategoria</label>
              <select id="editProductSubcategory">
                <option value="">Selecione uma subcategoria</option>
              </select>
            </div>
          </div>
        </div>
        
        <div class="form-group">
          <div class="form-row">
            <div>
              <label for="editProductPrice">Pre√ßo (N$)</label>
              <input type="number" id="editProductPrice" min="0" step="0.01" placeholder="0.00">
            </div>
            <div>
              <label for="editProductStock">Estoque</label>
              <input type="number" id="editProductStock" min="0" placeholder="0">
            </div>
          </div>
        </div>
        
        <div class="form-group">
          <div class="form-row">
            <div>
              <label for="editProductStatus">Status</label>
              <select id="editProductStatus">
                <option value="active">Ativo</option>
                <option value="inactive">Inativo</option>
              </select>
            </div>
            <div>
              <label for="editProductDescription">Descri√ß√£o</label>
              <textarea id="editProductDescription" rows="3" placeholder="Descri√ß√£o detalhada do produto"></textarea>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button id="btnCancelEdit" class="btn secondary">Cancelar</button>
        <button id="btnSaveEdit" class="btn success">Salvar Altera√ß√µes</button>
      </div>
    </div>
  </div>

  <!-- Modal de Edi√ß√£o de Categoria -->
  <div id="editCategoryModal" class="modal" style="display: none;">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Editar Categoria</h3>
        <button id="btnCloseEditCategoryModal" class="btn-close">&times;</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label for="editCategoryName">Nome da Categoria</label>
          <input type="text" id="editCategoryName" placeholder="Ex.: Vestu√°rio">
        </div>
        
        <div class="form-group">
          <label for="editCategoryDescription">Descri√ß√£o</label>
          <textarea id="editCategoryDescription" rows="3" placeholder="Descri√ß√£o da categoria"></textarea>
        </div>
      </div>
      <div class="modal-footer">
        <button id="btnCancelEditCategory" class="btn secondary">Cancelar</button>
        <button id="btnSaveEditCategory" class="btn success">Salvar Altera√ß√µes</button>
      </div>
    </div>
  </div>

  <!-- Modal de Edi√ß√£o de Subcategoria -->
  <div id="editSubcategoryModal" class="modal" style="display: none;">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Editar Subcategoria</h3>
        <button id="btnCloseEditSubcategoryModal" class="btn-close">&times;</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <div class="form-row">
            <div>
              <label for="editSubcategoryCategory">Categoria Pai</label>
              <select id="editSubcategoryCategory">
                <option value="">Selecione uma categoria</option>
              </select>
            </div>
            <div>
              <label for="editSubcategoryName">Nome da Subcategoria</label>
              <input type="text" id="editSubcategoryName" placeholder="Ex.: Camisetas">
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button id="btnCancelEditSubcategory" class="btn secondary">Cancelar</button>
        <button id="btnSaveEditSubcategory" class="btn success">Salvar Altera√ß√µes</button>
      </div>
    </div>
  </div>

  <!-- Overlay do Modal -->
  <div id="modalOverlay" class="modal-overlay" style="display: none;"></div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-analytics.js";
    import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";
    import { getFirestore, collection, query, where, orderBy, getDocs, addDoc, doc, updateDoc, deleteDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBHU6yFDCKp9jm9tPGyRqQJFS3amewuuQY",
      authDomain: "crmdaneon.firebaseapp.com",
      projectId: "crmdaneon",
      storageBucket: "crmdaneon.firebasestorage.app",
      messagingSenderId: "564595832938",
      appId: "1:564595832938:web:16fb660d8d433ae5f3f213",
      measurementId: "G-D3G4M9F17R"
    };

    const app = initializeApp(firebaseConfig);
    
    try { getAnalytics(app); } catch {}
    try { await signInAnonymously(getAuth(app)); } catch {}

    // Estrutura do banco: bancodaneondb/loja/{categorias|subcategorias|produtos}
    const db = (() => { try { return getFirestore(app, 'bancodaneondb'); } catch { return getFirestore(app); } })();
    
    // Estrutura correta: bancodaneondb/loja/config/categorias/{docId}
    // Primeiro criamos um documento 'config' na cole√ß√£o 'loja'
    // Depois criamos subcole√ß√µes dentro dele
    
    // Elementos da interface
    console.log('üîç Buscando elementos DOM...');
    const unauthEl = document.getElementById('unauth');
    const contentEl = document.getElementById('content');
    const msgEl = document.getElementById('msg');
    const errEl = document.getElementById('err');
    
    // Formul√°rios de categoria
    const categoryName = document.getElementById('categoryName');
    const categoryDescription = document.getElementById('categoryDescription');
    const btnSaveCategory = document.getElementById('btnSaveCategory');
    const btnAddCategory = document.getElementById('btnAddCategory');
    
    // Formul√°rios de subcategoria
    const subcategoryCategory = document.getElementById('subcategoryCategory');
    const subcategoryName = document.getElementById('subcategoryName');
    const btnSaveSubcategory = document.getElementById('btnSaveSubcategory');
    const btnAddSubcategory = document.getElementById('btnAddSubcategory');
    
    // Formul√°rios de produto
    const productName = document.getElementById('productName');
    const productCategory = document.getElementById('productCategory');
    const productSubcategory = document.getElementById('productSubcategory');
    const productPrice = document.getElementById('productPrice');
    const productStock = document.getElementById('productStock');
    const productStatus = document.getElementById('productStatus');
    const productDescription = document.getElementById('productDescription');
    const btnSaveProduct = document.getElementById('btnSaveProduct');
    const btnAddProduct = document.getElementById('btnAddProduct');
    
    // Elementos do modal de edi√ß√£o
    const editProductModal = document.getElementById('editProductModal');
    const modalOverlay = document.getElementById('modalOverlay');
    const editProductName = document.getElementById('editProductName');
    const editProductCategory = document.getElementById('editProductCategory');
    const editProductSubcategory = document.getElementById('editProductSubcategory');
    const editProductPrice = document.getElementById('editProductPrice');
    const editProductStock = document.getElementById('editProductStock');
    const editProductStatus = document.getElementById('editProductStatus');
    const editProductDescription = document.getElementById('editProductDescription');
    const btnCloseEditModal = document.getElementById('btnCloseEditModal');
    const btnCancelEdit = document.getElementById('btnCancelEdit');
    const btnSaveEdit = document.getElementById('btnSaveEdit');
    
    // Elementos dos modais de categoria e subcategoria
    const editCategoryModal = document.getElementById('editCategoryModal');
    const editSubcategoryModal = document.getElementById('editSubcategoryModal');
    const editCategoryName = document.getElementById('editCategoryName');
    const editCategoryDescription = document.getElementById('editCategoryDescription');
    const editSubcategoryCategory = document.getElementById('editSubcategoryCategory');
    const editSubcategoryName = document.getElementById('editSubcategoryName');
    const btnCloseEditCategoryModal = document.getElementById('btnCloseEditCategoryModal');
    const btnCancelEditCategory = document.getElementById('btnCancelEditCategory');
    const btnSaveEditCategory = document.getElementById('btnSaveEditCategory');
    const btnCloseEditSubcategoryModal = document.getElementById('btnCloseEditSubcategoryModal');
    const btnCancelEditSubcategory = document.getElementById('btnCancelEditSubcategory');
    const btnSaveEditSubcategory = document.getElementById('btnSaveEditSubcategory');
    
    // Elementos de busca e filtro
    const categorySearch = document.getElementById('categorySearch');
    const subcategorySearch = document.getElementById('subcategorySearch');
    const productSearch = document.getElementById('productSearch');
    const subcategoryCategoryFilter = document.getElementById('subcategoryCategoryFilter');
    const productCategoryFilter = document.getElementById('productCategoryFilter');
    const productSubcategoryFilter = document.getElementById('productSubcategoryFilter');
    const productStatusFilter = document.getElementById('productStatusFilter');
    
    // Elementos de pagina√ß√£o
    const itemsPerPage = document.getElementById('itemsPerPage');
    const prevPage = document.getElementById('prevPage');
    const nextPage = document.getElementById('nextPage');
    const pageInfo = document.getElementById('pageInfo');
    
    // Tabelas
    const categoriesTableBody = document.getElementById('categoriesTableBody');
    const subcategoriesTableBody = document.getElementById('subcategoriesTableBody');
    const productsTableBody = document.getElementById('productsTableBody');
    
    // Controles do menu lateral
    const btnMenu = document.getElementById('btnMenu');
    const sidebar = document.getElementById('sidebar');
    const sidebarOverlay = document.getElementById('sidebarOverlay');
    const btnCloseSidebar = document.getElementById('btnCloseSidebar');

    // Verifica√ß√£o de sess√£o
    const sessRaw = localStorage.getItem('bn.currentUser');
    
    let sess = null;
    try { sess = JSON.parse(sessRaw); } catch { sess = null; }

    // Verificar se √© administrador (classe: "professor")
    if (!sess || !sess.user || sess.classe !== 'professor') {
      if (unauthEl) {
        unauthEl.style.display = 'block';
      } else {
        console.error('‚ùå Elemento unauth n√£o encontrado!');
      }
    } else {
      if (contentEl) {
        contentEl.style.display = 'block';
        console.log('üì± Conte√∫do principal exibido');
        initializeLojaConfig();
      } else {
        console.error('‚ùå Elemento content n√£o encontrado!');
      }
    }

    // Inicializa√ß√£o da aplica√ß√£o
    async function initializeLojaConfig() {
      try {
        await loadCategories();
        await loadSubcategories();
        await loadProducts();
        
        setupEventListeners();
        setupMenuControls();
      } catch (error) {
        console.error('‚ùå Erro na inicializa√ß√£o:', error);
        showError('Erro ao inicializar aplica√ß√£o: ' + error.message);
      }
    }

    // Configura√ß√£o dos controles do menu
    function setupMenuControls() {
      console.log('üçî Configurando controles do menu...');
      
      if (btnMenu && sidebar && sidebarOverlay) {
        btnMenu.addEventListener('click', () => {
          console.log('üçî Menu clicado - Abrindo sidebar');
          sidebar.classList.add('open');
          sidebarOverlay.classList.add('open');
        });
        console.log('‚úÖ Event listener do menu adicionado');
      } else {
        console.error('‚ùå Elementos do menu n√£o encontrados');
      }

      if (btnCloseSidebar && sidebar && sidebarOverlay) {
        btnCloseSidebar.addEventListener('click', () => {
          console.log('üçî Bot√£o fechar clicado - Fechando sidebar');
          sidebar.classList.remove('open');
          sidebarOverlay.classList.remove('open');
        });
        console.log('‚úÖ Event listener do bot√£o fechar adicionado');
      } else {
        console.error('‚ùå Elementos para fechar sidebar n√£o encontrados');
      }

      if (sidebarOverlay && sidebar) {
        sidebarOverlay.addEventListener('click', () => {
          console.log('üçî Overlay clicado - Fechando sidebar');
          sidebar.classList.remove('open');
          sidebarOverlay.classList.remove('open');
        });
        console.log('‚úÖ Event listener do overlay adicionado');
      } else {
        console.error('‚ùå Elementos do overlay n√£o encontrados');
      }
    }

    // Configura√ß√£o dos event listeners
    function setupEventListeners() {
      console.log('üîó Configurando event listeners...');
      
      // Categorias
      if (btnSaveCategory) {
        console.log('üîó Adicionando event listener ao btnSaveCategory...');
        btnSaveCategory.addEventListener('click', handleSaveCategory);
        console.log('‚úÖ Event listener do btnSaveCategory adicionado');
      } else {
        console.error('‚ùå btnSaveCategory n√£o encontrado');
      }
      
      if (btnAddCategory) {
        console.log('üîó Adicionando event listener ao btnAddCategory...');
        btnAddCategory.addEventListener('click', () => {
          console.log('‚ûï Bot√£o Nova Categoria clicado - Limpando formul√°rio');
          clearCategoryForm();
        });
        console.log('‚úÖ Event listener do btnAddCategory adicionado');
      } else {
        console.error('‚ùå btnAddCategory n√£o encontrado');
      }
      
      // Subcategorias
      if (btnSaveSubcategory) {
        console.log('üîó Adicionando event listener ao btnSaveSubcategory...');
        btnSaveSubcategory.addEventListener('click', handleSaveSubcategory);
        console.log('‚úÖ Event listener do btnSaveSubcategory adicionado');
      } else {
        console.error('‚ùå btnSaveSubcategory n√£o encontrado');
      }
      
      if (btnAddSubcategory) {
        console.log('üîó Adicionando event listener ao btnAddSubcategory...');
        btnAddSubcategory.addEventListener('click', () => {
          console.log('‚ûï Bot√£o Nova Subcategoria clicado - Limpando formul√°rio');
          clearSubcategoryForm();
        });
        console.log('‚úÖ Event listener do btnAddSubcategory adicionado');
      } else {
        console.error('‚ùå btnAddSubcategory n√£o encontrado');
      }
      
      // Produtos
      if (btnSaveProduct) {
        console.log('üîó Adicionando event listener ao btnSaveProduct...');
        btnSaveProduct.addEventListener('click', handleSaveProduct);
        console.log('‚úÖ Event listener do btnSaveProduct adicionado');
      } else {
        console.error('‚ùå btnSaveProduct n√£o encontrado');
      }
      
      if (btnAddProduct) {
        console.log('üîó Adicionando event listener ao btnAddProduct...');
        btnAddProduct.addEventListener('click', () => {
          console.log('‚ûï Bot√£o Novo Produto clicado - Limpando formul√°rio');
          clearProductForm();
        });
        console.log('‚úÖ Event listener do btnAddProduct adicionado');
      } else {
        console.error('‚ùå btnAddProduct n√£o encontrado');
      }
      
      // Mudan√ßas nos selects
      if (productCategory) {
        console.log('üîó Adicionando event listener ao productCategory...');
        productCategory.addEventListener('change', (e) => {
          console.log('üîÑ Categoria alterada:', e.target.value);
          updateSubcategoryOptions();
        });
        console.log('‚úÖ Event listener do productCategory adicionado');
      } else {
        console.error('‚ùå productCategory n√£o encontrado');
      }
      
      if (subcategoryCategory) {
        console.log('üîó Adicionando event listener ao subcategoryCategory...');
        subcategoryCategory.addEventListener('change', (e) => {
          console.log('üîÑ Subcategoria alterada:', e.target.value);
          updateSubcategoryOptions();
        });
        console.log('‚úÖ Event listener do subcategoryCategory adicionado');
      } else {
        console.error('‚ùå subcategoryCategory n√£o encontrado');
      }
      
      // Event listeners para o modal de edi√ß√£o
      if (btnCloseEditModal) {
        console.log('üîó Adicionando event listener ao btnCloseEditModal...');
        btnCloseEditModal.addEventListener('click', closeEditModal);
        console.log('‚úÖ Event listener do btnCloseEditModal adicionado');
      } else {
        console.error('‚ùå btnCloseEditModal n√£o encontrado');
      }
      
      if (btnCancelEdit) {
        console.log('üîó Adicionando event listener ao btnCancelEdit...');
        btnCancelEdit.addEventListener('click', closeEditModal);
        console.log('‚úÖ Event listener do btnCancelEdit adicionado');
      } else {
        console.error('‚ùå btnCancelEdit n√£o encontrado');
      }
      
      if (btnSaveEdit) {
        console.log('üîó Adicionando event listener ao btnSaveEdit...');
        btnSaveEdit.addEventListener('click', handleSaveEdit);
        console.log('‚úÖ Event listener do btnSaveEdit adicionado');
      } else {
        console.error('‚ùå btnSaveEdit n√£o encontrado');
      }
      
      // Event listener para mudan√ßa de categoria no modal
      if (editProductCategory) {
        console.log('üîó Adicionando event listener ao editProductCategory...');
        editProductCategory.addEventListener('change', updateEditSubcategoryOptions);
        console.log('‚úÖ Event listener do editProductCategory adicionado');
      } else {
        console.error('‚ùå editProductCategory n√£o encontrado');
      }
      
      // Event listener para fechar modal clicando no overlay
      if (modalOverlay) {
        console.log('üîó Adicionando event listener ao modalOverlay...');
        modalOverlay.addEventListener('click', () => {
          closeEditModal();
          closeEditCategoryModal();
          closeEditSubcategoryModal();
        });
        console.log('‚úÖ Event listener do modalOverlay adicionado');
      } else {
        console.error('‚ùå modalOverlay n√£o encontrado');
      }
      
      // Event listeners para modais de categoria e subcategoria
      if (btnCloseEditCategoryModal) {
        btnCloseEditCategoryModal.addEventListener('click', closeEditCategoryModal);
        console.log('‚úÖ Event listener do btnCloseEditCategoryModal adicionado');
      }
      
      if (btnCancelEditCategory) {
        btnCancelEditCategory.addEventListener('click', closeEditCategoryModal);
        console.log('‚úÖ Event listener do btnCancelEditCategory adicionado');
      }
      
      if (btnSaveEditCategory) {
        btnSaveEditCategory.addEventListener('click', handleSaveEditCategory);
        console.log('‚úÖ Event listener do btnSaveEditCategory adicionado');
      }
      
      if (btnCloseEditSubcategoryModal) {
        btnCloseEditSubcategoryModal.addEventListener('click', closeEditSubcategoryModal);
        console.log('‚úÖ Event listener do btnCloseEditSubcategoryModal adicionado');
      }
      
      if (btnCancelEditSubcategory) {
        btnCancelEditSubcategory.addEventListener('click', closeEditSubcategoryModal);
        console.log('‚úÖ Event listener do btnCancelEditSubcategory adicionado');
      }
      
      if (btnSaveEditSubcategory) {
        btnSaveEditSubcategory.addEventListener('click', handleSaveEditSubcategory);
        console.log('‚úÖ Event listener do btnSaveEditSubcategory adicionado');
      }
      
      // Event listeners para busca e filtros
      if (categorySearch) {
        categorySearch.addEventListener('input', filterCategories);
        console.log('‚úÖ Event listener do categorySearch adicionado');
      }
      
      if (subcategorySearch) {
        subcategorySearch.addEventListener('input', filterSubcategories);
        console.log('‚úÖ Event listener do subcategorySearch adicionado');
      }
      
      if (productSearch) {
        productSearch.addEventListener('input', filterProducts);
        console.log('‚úÖ Event listener do productSearch adicionado');
      }
      
      if (productCategoryFilter) {
        productCategoryFilter.addEventListener('change', filterProducts);
        console.log('‚úÖ Event listener do productCategoryFilter adicionado');
      }
      
      if (productSubcategoryFilter) {
        productSubcategoryFilter.addEventListener('change', filterProducts);
        console.log('‚úÖ Event listener do productSubcategoryFilter adicionado');
      }
      
      if (productStatusFilter) {
        productStatusFilter.addEventListener('change', filterProducts);
        console.log('‚úÖ Event listener do productStatusFilter adicionado');
      }
      
      if (subcategoryCategoryFilter) {
        subcategoryCategoryFilter.addEventListener('change', filterSubcategories);
        console.log('‚úÖ Event listener do subcategoryCategoryFilter adicionado');
      }
      
      // Event listeners para pagina√ß√£o
      if (itemsPerPage) {
        itemsPerPage.addEventListener('change', changeItemsPerPage);
        console.log('‚úÖ Event listener do itemsPerPage adicionado');
      }
      
      if (prevPage) {
        prevPage.addEventListener('click', prevPageProducts);
        console.log('‚úÖ Event listener do prevPage adicionado');
      }
      
      if (nextPage) {
        nextPage.addEventListener('click', nextPageProducts);
        console.log('‚úÖ Event listener do nextPage adicionado');
      }
      
      console.log('üîó Event listeners configurados');
    }

    // ===== FUN√á√ïES DE CATEGORIA =====
    async function loadCategories() {
      console.log('üìã Carregando categorias do Firestore...');
      try {
        // Primeiro, garantir que o documento 'config' existe
        const configDocRef = doc(db, 'loja', 'config');
        try {
          await getDocs(collection(configDocRef, 'categorias'));
        } catch {
          // Se n√£o existir, criar o documento config
          await setDoc(configDocRef, { createdAt: serverTimestamp() });
        }
        
        const categoriesCol = collection(db, 'loja', 'config', 'categorias');
        console.log('üìÅ Collection de categorias criada:', categoriesCol);
        
        const q = query(categoriesCol, orderBy('name'));
        console.log('üîç Query criada:', q);
        
        const snap = await getDocs(q);
        console.log('üìÑ Snapshot recebido:', snap);
        console.log('üìä N√∫mero de documentos:', snap.size);
        
        const categories = [];
        snap.forEach(doc => {
          const data = doc.data();
          console.log('üìã Categoria encontrada:', { id: doc.id, ...data });
          categories.push({ id: doc.id, ...data });
        });
        
        console.log('üìã Total de categorias:', categories.length);
        
        // Armazenar categorias para filtros
        allCategories = categories;
        
        renderCategoriesTable(categories);
        updateCategorySelects(categories);
        console.log('‚úÖ Categorias carregadas e renderizadas');
      } catch (error) {
        console.error('‚ùå Erro ao carregar categorias:', error);
        showError('Erro ao carregar categorias: ' + error.message);
      }
    }

    function renderCategoriesTable(categories) {
      console.log('üé® Renderizando tabela de categorias...');
      if (!categoriesTableBody) {
        console.error('‚ùå categoriesTableBody n√£o encontrado');
        return;
      }
      
      categoriesTableBody.innerHTML = '';
      console.log('üßπ Tabela limpa');
      
      if (categories.length === 0) {
        console.log('üì≠ Nenhuma categoria para exibir');
        const row = document.createElement('tr');
        row.innerHTML = '<td colspan="4" style="text-align: center; color: var(--muted);">Nenhuma categoria encontrada</td>';
        categoriesTableBody.appendChild(row);
        return;
      }
      
      categories.forEach((category, index) => {
        console.log(`üìã Renderizando categoria ${index + 1}:`, category);
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${category.name}</td>
          <td>${category.description || '-'}</td>
          <td>${category.productCount || 0}</td>
          <td>
            <div class="action-buttons">
              <button class="btn btn-icon warning" onclick="editCategory('${category.id}')" title="Editar">‚úèÔ∏è</button>
              <button class="btn btn-icon danger" onclick="deleteCategory('${category.id}')" title="Excluir">üóëÔ∏è</button>
            </div>
          </td>
        `;
        categoriesTableBody.appendChild(row);
        console.log(`‚úÖ Categoria ${category.name} renderizada`);
      });
      
      console.log('‚úÖ Tabela de categorias renderizada');
    }

    async function handleSaveCategory() {
      console.log('üíæ Salvando categoria...');
      const name = categoryName?.value?.trim();
      const description = categoryDescription?.value?.trim();
      
      console.log('üìù Dados da categoria:', { name, description });
      
      if (!name) {
        console.error('‚ùå Nome da categoria √© obrigat√≥rio');
        showError('Nome da categoria √© obrigat√≥rio');
        return;
      }
      
      try {
        const categoryData = {
          name,
          description,
          createdAt: serverTimestamp(),
          updatedAt: serverTimestamp()
        };
        
        console.log('üìã Dados para salvar:', categoryData);
        
        const categoriesCol = collection(db, 'loja', 'config', 'categorias');
        console.log('üìÅ Collection criada:', categoriesCol);
        
        const docRef = await addDoc(categoriesCol, categoryData);
        console.log('‚úÖ Categoria salva com ID:', docRef.id);
        
        showSuccess('Categoria criada com sucesso!');
        clearCategoryForm();
        await loadCategories();
      } catch (error) {
        console.error('‚ùå Erro ao salvar categoria:', error);
        showError('Erro ao salvar categoria: ' + error.message);
      }
    }

    function clearCategoryForm() {
      console.log('üßπ Limpando formul√°rio de categoria...');
      if (categoryName) categoryName.value = '';
      if (categoryDescription) categoryDescription.value = '';
      if (btnSaveCategory) btnSaveCategory.textContent = 'Salvar Categoria';
      console.log('‚úÖ Formul√°rio limpo');
    }

    // ===== FUN√á√ïES DE SUBCATEGORIA =====
    async function loadSubcategories() {
      console.log('üìã Carregando subcategorias do Firestore...');
      try {
        const subcategoriesCol = collection(db, 'loja', 'config', 'subcategorias');
        console.log('üìÅ Collection de subcategorias criada:', subcategoriesCol);
        
        const q = query(subcategoriesCol, orderBy('name'));
        console.log('üîç Query criada:', q);
        
        const snap = await getDocs(q);
        console.log('üìÑ Snapshot recebido:', snap);
        console.log('üìä N√∫mero de documentos:', snap.size);
        
        const subcategories = [];
        snap.forEach(doc => {
          const data = doc.data();
          console.log('üìã Subcategoria encontrada:', { id: doc.id, ...data });
          subcategories.push({ id: doc.id, ...data });
        });
        
        console.log('üìã Total de subcategorias:', subcategories.length);
        
        // Armazenar subcategorias para filtros
        allSubcategories = subcategories;
        
        renderSubcategoriesTable(subcategories);
        updateSubcategorySelects(subcategories);
        console.log('‚úÖ Subcategorias carregadas e renderizadas');
      } catch (error) {
        console.error('‚ùå Erro ao carregar subcategorias:', error);
        showError('Erro ao carregar subcategorias: ' + error.message);
      }
    }

    function renderSubcategoriesTable(subcategories) {
      console.log('üé® Renderizando tabela de subcategorias...');
      if (!subcategoriesTableBody) {
        console.error('‚ùå subcategoriesTableBody n√£o encontrado');
        return;
      }
      
      subcategoriesTableBody.innerHTML = '';
      console.log('üßπ Tabela limpa');
      
      if (subcategories.length === 0) {
        console.log('üì≠ Nenhuma subcategoria para exibir');
        const row = document.createElement('tr');
        row.innerHTML = '<td colspan="4" style="text-align: center; color: var(--muted);">Nenhuma subcategoria encontrada</td>';
        subcategoriesTableBody.appendChild(row);
        return;
      }
      
      subcategories.forEach((subcategory, index) => {
        console.log(`üìã Renderizando subcategoria ${index + 1}:`, subcategory);
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${subcategory.categoryName || '-'}</td>
          <td>${subcategory.name}</td>
          <td>${subcategory.productCount || 0}</td>
          <td>
            <div class="action-buttons">
              <button class="btn btn-icon warning" onclick="editSubcategory('${subcategory.id}')" title="Editar">‚úèÔ∏è</button>
              <button class="btn btn-icon danger" onclick="deleteSubcategory('${subcategory.id}')" title="Excluir">üóëÔ∏è</button>
            </div>
          </td>
        `;
        subcategoriesTableBody.appendChild(row);
        console.log(`‚úÖ Subcategoria ${subcategory.name} renderizada`);
      });
      
      console.log('‚úÖ Tabela de subcategorias renderizada');
    }

    async function handleSaveSubcategory() {
      console.log('üíæ Salvando subcategoria...');
      const categoryId = subcategoryCategory?.value;
      const name = subcategoryName?.value?.trim();
      
      console.log('üìù Dados da subcategoria:', { categoryId, name });
      
      if (!categoryId || !name) {
        console.error('‚ùå Categoria e nome s√£o obrigat√≥rios');
        showError('Categoria e nome s√£o obrigat√≥rios');
        return;
      }
      
      try {
        // Buscar nome da categoria
        console.log('üîç Buscando nome da categoria...');
        const categoryDoc = await getDocs(collection(db, 'loja', 'config', 'categorias'));
        let categoryName = '';
        categoryDoc.forEach(doc => {
          if (doc.id === categoryId) {
            categoryName = doc.data().name;
          }
        });
        
        console.log('üìã Nome da categoria encontrado:', categoryName);
        
        const subcategoryData = {
          categoryId,
          categoryName,
          name,
          createdAt: serverTimestamp(),
          updatedAt: serverTimestamp()
        };
        
        console.log('üìã Dados para salvar:', subcategoryData);
        
        const subcategoriesCol = collection(db, 'loja', 'config', 'subcategorias');
        console.log('üìÅ Collection criada:', subcategoriesCol);
        
        const docRef = await addDoc(subcategoriesCol, subcategoryData);
        console.log('‚úÖ Subcategoria salva com ID:', docRef.id);
        
        showSuccess('Subcategoria criada com sucesso!');
        clearSubcategoryForm();
        await loadSubcategories();
      } catch (error) {
        console.error('‚ùå Erro ao salvar subcategoria:', error);
        showError('Erro ao salvar subcategoria: ' + error.message);
      }
    }

    function clearSubcategoryForm() {
      console.log('üßπ Limpando formul√°rio de subcategoria...');
      if (subcategoryCategory) subcategoryCategory.value = '';
      if (subcategoryName) subcategoryName.value = '';
      if (btnSaveSubcategory) btnSaveSubcategory.textContent = 'Salvar Subcategoria';
      console.log('‚úÖ Formul√°rio limpo');
    }

    // ===== FUN√á√ïES DE PRODUTO =====
    async function loadProducts() {
      console.log('üìã Carregando produtos do Firestore...');
      try {
        const productsCol = collection(db, 'loja', 'config', 'produtos');
        console.log('üìÅ Collection de produtos criada:', productsCol);
        
        const q = query(productsCol, orderBy('name'));
        console.log('üîç Query criada:', q);
        
        const snap = await getDocs(q);
        console.log('üìÑ Snapshot recebido:', snap);
        console.log('üìä N√∫mero de documentos:', snap.size);
        
        const products = [];
        snap.forEach(doc => {
          const data = doc.data();
          console.log('üìã Produto encontrado:', { id: doc.id, ...data });
          products.push({ id: doc.id, ...data });
        });
        
        console.log('üìã Total de produtos:', products.length);
        
        // Armazenar todos os produtos para filtros
        allProducts = products;
        filteredProducts = products;
        
        // Renderizar com pagina√ß√£o
        renderProductsTablePaginated();
        console.log('‚úÖ Produtos carregados e renderizados com pagina√ß√£o');
        
        // Popular selects do modal de edi√ß√£o
        await populateEditCategorySelects();
        console.log('‚úÖ Selects do modal populados');
      } catch (error) {
        console.error('‚ùå Erro ao carregar produtos:', error);
        showError('Erro ao carregar produtos: ' + error.message);
      }
    }

    function renderProductsTable(products) {
      console.log('üé® Renderizando tabela de produtos...');
      if (!productsTableBody) {
        console.error('‚ùå productsTableBody n√£o encontrado');
        return;
      }
      
      productsTableBody.innerHTML = '';
      console.log('üßπ Tabela limpa');
      
      if (products.length === 0) {
        console.log('üì≠ Nenhum produto para exibir');
        const row = document.createElement('tr');
        row.innerHTML = '<td colspan="7" style="text-align: center; color: var(--muted);">Nenhum produto encontrado</td>';
        productsTableBody.appendChild(row);
        return;
      }
      
      products.forEach((product, index) => {
        console.log(`üìã Renderizando produto ${index + 1}:`, product);
        const row = document.createElement('tr');
        const stockClass = product.stock <= 5 ? 'status-low' : 'status-active';
        const statusClass = product.status === 'active' ? 'status-active' : 'status-inactive';
        
        row.innerHTML = `
          <td>${product.name}</td>
          <td>${product.categoryName || '-'}</td>
          <td>${product.subcategoryName || '-'}</td>
          <td>N$ ${product.price?.toFixed(2) || '0.00'}</td>
          <td><span class="status-badge ${stockClass}">${product.stock || 0}</span></td>
          <td><span class="status-badge ${statusClass}">${product.status === 'active' ? 'Ativo' : 'Inativo'}</span></td>
          <td>
            <div class="action-buttons">
              <button class="btn btn-icon warning" onclick="editProduct('${product.id}')" title="Editar">‚úèÔ∏è</button>
              <button class="btn btn-icon danger" onclick="deleteProduct('${product.id}')" title="Excluir">üóëÔ∏è</button>
            </div>
          </td>
        `;
        productsTableBody.appendChild(row);
        console.log(`‚úÖ Produto ${product.name} renderizado`);
      });
      
      console.log('‚úÖ Tabela de produtos renderizada');
    }

    async function handleSaveProduct() {
      console.log('üíæ Salvando produto...');
      const name = productName?.value?.trim();
      const categoryId = productCategory?.value;
      const subcategoryId = productSubcategory?.value;
      const price = parseFloat(productPrice?.value) || 0;
      const stock = parseInt(productStock?.value) || 0;
      const status = productStatus?.value;
      const description = productDescription?.value?.trim();
      
      console.log('üìù Dados do produto:', { name, categoryId, subcategoryId, price, stock, status, description });
      
      if (!name || !categoryId) {
        console.error('‚ùå Nome e categoria s√£o obrigat√≥rios');
        showError('Nome e categoria s√£o obrigat√≥rios');
        return;
      }
      
      try {
        // Buscar nomes das categorias
        console.log('üîç Buscando nomes das categorias...');
        const categoryDoc = await getDocs(collection(db, 'loja', 'config', 'categorias'));
        let categoryName = '';
        categoryDoc.forEach(doc => {
          if (doc.id === categoryId) {
            categoryName = doc.data().name;
          }
        });
        
        const subcategoryDoc = await getDocs(collection(db, 'loja', 'config', 'subcategorias'));
        let subcategoryName = '';
        subcategoryDoc.forEach(doc => {
          if (doc.id === subcategoryId) {
            subcategoryName = doc.data().name;
          }
        });
        
        console.log('üìã Nomes encontrados:', { categoryName, subcategoryName });
        
        const productData = {
          name,
          categoryId,
          categoryName,
          subcategoryId,
          subcategoryName,
          price,
          stock,
          status,
          description,
          createdAt: serverTimestamp(),
          updatedAt: serverTimestamp()
        };
        
        console.log('üìã Dados para salvar:', productData);
        
        const productsCol = collection(db, 'loja', 'config', 'produtos');
        console.log('üìÅ Collection criada:', productsCol);
        
        const docRef = await addDoc(productsCol, productData);
        console.log('‚úÖ Produto salvo com ID:', docRef.id);
        
        showSuccess('Produto criado com sucesso!');
        clearProductForm();
        await loadProducts();
      } catch (error) {
        console.error('‚ùå Erro ao salvar produto:', error);
        showError('Erro ao salvar produto: ' + error.message);
      }
    }

    function clearProductForm() {
      console.log('üßπ Limpando formul√°rio de produto...');
      if (productName) productName.value = '';
      if (productCategory) productCategory.value = '';
      if (productSubcategory) productSubcategory.value = '';
      if (productPrice) productPrice.value = '';
      if (productStock) productStock.value = '';
      if (productStatus) productStatus.value = 'active';
      if (productDescription) productDescription.value = '';
      if (btnSaveProduct) btnSaveProduct.textContent = 'Salvar Produto';
      console.log('‚úÖ Formul√°rio limpo');
    }

    // ===== FUN√á√ïES AUXILIARES =====
    function updateCategorySelects(categories) {
      console.log('üîÑ Atualizando selects de categoria...');
      if (!productCategory || !subcategoryCategory) {
        console.error('‚ùå Selects de categoria n√£o encontrados');
        return;
      }
      
      const options = ['<option value="">Selecione uma categoria</option>'];
      categories.forEach(cat => {
        options.push(`<option value="${cat.id}">${cat.name}</option>`);
      });
      
      productCategory.innerHTML = options.join('');
      subcategoryCategory.innerHTML = options.join('');
      console.log('‚úÖ Selects de categoria atualizados');
    }

    function updateSubcategoryOptions() {
      console.log('üîÑ Atualizando op√ß√µes de subcategoria...');
      const categoryId = productCategory?.value;
      const subcategorySelect = productSubcategory;
      
      if (!subcategorySelect) {
        console.error('‚ùå Select de subcategoria n√£o encontrado');
        return;
      }
      
      if (!categoryId) {
        subcategorySelect.innerHTML = '<option value="">Selecione uma subcategoria</option>';
        console.log('‚úÖ Select de subcategoria limpo');
        return;
      }
      
      console.log('üîç Buscando subcategorias para categoria:', categoryId);
      
              // Buscar subcategorias da categoria selecionada
        getDocs(collection(db, 'loja', 'config', 'subcategorias')).then(snap => {
        const options = ['<option value="">Selecione uma subcategoria</option>'];
        snap.forEach(doc => {
          const data = doc.data();
          if (data.categoryId === categoryId) {
            options.push(`<option value="${doc.id}">${data.name}</option>`);
          }
        });
        subcategorySelect.innerHTML = options.join('');
        console.log('‚úÖ Op√ß√µes de subcategoria atualizadas');
      }).catch(error => {
        console.error('‚ùå Erro ao buscar subcategorias:', error);
      });
    }

    // Fun√ß√£o para atualizar subcategorias no modal de edi√ß√£o
    async function updateEditSubcategoryOptions() {
      console.log('üîÑ Atualizando op√ß√µes de subcategoria no modal...');
      const categoryId = editProductCategory?.value;
      const subcategorySelect = editProductSubcategory;
      
      if (!subcategorySelect) {
        console.error('‚ùå Select de subcategoria do modal n√£o encontrado');
        return;
      }
      
      if (!categoryId) {
        subcategorySelect.innerHTML = '<option value="">Selecione uma subcategoria</option>';
        console.log('‚úÖ Select de subcategoria do modal limpo');
        return;
      }
      
      console.log('üîç Buscando subcategorias para categoria:', categoryId);
      
      try {
        const snap = await getDocs(collection(db, 'loja', 'config', 'subcategorias'));
        const options = ['<option value="">Selecione uma subcategoria</option>'];
        snap.forEach(doc => {
          const data = doc.data();
          if (data.categoryId === categoryId) {
            options.push(`<option value="${doc.id}">${data.name}</option>`);
          }
        });
        subcategorySelect.innerHTML = options.join('');
        console.log('‚úÖ Op√ß√µes de subcategoria do modal atualizadas');
      } catch (error) {
        console.error('‚ùå Erro ao buscar subcategorias do modal:', error);
      }
    }

    function showSuccess(message) {
      console.log('‚úÖ Sucesso:', message);
      if (msgEl) {
        msgEl.textContent = message;
        msgEl.style.display = 'block';
        if (errEl) errEl.style.display = 'none';
        setTimeout(() => {
          msgEl.style.display = 'none';
        }, 3000);
      } else {
        console.error('‚ùå Elemento msg n√£o encontrado');
      }
    }

    function showError(message) {
      console.error('‚ùå Erro:', message);
      if (errEl) {
        errEl.textContent = message;
        errEl.style.display = 'block';
        if (msgEl) msgEl.style.display = 'none';
        setTimeout(() => {
          errEl.style.display = 'none';
        }, 5000);
      } else {
        console.error('‚ùå Elemento err n√£o encontrado');
      }
    }

    // Vari√°veis globais para edi√ß√£o
    let currentEditCategory = null;
    let currentEditSubcategory = null;
    
    // Fun√ß√µes globais para os bot√µes de a√ß√£o
    window.editCategory = async function(id) {
      console.log('‚úèÔ∏è Editando categoria:', id);
      
      try {
        // Buscar dados da categoria no Firestore
        const categoryDoc = await getDocs(collection(db, 'loja', 'config', 'categorias'));
        let categoryData = null;
        
        categoryDoc.forEach(doc => {
          if (doc.id === id) {
            categoryData = { id: doc.id, ...doc.data() };
          }
        });
        
        if (!categoryData) {
          showError('Categoria n√£o encontrada');
          return;
        }
        
        // Armazenar categoria atual para edi√ß√£o
        currentEditCategory = categoryData;
        
        // Preencher formul√°rio de edi√ß√£o
        editCategoryName.value = categoryData.name || '';
        editCategoryDescription.value = categoryData.description || '';
        
        // Mostrar modal
        editCategoryModal.style.display = 'flex';
        modalOverlay.style.display = 'block';
        
        console.log('‚úÖ Modal de edi√ß√£o de categoria aberto para:', categoryData.name);
        
      } catch (error) {
        console.error('‚ùå Erro ao abrir modal de edi√ß√£o de categoria:', error);
        showError('Erro ao abrir modal de edi√ß√£o: ' + error.message);
      }
    };

    window.deleteCategory = async function(id) {
      console.log('üóëÔ∏è Excluindo categoria:', id);
      if (confirm('Tem certeza que deseja excluir esta categoria?')) {
        try {
          await deleteDoc(doc(db, 'loja', 'config', 'categorias', id));
          console.log('‚úÖ Categoria exclu√≠da');
          showSuccess('Categoria exclu√≠da com sucesso!');
          await loadCategories();
        } catch (error) {
          console.error('‚ùå Erro ao excluir categoria:', error);
          showError('Erro ao excluir categoria: ' + error.message);
        }
      }
    };

    window.editSubcategory = async function(id) {
      console.log('‚úèÔ∏è Editando subcategoria:', id);
      
      try {
        // Buscar dados da subcategoria no Firestore
        const subcategoryDoc = await getDocs(collection(db, 'loja', 'config', 'subcategorias'));
        let subcategoryData = null;
        
        subcategoryDoc.forEach(doc => {
          if (doc.id === id) {
            subcategoryData = { id: doc.id, ...doc.data() };
          }
        });
        
        if (!subcategoryData) {
          showError('Subcategoria n√£o encontrada');
          return;
        }
        
        // Armazenar subcategoria atual para edi√ß√£o
        currentEditSubcategory = subcategoryData;
        
        // Preencher formul√°rio de edi√ß√£o
        editSubcategoryCategory.value = subcategoryData.categoryId || '';
        editSubcategoryName.value = subcategoryData.name || '';
        
        // Mostrar modal
        editSubcategoryModal.style.display = 'flex';
        modalOverlay.style.display = 'block';
        
        console.log('‚úÖ Modal de edi√ß√£o de subcategoria aberto para:', subcategoryData.name);
        
      } catch (error) {
        console.error('‚ùå Erro ao abrir modal de edi√ß√£o de subcategoria:', error);
        showError('Erro ao abrir modal de edi√ß√£o: ' + error.message);
      }
    };

    window.deleteSubcategory = async function(id) {
      console.log('üóëÔ∏è Excluindo subcategoria:', id);
      if (confirm('Tem certeza que deseja excluir esta subcategoria?')) {
        try {
          await deleteDoc(doc(db, 'loja', 'config', 'subcategorias', id));
          console.log('‚úÖ Subcategoria exclu√≠da');
          showSuccess('Subcategoria exclu√≠da com sucesso!');
          await loadCategories();
        } catch (error) {
          console.error('‚ùå Erro ao excluir subcategoria:', error);
          showError('Erro ao excluir subcategoria: ' + error.message);
        }
      }
    };

    // Vari√°vel global para armazenar o produto sendo editado
    let currentEditProduct = null;

    window.editProduct = async function(id) {
      console.log('‚úèÔ∏è Editando produto:', id);
      
      try {
        // Buscar dados do produto no Firestore
        const productDoc = await getDocs(collection(db, 'loja', 'config', 'produtos'));
        let productData = null;
        
        productDoc.forEach(doc => {
          if (doc.id === id) {
            productData = { id: doc.id, ...doc.data() };
          }
        });
        
        if (!productData) {
          showError('Produto n√£o encontrado');
          return;
        }
        
        // Armazenar produto atual para edi√ß√£o
        currentEditProduct = productData;
        
        // Preencher formul√°rio de edi√ß√£o
        editProductName.value = productData.name || '';
        editProductCategory.value = productData.categoryId || '';
        editProductSubcategory.value = productData.subcategoryId || '';
        editProductPrice.value = productData.price || '';
        editProductStock.value = productData.stock || '';
        editProductStatus.value = productData.status || 'active';
        editProductDescription.value = productData.description || '';
        
        // Atualizar op√ß√µes de subcategoria baseado na categoria selecionada
        await updateEditSubcategoryOptions();
        
        // Mostrar modal
        editProductModal.style.display = 'flex';
        modalOverlay.style.display = 'block';
        
        console.log('‚úÖ Modal de edi√ß√£o aberto para:', productData.name);
        
      } catch (error) {
        console.error('‚ùå Erro ao abrir modal de edi√ß√£o:', error);
        showError('Erro ao abrir modal de edi√ß√£o: ' + error.message);
      }
    };

    window.deleteProduct = async function(id) {
      console.log('üóëÔ∏è Excluindo produto:', id);
      
      if (confirm('Tem certeza que deseja excluir este produto? Esta a√ß√£o n√£o pode ser desfeita.')) {
        try {
          await deleteDoc(doc(db, 'loja', 'config', 'produtos', id));
          console.log('‚úÖ Produto exclu√≠do com sucesso');
          showSuccess('Produto exclu√≠do com sucesso!');
          await loadProducts(); // Recarregar lista de produtos
        } catch (error) {
          console.error('‚ùå Erro ao excluir produto:', error);
          showError('Erro ao excluir produto: ' + error.message);
        }
      }
    };
    
    // ===== FUN√á√ïES DO MODAL DE EDI√á√ÉO =====
    
    // Fun√ß√£o para fechar o modal de produto
    function closeEditModal() {
      console.log('üö™ Fechando modal de edi√ß√£o de produto...');
      editProductModal.style.display = 'none';
      modalOverlay.style.display = 'none';
      currentEditProduct = null;
      console.log('‚úÖ Modal de produto fechado');
    }
    
    // Fun√ß√£o para fechar o modal de categoria
    function closeEditCategoryModal() {
      console.log('üö™ Fechando modal de edi√ß√£o de categoria...');
      editCategoryModal.style.display = 'none';
      modalOverlay.style.display = 'none';
      currentEditCategory = null;
      console.log('‚úÖ Modal de categoria fechado');
    }
    
    // Fun√ß√£o para fechar o modal de subcategoria
    function closeEditSubcategoryModal() {
      console.log('üö™ Fechando modal de edi√ß√£o de subcategoria...');
      editSubcategoryModal.style.display = 'none';
      modalOverlay.style.display = 'none';
      currentEditSubcategory = null;
      console.log('‚úÖ Modal de subcategoria fechado');
    }
    
    // Fun√ß√£o para salvar as altera√ß√µes do produto
    async function handleSaveEdit() {
      console.log('üíæ Salvando altera√ß√µes do produto...');
      
      if (!currentEditProduct) {
        console.error('‚ùå Nenhum produto selecionado para edi√ß√£o');
        showError('Nenhum produto selecionado para edi√ß√£o');
        return;
      }
      
      const name = editProductName?.value?.trim();
      const categoryId = editProductCategory?.value;
      const subcategoryId = editProductSubcategory?.value;
      const price = parseFloat(editProductPrice?.value) || 0;
      const stock = parseInt(editProductStock?.value) || 0;
      const status = editProductStatus?.value;
      const description = editProductDescription?.value?.trim();
      
      console.log('üìù Dados editados:', { name, categoryId, subcategoryId, price, stock, status, description });
      
      if (!name || !categoryId) {
        console.error('‚ùå Nome e categoria s√£o obrigat√≥rios');
        showError('Nome e categoria s√£o obrigat√≥rios');
        return;
      }
      
      try {
        // Buscar nomes das categorias
        console.log('üîç Buscando nomes das categorias...');
        const categoryDoc = await getDocs(collection(db, 'loja', 'config', 'categorias'));
        let categoryName = '';
        categoryDoc.forEach(doc => {
          if (doc.id === categoryId) {
            categoryName = doc.data().name;
          }
        });
        
        const subcategoryDoc = await getDocs(collection(db, 'loja', 'config', 'subcategorias'));
        let subcategoryName = '';
        subcategoryDoc.forEach(doc => {
          if (doc.id === subcategoryId) {
            subcategoryName = doc.data().name;
          }
        });
        
        console.log('üìã Nomes encontrados:', { categoryName, subcategoryName });
        
        const updatedProductData = {
          name,
          categoryId,
          categoryName,
          subcategoryId,
          subcategoryName,
          price,
          stock,
          status,
          description,
          updatedAt: serverTimestamp()
        };
        
        console.log('üìã Dados para atualizar:', updatedProductData);
        
        // Atualizar documento no Firestore
        const productDocRef = doc(db, 'loja', 'config', 'produtos', currentEditProduct.id);
        await updateDoc(productDocRef, updatedProductData);
        
        console.log('‚úÖ Produto atualizado com sucesso');
        showSuccess('Produto atualizado com sucesso!');
        
        // Fechar modal e recarregar produtos
        closeEditModal();
        await loadProducts();
        
      } catch (error) {
        console.error('‚ùå Erro ao atualizar produto:', error);
        showError('Erro ao atualizar produto: ' + error.message);
      }
    }
    
    // Fun√ß√£o para popular os selects do modal com categorias
    async function populateEditCategorySelects() {
      console.log('üîÑ Populando selects de categoria do modal...');
      
      try {
        const categoriesSnap = await getDocs(collection(db, 'loja', 'config', 'categorias'));
        const options = ['<option value="">Selecione uma categoria</option>'];
        
        categoriesSnap.forEach(doc => {
          const data = doc.data();
          options.push(`<option value="${doc.id}">${data.name}</option>`);
        });
        
        if (editProductCategory) {
          editProductCategory.innerHTML = options.join('');
          console.log('‚úÖ Select de categoria do modal populado');
        }
        
        // Popular tamb√©m os selects dos outros modais
        if (editSubcategoryCategory) {
          editSubcategoryCategory.innerHTML = options.join('');
          console.log('‚úÖ Select de categoria do modal de subcategoria populado');
        }
        
        // Popular filtros
        if (productCategoryFilter) {
          productCategoryFilter.innerHTML = '<option value="">Todas as categorias</option>' + options.slice(1).join('');
        }
        if (subcategoryCategoryFilter) {
          subcategoryCategoryFilter.innerHTML = '<option value="">Todas as categorias</option>' + options.slice(1).join('');
        }
        
      } catch (error) {
        console.error('‚ùå Erro ao popular categorias do modal:', error);
      }
    }
    
    // Sistema de pagina√ß√£o e filtros para produtos
    let currentPage = 1;
    let itemsPerPageValue = 10;
    let filteredProducts = [];
    let allProducts = [];
    
    // Vari√°veis para filtros de categoria e subcategoria
    let allCategories = [];
    let allSubcategories = [];
    
    // Fun√ß√£o para filtrar produtos
    function filterProducts() {
      const searchTerm = productSearch?.value?.toLowerCase() || '';
      const categoryFilter = productCategoryFilter?.value || '';
      const subcategoryFilter = productSubcategoryFilter?.value || '';
      const statusFilter = productStatusFilter?.value || '';
      
      console.log('üîç Filtrando produtos:', { searchTerm, categoryFilter, subcategoryFilter, statusFilter });
      
      filteredProducts = allProducts.filter(product => {
        const matchesSearch = !searchTerm || 
          product.name.toLowerCase().includes(searchTerm) ||
          product.description?.toLowerCase().includes(searchTerm);
        
        const matchesCategory = !categoryFilter || product.categoryId === categoryFilter;
        const matchesSubcategory = !subcategoryFilter || product.subcategoryId === subcategoryFilter;
        const matchesStatus = !statusFilter || product.status === statusFilter;
        
        return matchesSearch && matchesCategory && matchesSubcategory && matchesStatus;
      });
      
      console.log('üìä Produtos filtrados:', filteredProducts.length);
      currentPage = 1;
      renderProductsTablePaginated();
    }
    
    // Fun√ß√£o para renderizar produtos com pagina√ß√£o
    function renderProductsTablePaginated() {
      const startIndex = (currentPage - 1) * itemsPerPageValue;
      const endIndex = startIndex + itemsPerPageValue;
      const productsToShow = filteredProducts.slice(startIndex, endIndex);
      
      console.log(`üìÑ Renderizando p√°gina ${currentPage}: produtos ${startIndex + 1} a ${endIndex}`);
      
      renderProductsTable(productsToShow);
      updatePagination();
    }
    
    // Fun√ß√£o para atualizar controles de pagina√ß√£o
    function updatePagination() {
      const totalPages = Math.ceil(filteredProducts.length / itemsPerPageValue);
      
      if (pageInfo) {
        pageInfo.textContent = `P√°gina ${currentPage} de ${totalPages}`;
      }
      
      if (prevPage) {
        prevPage.disabled = currentPage <= 1;
      }
      
      if (nextPage) {
        nextPage.disabled = currentPage >= totalPages;
      }
      
      console.log(`üìä Pagina√ß√£o atualizada: p√°gina ${currentPage} de ${totalPages}`);
    }
    
    // Fun√ß√£o para ir para pr√≥xima p√°gina
    function nextPageProducts() {
      const totalPages = Math.ceil(filteredProducts.length / itemsPerPageValue);
      if (currentPage < totalPages) {
        currentPage++;
        renderProductsTablePaginated();
      }
    }
    
    // Fun√ß√£o para ir para p√°gina anterior
    function prevPageProducts() {
      if (currentPage > 1) {
        currentPage--;
        renderProductsTablePaginated();
      }
    }
    
    // Fun√ß√£o para alterar itens por p√°gina
    function changeItemsPerPage() {
      itemsPerPageValue = parseInt(itemsPerPage?.value || 10);
      currentPage = 1;
      console.log(`üìä Itens por p√°gina alterados para: ${itemsPerPageValue}`);
      renderProductsTablePaginated();
    }
    
    // Fun√ß√£o para filtrar categorias
    function filterCategories() {
      const searchTerm = categorySearch?.value?.toLowerCase() || '';
      console.log('üîç Filtrando categorias:', searchTerm);
      
      const filteredCategories = allCategories.filter(category => 
        category.name.toLowerCase().includes(searchTerm) ||
        category.description?.toLowerCase().includes(searchTerm)
      );
      
      renderCategoriesTable(filteredCategories);
      console.log('üìä Categorias filtradas:', filteredCategories.length);
    }
    
    // Fun√ß√£o para filtrar subcategorias
    function filterSubcategories() {
      const searchTerm = subcategorySearch?.value?.toLowerCase() || '';
      const categoryFilter = subcategoryCategoryFilter?.value || '';
      console.log('üîç Filtrando subcategorias:', { searchTerm, categoryFilter });
      
      let filteredSubcategories = allSubcategories;
      
      if (searchTerm) {
        filteredSubcategories = filteredSubcategories.filter(subcategory =>
          subcategory.name.toLowerCase().includes(searchTerm) ||
          subcategory.categoryName?.toLowerCase().includes(searchTerm)
        );
      }
      
      if (categoryFilter) {
        filteredSubcategories = filteredSubcategories.filter(subcategory =>
          subcategory.categoryId === categoryFilter
        );
      }
      
      renderSubcategoriesTable(filteredSubcategories);
      console.log('üìä Subcategorias filtradas:', filteredSubcategories.length);
    }
    
    // Fun√ß√£o para salvar edi√ß√£o de categoria
    async function handleSaveEditCategory() {
      console.log('üíæ Salvando altera√ß√µes da categoria...');
      
      if (!currentEditCategory) {
        console.error('‚ùå Nenhuma categoria selecionada para edi√ß√£o');
        showError('Nenhuma categoria selecionada para edi√ß√£o');
        return;
      }
      
      const name = editCategoryName?.value?.trim();
      const description = editCategoryDescription?.value?.trim();
      
      if (!name) {
        console.error('‚ùå Nome da categoria √© obrigat√≥rio');
        showError('Nome da categoria √© obrigat√≥rio');
        return;
      }
      
      try {
        const updatedCategoryData = {
          name,
          description,
          updatedAt: serverTimestamp()
        };
        
        console.log('üìã Dados para atualizar:', updatedCategoryData);
        
        // Atualizar documento no Firestore
        const categoryDocRef = doc(db, 'loja', 'config', 'categorias', currentEditCategory.id);
        await updateDoc(categoryDocRef, updatedCategoryData);
        
        console.log('‚úÖ Categoria atualizada com sucesso');
        showSuccess('Categoria atualizada com sucesso!');
        
        // Fechar modal e recarregar categorias
        closeEditCategoryModal();
        await loadCategories();
        
      } catch (error) {
        console.error('‚ùå Erro ao atualizar categoria:', error);
        showError('Erro ao atualizar categoria: ' + error.message);
      }
    }
    
    // Fun√ß√£o para salvar edi√ß√£o de subcategoria
    async function handleSaveEditSubcategory() {
      console.log('üíæ Salvando altera√ß√µes da subcategoria...');
      
      if (!currentEditSubcategory) {
        console.error('‚ùå Nenhuma subcategoria selecionada para edi√ß√£o');
        showError('Nenhuma subcategoria selecionada para edi√ß√£o');
        return;
      }
      
      const categoryId = editSubcategoryCategory?.value;
      const name = editSubcategoryName?.value?.trim();
      
      if (!categoryId || !name) {
        console.error('‚ùå Categoria e nome s√£o obrigat√≥rios');
        showError('Categoria e nome s√£o obrigat√≥rios');
        return;
      }
      
      try {
        // Buscar nome da categoria
        const categoryDoc = await getDocs(collection(db, 'loja', 'config', 'categorias'));
        let categoryName = '';
        categoryDoc.forEach(doc => {
          if (doc.id === categoryId) {
            categoryName = doc.data().name;
          }
        });
        
        const updatedSubcategoryData = {
          categoryId,
          categoryName,
          name,
          updatedAt: serverTimestamp()
        };
        
        console.log('üìã Dados para atualizar:', updatedSubcategoryData);
        
        // Atualizar documento no Firestore
        const subcategoryDocRef = doc(db, 'loja', 'config', 'subcategorias', currentEditSubcategory.id);
        await updateDoc(subcategoryDocRef, updatedSubcategoryData);
        
        console.log('‚úÖ Subcategoria atualizada com sucesso');
        showSuccess('Subcategoria atualizada com sucesso!');
        
        // Fechar modal e recarregar subcategorias
        closeEditSubcategoryModal();
        await loadSubcategories();
        
      } catch (error) {
        console.error('‚ùå Erro ao atualizar subcategoria:', error);
        showError('Erro ao atualizar subcategoria: ' + error.message);
      }
    }
    
    console.log('üéØ lojaconfig.html - Script carregado completamente');
  </script>
</body>
</html>
