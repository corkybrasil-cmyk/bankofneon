<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Dashboard • Banco da Neon</title>
  <link rel="icon" href="logotipo.svg" type="image/svg+xml" />
  <style>
    :root {
      --primary: #5a039a;
      --secondary: #b6f902;
      --secondary-700: #8bb601;
      --bg: #f7f7fb;
      --card: #ffffff;
      --text: #1a1a1a;
      --muted: #5d5d6a;
      --border: #e8e8ef;
    }
    *{ box-sizing:border-box; }
    body {
      margin:0; color: var(--text);
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto;
      background:
        radial-gradient(800px 600px at 100% -10%, rgba(90,3,154,0.10), rgba(90,3,154,0.0) 60%),
        var(--bg);
    }
    .header { background: var(--primary); color: #fff; padding: 12px 20px; display: flex; align-items: center; justify-content: space-between; box-shadow: 0 8px 24px rgba(90,3,154,0.25); }
    .brand { display:flex; align-items:center; gap: 12px; }
    .logo-mask { width: 60px; height: 60px; display:block; background-color: #b6f902; -webkit-mask: url('logotipo.svg') center/contain no-repeat; mask: url('logotipo.svg') center/contain no-repeat; }
    .brand a { display: inline-block; line-height: 0; }
    .brand .title { font-weight: 800; letter-spacing: .2px; }
    .nav a { color: #fff; text-decoration: none; padding: 8px 12px; border-radius: 999px; }
    .nav a:hover { background: rgba(255,255,255,0.12); }
    .wrap { max-width: 980px; margin: 0 auto; padding: 20px; }
    .card { background: var(--card); border: 1px solid var(--border); border-radius: 24px; padding: 20px; box-shadow: 0 10px 30px rgba(16, 20, 40, 0.08); }
    .card + .card { margin-top: 16px; }
    #ocorrencias { min-height: 75vh; }
    .row { display:flex; justify-content: space-between; align-items:center; margin-bottom: 16px; }
    a { color: var(--primary); text-decoration:none; }
    .big { font-size: 24px; font-weight: 800; }
    .muted { color: var(--muted); }
    .pill { display:inline-flex; align-items:center; gap:8px; background: linear-gradient(180deg, var(--secondary), var(--secondary-700)); color: #202420; padding: 6px 12px; border-radius: 999px; font-weight: 700; border: 1px solid rgba(0,0,0,0.06); }
    .actions-horizontal { display: flex; flex-wrap: nowrap; gap: 24px; margin-top: 16px; align-items: center; justify-content: space-evenly; flex-direction: row; }
    .action-item { display: flex; flex-direction: column; align-items: center; gap: 12px; }
    .circle-btn { width: 80px; height: 80px; border-radius: 9999px; border: none; background: var(--secondary); display: grid; place-items: center; cursor: pointer; }
    .circle-btn:disabled { opacity: .6; cursor: not-allowed; }
    .mask { -webkit-mask: var(--icon) center/contain no-repeat; mask: var(--icon) center/contain no-repeat; background-color: var(--icon-color, currentColor); width: 42px; height: 42px; display: block; }
    .label { font-weight: 700; font-size: 32px; }
    /* Novo bloco de cabeçalho do cartão */
    .header-block { display: flex; flex-direction: column; gap: 4px; margin-bottom: 8px; }
    .greeting { font-size: 56px; font-weight: 800; }
    .account-label { font-size: 48px; color: var(--muted); font-weight: 800; display: inline-block; white-space: nowrap; line-height: 1; }
    .balance { font-size: 36px; color: var(--muted); font-weight: 800; }
    .account-line { position: relative; display: inline-flex; align-items: baseline; gap: 8px; width: fit-content; }
    .icon-btn { position: static; width: 20px; height: 20px; border: none; background: transparent; padding: 0; cursor: pointer; display: inline-flex; align-items: center; justify-content: center; }
    /* Layout do card principal: Moacir à esquerda (textos+ações) e avatar à direita */
    #cardProfile { display: flex; align-items: flex-start; justify-content: space-between; gap: 20px; }
    #Moacir { flex: 1 1 50%; max-width: 50%; }
    #profileWithButton { position: relative; width: clamp(220px, 90%, 300px); aspect-ratio: 1 / 1; align-self: center; margin-left: auto; }
    /* Avatar + edição */
    .avatar { position: relative; width: 100%; height: 100%; border-radius: 50%; background: var(--primary); border: 8px solid var(--secondary); overflow: hidden; }
    .avatar img { width: 100%; height: 100%; object-fit: cover; display: block; }
    .avatar .placeholder { position: absolute; inset: 0; background: var(--primary); display: grid; place-items: center; }
    .avatar .placeholder img { width: 80%; height: 80%; object-fit: contain; border-radius: 50%; }
    .avatar .spinner { position: absolute; inset: 0; display: grid; place-items: center; }
    .avatar .spinner::after { content: ""; width: 56px; height: 56px; border: 6px solid rgba(0,0,0,0.1); border-top-color: var(--secondary); border-radius: 50%; animation: spin 1s linear infinite; }
    .avatar.hide-photo .placeholder { display: grid; }
    .avatar.hide-photo img { opacity: 0.15; }
    .edit-btn { position: absolute; width: 48px; height: 48px; border-radius: 50%; background: #5a039a; color: #fff; display: grid; place-items: center; border: 1px solid rgba(255,255,255,0.2); cursor: pointer; right: 20px; bottom: 20px }
    .edit-btn .mask { width: 30px; height: 30px; background-color: #fff; --icon: url('lapis.svg'); }
    .tooltip { position: absolute; background: rgba(0,0,0,0.8); color: #fff; font-size: 12px; padding: 6px 8px; border-radius: 6px; white-space: nowrap; opacity: 0; pointer-events: none; right: 0; bottom: 40px; transform: translateY(6px); transition: opacity .15s, transform .15s; }
    .edit-btn:hover + .tooltip, .edit-btn:focus + .tooltip { opacity: 1; transform: translateY(0); }
    .account-label { display: inline-flex; align-items: baseline; gap: 8px; }
    .actions-horizontal { max-width: 50%; }
    /* Modal upload */
    .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.6); display: none; align-items: center; justify-content: center; z-index: 60; }
    .modal { width: min(92vw, 520px); background: var(--card); border: 1px solid var(--border); border-radius: 16px; padding: 16px; box-shadow: 0 20px 50px rgba(0,0,0,0.3); }
    .modal h3 { margin: 0 0 8px 0; }
    .modal .actions { justify-content: flex-end; }
    .preview { width: 160px; height: 160px; border-radius: 50%; overflow: hidden; border: 4px solid var(--secondary); background: var(--primary); margin-bottom: 12px; }
    .preview img { width: 100%; height: 100%; object-fit: cover; display: block; }
  </style>
</head>
<body>
  <div class="header">
    <div class="brand">
      <a href="dashboard.html" title="Início"><span class="logo-mask" aria-label="Neon"></span></a>
    </div>
    <nav class="nav">
      <a href="dev.html">Dev</a>
      <a href="adicionarAluno.html">Adicionar</a>
      <a href="index.html" onclick="localStorage.removeItem('bn.currentUser')">Sair</a>
    </nav>
  </div>
  <div class="wrap">
    <div class="card" id="cardProfile">
      <div id="Moacir">
        <div class="header-block" id="infoConta">
          <div id="saudacao" class="greeting">Olá, ...</div>
          <div class="account-line">
            <div id="robervaldo" class="account-label">Conta</div>
            <button id="btnHide" class="icon-btn" title="Ocultar saldo" aria-label="Ocultar saldo" style="display: inline-block;">
              <span class="mask" style="--icon: url('ocultar.svg'); --icon-color: var(--primary);"></span>
            </button>
            <button id="btnShow" class="icon-btn" title="Mostrar saldo" aria-label="Mostrar saldo" style="display: none;">
              <span class="mask" style="--icon: url('mostrar.svg'); --icon-color: var(--primary);"></span>
            </button>
          </div>
          <div id="saldoLinha" class="balance">N$ ...</div>
        </div>
        <div class="actions-horizontal" id="actionsButtonsBanco">
          <div class="action-item">
            <button id="pixButton" class="circle-btn" title="Pix" aria-label="Pix" onclick="window.location.href='pix.html'">
              <span class="mask" style="--icon: url('pix.svg'); --icon-color: var(--primary);"></span>
            </button>
            <span class="label">Pix</span>
          </div>
          <div class="action-item">
            <button id="extratoButton" class="circle-btn" title="Extrato" aria-label="Extrato">
              <span class="mask" style="--icon: url('extrato.svg'); --icon-color: var(--primary);"></span>
            </button>
            <span class="label">Extrato</span>
          </div>
          <div class="action-item">
            <button id="shopButton" class="circle-btn" title="Loja" aria-label="Loja">
              <span class="mask" style="--icon: url('loja.svg'); --icon-color: var(--primary);"></span>
            </button>
            <span class="label">Loja</span>
          </div>
        </div>
      </div>
      <div id="profileWithButton">
        <div class="avatar" id="avatar">
          <img id="avatarImg" src="" alt="Sua foto" />
          <div id="avatarSpinner" class="spinner"></div>
          <div id="avatarPlaceholder" class="placeholder" style="display:none;"><img src="semfoto.png" alt="Sem foto"/></div>
        </div>
        <div id="editarButton" class="edit-btn" title="Edite ou adicione sua foto" aria-label="Editar foto"><span class="mask"></span></div>
        <div class="tooltip">Edite ou adicione sua foto</div>
      </div>
    </div>
    <div class="card" id="ocorrencias">
      <div class="big">Ocorrências</div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-analytics.js";
    import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";
    import { getFirestore, collection, query, where, limit, getDocs, doc, updateDoc } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";
    import { getStorage, ref, uploadBytes, getDownloadURL, getMetadata, getBytes } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-storage.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBHU6yFDCKp9jm9tPGyRqQJFS3amewuuQY",
      authDomain: "crmdaneon.firebaseapp.com",
      projectId: "crmdaneon",
      storageBucket: "crmdaneon.firebasestorage.app",
      messagingSenderId: "564595832938",
      appId: "1:564595832938:web:16fb660d8d433ae5f3f213",
      measurementId: "G-D3G4M9F17R"
    };

    const DEBUG_UPLOAD = true; // Fácil de desativar/remover depois
    const logU = (...args) => { if (DEBUG_UPLOAD) console.log('[UploadFoto]', ...args); };

    logU('Dashboard carregado');
    const app = initializeApp(firebaseConfig);
    try { getAnalytics(app); } catch {}
    try { await signInAnonymously(getAuth(app)); } catch {}

    let db; try { db = getFirestore(app, "bancodaneondb"); logU('Firestore OK (bancodaneondb)'); } catch { db = getFirestore(app); logU('Firestore fallback (default)'); }
    const storage = getStorage(app, "gs://crmdaneon.firebasestorage.app");
    logU('Storage OK (bucket gs://crmdaneon.firebasestorage.app)');

    const sessRaw = localStorage.getItem("bn.currentUser");
    if (!sessRaw) { window.location.href = "index.html"; }
    let sess = null;
    try { sess = JSON.parse(sessRaw); } catch { sess = null; }
    logU('Sessão encontrada?', !!sess, sess?.user);
    if (!sess || !sess.user) { window.location.href = "index.html"; }

    const $ = (s) => document.querySelector(s);
    const saudacaoEl = $("#saudacao");
    const saldoLinhaEl = $("#saldoLinha");
    const btnHide = $("#btnHide");
    const btnShow = $("#btnShow");
    const btnExtrato = document.getElementById('extratoButton');
    const btnAvatarEdit = document.getElementById('editarButton');
    const avatarImg = document.getElementById('avatarImg');
    let currentDocId = null;

    // Spinner overlay (mantido)
    const spinner = document.createElement('div');
    spinner.id = 'spinner';
    spinner.style.cssText = 'display:flex; position: fixed; inset: 0; background: rgba(0,0,0,0.45); backdrop-filter: blur(2px); align-items:center; justify-content:center;';
    spinner.innerHTML = '<div style="width:56px; height:56px; border:6px solid rgba(255,255,255,0.2); border-top-color:#1ee1a8; border-radius:50%; animation: spin 1s linear infinite;"></div>';
    document.body.appendChild(spinner);
    const style = document.createElement('style'); style.textContent = '@keyframes spin { to { transform: rotate(360deg); } }'; document.head.appendChild(style);

    // Busca dados atualizados do Firestore por segurança
    // Avatar: inicia com spinner por 10s; se resolver a tempo, carrega foto, senão mostra semfoto
    const avatarEl = document.getElementById('avatar');
    const avatarSpinner = document.getElementById('avatarSpinner');
    const avatarPlaceholder = document.getElementById('avatarPlaceholder');
    let avatarResolved = false;
    setTimeout(() => {
      if (!avatarResolved) {
        try { avatarSpinner.style.display = 'none'; } catch {}
        try { avatarPlaceholder.style.display = 'grid'; } catch {}
      }
    }, 10000);
    try {
      spinner.style.display = 'flex';
      const alunosCol = collection(db, "alunos");
      const q = query(alunosCol, where("user", "==", sess.user), limit(1));
      const snap = await getDocs(q);
      if (!snap.empty) {
        const d = snap.docs[0];
        const data = d.data();
        currentDocId = d.id;
        logU('Aluno resolvido', { docId: currentDocId, hasFotoUrl: !!data?.fotoUrl, saldo: data?.saldo });
        const nome = data?.firstName || sess.firstName || sess.user;
        const saldo = data?.saldo ?? sess.saldo ?? 0;
        saudacaoEl.textContent = `Olá, ${nome}`;
        saldoLinhaEl.dataset.raw = String(saldo);
        saldoLinhaEl.textContent = `N$ ${saldo}`;
        if (data?.fotoUrl) {
          avatarImg.onload = () => { try { avatarSpinner.style.display = 'none'; avatarResolved = true; } catch {} };
          avatarImg.src = data.fotoUrl;
        } // se não houver foto, timeout exibirá placeholder após 10s
      } else {
        saudacaoEl.textContent = `Olá, ${sess.firstName || sess.user}`;
        saldoLinhaEl.dataset.raw = String(sess.saldo ?? 0);
        saldoLinhaEl.textContent = `N$ ${sess.saldo ?? 0}`;
      }
    } catch (e) {
      console.error(e);
      saudacaoEl.textContent = `Olá, ${sess.firstName || sess.user}`;
      saldoLinhaEl.dataset.raw = String(sess.saldo ?? 0);
      saldoLinhaEl.textContent = `N$ ${sess.saldo ?? 0}`;
    } finally { spinner.style.display = 'none'; }

    // Alternância de visibilidade do saldo
    function maskSaldo() {
      saldoLinhaEl.textContent = 'N$ …';
    }
    function showSaldo() {
      const raw = saldoLinhaEl.dataset.raw ?? '';
      saldoLinhaEl.textContent = `N$ ${raw}`;
    }
    btnHide?.addEventListener('click', () => {
      btnHide.style.display = 'none';
      btnShow.style.display = 'inline-block';
      maskSaldo();
      try { avatarEl?.classList.add('hide-photo'); avatarPlaceholder && (avatarPlaceholder.style.display = 'grid'); } catch {}
    });
    btnShow?.addEventListener('click', () => {
      btnShow.style.display = 'none';
      btnHide.style.display = 'inline-block';
      showSaldo();
      try { avatarEl?.classList.remove('hide-photo'); avatarPlaceholder && (avatarPlaceholder.style.display = 'none'); } catch {}
    });

    // Navegação para extrato
    btnExtrato?.addEventListener('click', () => { window.location.href = 'extrato.html'; });

    // Modal de upload de foto (Firebase Storage)
    const overlay = document.createElement('div');
    overlay.className = 'modal-overlay';
    overlay.innerHTML = `
      <div class="modal">
        <h3>Editar foto</h3>
        <div class="preview"><img id="previewImg" src="semfoto.png" alt="Prévia"/></div>
        <input id="fileInput" type="file" accept="image/*" />
        <div class="actions" style="margin-top:12px;">
          <button id="btnClose" class="btn secondary">Cancelar</button>
          <button id="btnSave" class="btn">Salvar</button>
        </div>
      </div>
    `;
    document.body.appendChild(overlay);
    const fileInput = overlay.querySelector('#fileInput');
    const previewImg = overlay.querySelector('#previewImg');
    const btnClose = overlay.querySelector('#btnClose');
    const btnSave = overlay.querySelector('#btnSave');

    btnAvatarEdit?.addEventListener('click', () => {
      logU('Abrindo modal de edição de foto');
      previewImg.src = avatarImg.src || 'semfoto.png';
      overlay.style.display = 'flex';
    });
    btnClose?.addEventListener('click', () => { overlay.style.display = 'none'; });
    overlay.addEventListener('click', (e) => { if (e.target === overlay) overlay.style.display = 'none'; });
    fileInput?.addEventListener('change', () => {
      const f = fileInput.files?.[0];
      if (!f) return;
      logU('Arquivo selecionado', { name: f.name, type: f.type, size: f.size });
      const url = URL.createObjectURL(f);
      previewImg.src = url;
    });
    btnSave?.addEventListener('click', async () => {
      try {
        if (!currentDocId) throw new Error('Usuário não resolvido.');
        const f = fileInput.files?.[0];
        if (!f) throw new Error('Selecione uma imagem.');
        // Caminho base: imagemAlunos/{docId}
        const baseRef = ref(storage, `imagemAlunos/${currentDocId}`);
        logU('Iniciando upload', { docId: currentDocId, contentType: f.type, size: f.size });
        // Se já existe uma imagem atual, versiona como {docId}.1/.2/... antes de sobrescrever
        try {
          const meta = await getMetadata(baseRef);
          logU('Imagem base existente. Iniciando versionamento', { contentType: meta?.contentType });
          // Encontrar próximo sufixo disponível
          let n = 1;
          // Tenta até achar um nome livre
          // Atenção: em cenários com muitas versões isso pode custar algumas chamadas
          // mas é adequado para uso leve do app
          // eslint-disable-next-line no-constant-condition
          while (true) {
            const candidateRef = ref(storage, `imagemAlunos/${currentDocId}.${n}`);
            try {
              await getMetadata(candidateRef);
              logU('Sufixo ocupado, tentando próximo', n);
              n++;
            } catch (e) {
              // Não existe -> podemos copiar
              logU('Criando backup em', `${currentDocId}.${n}`);
              const oldBytes = await getBytes(baseRef);
              await uploadBytes(candidateRef, oldBytes, { contentType: meta?.contentType || 'application/octet-stream' });
              logU('Backup criado com sucesso');
              break;
            }
          }
        } catch (e) {
          // Se cair aqui, provavelmente a imagem base ainda não existe -> segue
          logU('Nenhuma imagem anterior encontrada, pulando versionamento');
        }

        // Agora sobrescreve a imagem base com a nova
        logU('Subindo nova imagem para base');
        await uploadBytes(baseRef, f, { contentType: f.type });
        logU('Upload concluído. Obtendo URL pública');
        const url = await getDownloadURL(baseRef);
        await updateDoc(doc(db, 'alunos', currentDocId), { fotoUrl: url });
        logU('fotoUrl atualizada no Firestore', { url });
        avatarImg.src = url;
        overlay.style.display = 'none';
        logU('Processo finalizado com sucesso');
      } catch (e) {
        logU('Erro no upload', e);
        alert(e?.message || String(e));
      }
    });
  </script>
</body>
</html>


