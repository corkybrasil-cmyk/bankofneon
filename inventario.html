<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Meu Invent√°rio ‚Ä¢ Banco da Neon</title>
  <link rel="icon" href="logotipo.svg" type="image/svg+xml" />
  <style>
    :root { 
      --primary:#5a039a; 
      --secondary:#b6f902; 
      --secondary-700:#8bb601; 
      --bg:#f7f7fb; 
      --card:#fff; 
      --text:#1a1a1a; 
      --muted:#5d5d6a; 
      --border:#e8e8ef; 
      --success:#12805a;
      --warning:#f59e0b;
      --danger:#dc2626;
    }
    *{ box-sizing:border-box; }
    html, body{ 
      margin:0; 
      padding: 0;
      color:var(--text); 
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto; 
      background: var(--bg); 
      min-height: 100vh;
    }
    .header{ background:var(--primary); color:#fff; padding:12px 20px; display:flex; align-items:center; justify-content:space-between; box-shadow:0 8px 24px rgba(90,3,154,0.25); }
    #juntinhos { display: flex; align-items: center; gap: 30px; }
    .brand{ display:flex; align-items:center; gap:12px; }
    .logo-mask{ width:48px; height:48px; display:block; background-color:#b6f902; -webkit-mask:url('logotipo.svg') center/contain no-repeat; mask:url('logotipo.svg') center/contain no-repeat; }
    .brand a { display: inline-block; line-height: 0; }
    .header-actions { display: flex; align-items: center; gap: 20px; }
    .menu-btn { width: 30px; height: 30px; padding: 0; background: transparent; border: 0; transition: background-color 0.2s ease; display: flex; align-items: center; justify-content: center; }
    .menu-btn:hover { background: rgba(255,255,255,0.1); }
    .menu-icon { width: 20px; height: 20px; display: block; filter: brightness(0) invert(1); }
    
    /* Menu lateral */
    .sidebar { position: fixed; top: 0; left: -300px; width: 300px; height: 100vh; background: var(--card); border-right: 1px solid var(--border); box-shadow: 4px 0 20px rgba(0,0,0,0.1); transition: left 0.3s ease; z-index: 1000; }
    .sidebar.open { left: 0; }
    .sidebar-header { display: flex; align-items: center; justify-content: space-between; padding: 20px; border-bottom: 1px solid var(--border); }
    .sidebar-header h3 { margin: 0; color: var(--primary); }
    .btn-close { background: none; border: none; font-size: 24px; cursor: pointer; color: var(--muted); }
    .sidebar-nav { padding: 20px 0; }
    .nav-item { display: flex; align-items: center; gap: 12px; padding: 16px 20px; color: var(--text); text-decoration: none; transition: background-color 0.2s; }
    .nav-item:hover { background-color: var(--bg); }
    .nav-item.active { background-color: var(--primary); color: #fff; }
    .nav-icon { font-size: 20px; }
    .sidebar-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); opacity: 0; visibility: hidden; transition: all 0.3s ease; z-index: 999; }
    .sidebar-overlay.open { opacity: 1; visibility: visible; }
    
    .wrap{ max-width:1400px; margin:0 auto; padding:20px; }
    .card{ background:var(--card); border:1px solid var(--border); border-radius:20px; padding:18px; box-shadow:0 10px 30px rgba(16,20,40,0.08); margin-bottom: 20px; }
    h1{ margin:0 0 8px 0; font-size:24px; font-weight:800; }
    p.helper{ margin:0 0 16px 0; color:var(--muted); }
    .btn{ background:var(--primary); color:#fff; border:none; border-radius:9999px; padding:10px 16px; cursor:pointer; font-size: 14px; }
    .btn.secondary{ background:var(--muted); }
    .btn.success{ background:var(--success); }
    .btn.warning{ background:var(--warning); }
    .btn.danger{ background:var(--danger); }
    .btn.small{ padding: 6px 12px; font-size: 12px; }
    .error{ color:var(--danger); min-height:18px; margin-top:6px; }
    .ok{ color:var(--success); min-height:18px; margin-top:6px; }
    
    /* Layout do invent√°rio */
    .inventory-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }
    .inventory-stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
      margin-bottom: 24px;
    }
    .stat-card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 20px;
      text-align: center;
    }
    .stat-number {
      font-size: 32px;
      font-weight: 800;
      color: var(--primary);
      margin-bottom: 8px;
    }
    .stat-label {
      color: var(--muted);
      font-size: 14px;
      font-weight: 600;
    }
    
    /* Filtros */
    .filters {
      display: flex;
      gap: 16px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }
    .filter-group {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    .filter-group label {
      font-size: 12px;
      font-weight: 600;
      color: var(--text);
    }
    .filter-group select,
    .filter-group input {
      padding: 8px 12px;
      border: 1px solid var(--border);
      border-radius: 8px;
      font-size: 14px;
      background: var(--card);
      color: var(--text);
      min-width: 150px;
    }
    
    /* Grid de itens */
    .inventory-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 20px;
      margin-bottom: 20px;
    }
    .inventory-item {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 20px;
      transition: all 0.2s ease;
    }
    .inventory-item:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(16,20,40,0.12);
    }
    .item-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 16px;
    }
    .item-name {
      font-size: 18px;
      font-weight: 700;
      color: var(--text);
      margin: 0;
    }
    .item-category {
      background: var(--primary);
      color: white;
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
    }
    .item-details {
      margin-bottom: 16px;
    }
    .item-detail {
      display: flex;
      justify-content: space-between;
      margin-bottom: 8px;
      font-size: 14px;
    }
    .item-detail:last-child {
      margin-bottom: 0;
    }
    .detail-label {
      color: var(--muted);
      font-weight: 600;
    }
    .detail-value {
      color: var(--text);
      font-weight: 500;
    }
    .item-description {
      color: var(--muted);
      font-size: 14px;
      line-height: 1.5;
      margin-bottom: 16px;
    }
    .item-actions {
      display: flex;
      gap: 12px;
    }
    .btn-item {
      flex: 1;
      padding: 8px 16px;
      font-size: 12px;
    }

    /* Anima√ß√µes de cartas */
    .card-animation-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      z-index: 1000;
      display: flex;
      justify-content: center;
      align-items: center;
    }

    .card-pack {
      position: absolute;
      top: 50%;
      right: -300px;
      transform: translateY(-50%);
      transition: all 1.5s cubic-bezier(0.25, 0.46, 0.45, 0.94);
      width: 180px;
      height: 240px;
    }

    .card-pack img {
      width: 100%;
      height: 100%;
      object-fit: contain;
    }

    .card-pack.slide-in {
      right: 50%;
      transform: translate(50%, -50%);
    }

    .card-pack.rip-animation {
      animation: ripPack 1.2s ease-in-out forwards;
    }

    .card-pack.rip-animation::before {
      content: '';
      position: absolute;
      top: 0;
      right: 0;
      width: 60px;
      height: 60px;
      background: linear-gradient(45deg, transparent 40%, #e74c3c 40%, #e74c3c 60%, transparent 60%);
      animation: slashEffect 0.6s ease-out 0.3s forwards;
      opacity: 0;
    }

    @keyframes ripPack {
      0% { transform: translate(50%, -50%) scale(1) rotate(0deg); }
      20% { transform: translate(50%, -50%) scale(1.05) rotate(-1deg); }
      30% { transform: translate(50%, -50%) scale(1.1) rotate(1deg); }
      60% { transform: translate(50%, -50%) scale(0.95) rotate(-0.5deg); }
      80% { transform: translate(50%, -50%) scale(0.9) rotate(0.5deg); }
      100% { transform: translate(50%, -50%) scale(0.7) rotate(0deg); opacity: 0; }
    }

    @keyframes slashEffect {
      0% { opacity: 0; transform: scale(0) rotate(0deg); }
      50% { opacity: 1; transform: scale(1.2) rotate(45deg); }
      100% { opacity: 1; transform: scale(1) rotate(45deg); }
    }

    .card-confirmation-popup {
      position: absolute;
      top: 65%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: white;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 15px 30px rgba(0, 0, 0, 0.3);
      text-align: center;
      z-index: 1001;
      opacity: 0;
      animation: popupFadeIn 0.5s ease-out forwards;
      min-width: 280px;
    }

    @keyframes popupFadeIn {
      from { opacity: 0; transform: translate(-50%, -50%) scale(0.8); }
      to { opacity: 1; transform: translate(-50%, -50%) scale(1); }
    }

    .popup-content h3 {
      margin: 0 0 12px 0;
      color: var(--primary);
      font-size: 20px;
    }

    .popup-content p {
      margin: 0 0 20px 0;
      color: var(--text);
      font-size: 14px;
    }

    .popup-buttons {
      display: flex;
      gap: 15px;
      justify-content: center;
    }

    .cards-container {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      z-index: 1002;
    }

        .card-item {
      position: absolute;
      width: 120px;
      height: 180px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border-radius: 12px;
      box-shadow: 0 12px 24px rgba(0, 0, 0, 0.3);
      display: flex;
      justify-content: center;
      align-items: center;
      font-size: 36px;
      color: white;
      font-weight: bold;
      opacity: 0;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .card-item:hover {
      transform: scale(1.05);
      box-shadow: 0 16px 32px rgba(0, 0, 0, 0.4);
    }

    .card-item.current {
      opacity: 1;
      z-index: 1003;
    }

    .card-item.hidden {
      opacity: 0;
      z-index: 1002;
    }

    .card-item.fly-out {
      animation: flyOut 1.2s ease-out forwards;
    }

    @keyframes flyOut {
      0% { 
        opacity: 0; 
        transform: translate(-50%, -50%) scale(0.3) rotate(0deg); 
      }
      20% { 
        opacity: 1; 
        transform: translate(-50%, -50%) scale(1) rotate(0deg); 
      }
      100% { 
        opacity: 1; 
        transform: translate(-50%, -50%) scale(1) rotate(0deg); 
      }
    }

    .card-navigation {
      position: absolute;
      bottom: -80px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 1004;
      text-align: center;
    }

    .card-navigation button {
      background: var(--primary);
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 25px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    }

    .card-navigation button:hover {
      background: var(--secondary-700);
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(0, 0, 0, 0.3);
    }
    
    /* Mensagens */
    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: var(--muted);
    }
    .empty-icon {
      font-size: 64px;
      margin-bottom: 16px;
      opacity: 0.5;
    }
    .empty-title {
      font-size: 20px;
      font-weight: 600;
      margin-bottom: 8px;
    }
    .empty-description {
      font-size: 14px;
      margin-bottom: 24px;
    }
    
    /* Responsividade */
    @media (max-width: 768px) {
      .inventory-stats {
        grid-template-columns: 1fr;
      }
      .filters {
        flex-direction: column;
      }
      .filter-group select,
      .filter-group input {
        min-width: 100%;
      }
      .inventory-grid {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <div class="header">
    <div id="juntinhos">
      <div class="brand">
        <a href="dashboard.html" title="In√≠cio"><span class="logo-mask" aria-label="Neon"></span></a>
      </div>
      <button id="btnMenu" class="menu-btn" title="Menu">
        <img src="menu.svg" alt="Menu" class="menu-icon" />
      </button>
    </div>
    <div class="header-actions">
      <a href="dashboard.html" class="btn" style="background:rgba(255,255,255,0.12)">Voltar</a>
    </div>
  </div>

  <!-- Menu lateral -->
  <div id="sidebar" class="sidebar">
    <div class="sidebar-header">
      <h3>Menu</h3>
      <button id="btnCloseSidebar" class="btn-close">&times;</button>
    </div>
    <nav class="sidebar-nav">
      <a href="dashboard.html" class="nav-item">
        <span class="nav-icon">üè†</span>
        Dashboard
      </a>
      <a href="extrato.html" class="nav-item">
        <span class="nav-icon">üìä</span>
        Extrato
      </a>
      <a href="pix.html" class="nav-item">
        <span class="nav-icon">üí∏</span>
        PIX
      </a>
      <a href="loja.html" class="nav-item">
        <span class="nav-icon">üõçÔ∏è</span>
        Loja
      </a>
      <a href="inventario.html" class="nav-item active">
        <span class="nav-icon">üéí</span>
        Meu Invent√°rio
      </a>
      <a href="ocorrencias.html" class="nav-item">
        <span class="nav-icon">‚ö†Ô∏è</span>
        Ocorr√™ncias
      </a>
      <a href="adicionarAluno.html" class="nav-item">
        <span class="nav-icon">üë§</span>
        Adicionar Aluno
      </a>
      <a href="dev.html" class="nav-item">
        <span class="nav-icon">üîß</span>
        Dev
      </a>
    </nav>
  </div>

  <!-- Overlay para fechar o menu -->
  <div id="sidebarOverlay" class="sidebar-overlay"></div>

  <div class="wrap">
    <div id="unauth" class="card" style="display:none; text-align:center;">
      <h1>Acesso n√£o autorizado</h1>
      <p class="helper">Fa√ßa login para acessar seu invent√°rio.</p>
      <a class="btn" href="index.html">Ir para login</a>
    </div>

    <div id="content" style="display:none;">
      <div class="card">
        <div class="inventory-header">
          <div>
            <h1>Meu Invent√°rio</h1>
            <p class="helper">Visualize todos os itens que voc√™ comprou na loja.</p>
          </div>
          <a href="loja.html" class="btn success">üõçÔ∏è Ir para Loja</a>
        </div>
      </div>

      <!-- Estat√≠sticas -->
      <div class="inventory-stats">
        <div class="stat-card">
          <div class="stat-number" id="totalItems">0</div>
          <div class="stat-label">Total de Itens</div>
        </div>
        <div class="stat-card">
          <div class="stat-number" id="totalSpent">N$ 0.00</div>
          <div class="stat-label">Total Gasto</div>
        </div>
        <div class="stat-card">
          <div class="stat-number" id="uniqueCategories">0</div>
          <div class="stat-label">Categorias</div>
        </div>
        <div class="stat-card">
          <div class="stat-number" id="recentPurchases">0</div>
          <div class="stat-label">√öltimos 30 dias</div>
        </div>
      </div>

      <!-- Filtros -->
      <div class="card">
        <div class="filters">
          <div class="filter-group">
            <label for="categoryFilter">Categoria</label>
            <select id="categoryFilter">
              <option value="">Todas as categorias</option>
            </select>
          </div>
          <div class="filter-group">
            <label for="sortBy">Ordenar por</label>
            <select id="sortBy">
              <option value="date">Data de compra</option>
              <option value="name">Nome</option>
              <option value="price">Pre√ßo</option>
              <option value="category">Categoria</option>
            </select>
          </div>
          <div class="filter-group">
            <label for="searchFilter">Buscar</label>
            <input type="text" id="searchFilter" placeholder="Nome do item...">
          </div>
        </div>
      </div>

      <!-- Grid de itens -->
      <div id="inventoryGrid" class="inventory-grid">
        <!-- Itens ser√£o carregados aqui -->
      </div>

      <!-- Estado vazio -->
      <div id="emptyState" class="card empty-state" style="display:none;">
        <div class="empty-icon">üéí</div>
        <div class="empty-title">Seu invent√°rio est√° vazio</div>
        <div class="empty-description">Voc√™ ainda n√£o comprou nenhum item na loja.</div>
        <a href="loja.html" class="btn success">üõçÔ∏è Fazer primeira compra</a>
      </div>

      <div id="msg" class="ok"></div>
      <div id="err" class="error"></div>
    </div>
  </div>

  <!-- Overlay para anima√ß√£o de cartas -->
  <div id="cardAnimationOverlay" class="card-animation-overlay" style="display: none;">
    <!-- Pacote de cartas -->
    <div id="cardPack" class="card-pack">
      <img src="pacotecarta.svg" alt="Pacote de cartas" width="120" height="160">
    </div>
    
    <!-- Popup de confirma√ß√£o -->
    <div id="cardConfirmationPopup" class="card-confirmation-popup" style="display: none;">
      <div class="popup-content">
        <h3>üé¥ Abrir Pacote de Figurinhas</h3>
        <p>Voc√™ deseja abrir este pacote de figurinhas?</p>
        <div class="popup-buttons">
          <button id="btnOpenCards" class="btn success">Sim, abrir!</button>
          <button id="btnCancelCards" class="btn secondary">Cancelar</button>
        </div>
      </div>
    </div>
    
    <!-- Cartas que saem do pacote -->
    <div id="cardsContainer" class="cards-container" style="display: none;">
      <!-- 5 cartas ser√£o criadas dinamicamente -->
      <div class="card-navigation">
        <button id="btnNextCard" style="display: none;">Visualizar a pr√≥xima carta</button>
        <button id="btnCloseCards" style="display: none;">Fechar visualiza√ß√£o</button>
      </div>
    </div>
  </div>

  <script type="module">
    console.log('üöÄ inventario.html - Script iniciando...');
    
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-analytics.js";
    import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";
    import { getFirestore, collection, query, where, orderBy, getDocs, serverTimestamp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

        const firebaseConfig = {
      apiKey: "AIzaSyBHU6yFDCKp9jm9tPGyRqQJFS3amewuuQY",
      authDomain: "crmdaneon.firebaseapp.com",
      projectId: "crmdaneon",
      storageBucket: "crmdaneon.firebasestorage.app",
      messagingSenderId: "564595832938",
      appId: "1:564595832938:web:16fb660d8d433ae5f3f213",
      measurementId: "G-D3G4M9F17R"
    };

    const app = initializeApp(firebaseConfig);
    
    try { getAnalytics(app); } catch {}
    try { await signInAnonymously(getAuth(app)); } catch {}

    const db = (() => { try { return getFirestore(app, 'bancodaneondb'); } catch { return getFirestore(app); } })();
    
    // Elementos da interface
    const unauthEl = document.getElementById('unauth');
    const contentEl = document.getElementById('content');
    const msgEl = document.getElementById('msg');
    const errEl = document.getElementById('err');
    const inventoryGrid = document.getElementById('inventoryGrid');
    const emptyState = document.getElementById('emptyState');
    
    // Estat√≠sticas
    const totalItems = document.getElementById('totalItems');
    const totalSpent = document.getElementById('totalSpent');
    const uniqueCategories = document.getElementById('uniqueCategories');
    const recentPurchases = document.getElementById('recentPurchases');
    
    // Filtros
    const categoryFilter = document.getElementById('categoryFilter');
    const sortBy = document.getElementById('sortBy');
    const searchFilter = document.getElementById('searchFilter');
    
    // Controles do menu
    const btnMenu = document.getElementById('btnMenu');
    const sidebar = document.getElementById('sidebar');
    const sidebarOverlay = document.getElementById('sidebarOverlay');
    const btnCloseSidebar = document.getElementById('btnCloseSidebar');

    // Verifica√ß√£o de sess√£o
    const sessRaw = localStorage.getItem('bn.currentUser');
    
    let sess = null;
    try { 
      sess = JSON.parse(sessRaw); 
    } catch (error) { 
      console.error('‚ùå Erro ao fazer parse da sess√£o:', error);
      sess = null; 
    }
    
    // Vari√°vel global para armazenar os itens do invent√°rio
    let purchases = [];
    
    // Vari√°vel global para controle das cartas
    let currentCardIndex = 0;

    if (!sess || !sess.user) {
      if (unauthEl) {
        unauthEl.style.display = 'block';
      } else {
        console.error('‚ùå Elemento unauth n√£o encontrado!');
      }
    } else {
      if (contentEl) {
        contentEl.style.display = 'block';
        initializeInventario();
      } else {
        console.error('‚ùå Elemento content n√£o encontrado!');
      }
    }

    // Inicializa√ß√£o da aplica√ß√£o
    async function initializeInventario() {
      try {
        setupEventListeners();
        setupMenuControls();
        await loadInventory();
        
        // Verificar se os elementos de anima√ß√£o est√£o presentes
        console.log('üîç Verificando elementos de anima√ß√£o na inicializa√ß√£o...');
        const overlay = document.getElementById('cardAnimationOverlay');
        const cardPack = document.getElementById('cardPack');
        const popup = document.getElementById('cardConfirmationPopup');
        const cardsContainer = document.getElementById('cardsContainer');
        
        console.log('üì± Overlay de anima√ß√£o:', !!overlay);
        console.log('üì¶ Pacote de cartas:', !!cardPack);
        console.log('üí¨ Popup de confirma√ß√£o:', !!popup);
        console.log('üÉè Container de cartas:', !!cardsContainer);
        
        if (!overlay || !cardPack || !popup || !cardsContainer) {
          console.error('‚ùå Alguns elementos de anima√ß√£o n√£o foram encontrados!');
        } else {
          console.log('‚úÖ Todos os elementos de anima√ß√£o est√£o presentes');
        }
        
      } catch (error) {
        console.error('‚ùå Erro na inicializa√ß√£o:', error);
        showError('Erro ao inicializar aplica√ß√£o: ' + error.message);
      }
    }

    // Configura√ß√£o dos controles do menu
    function setupMenuControls() {
      if (btnMenu && sidebar && sidebarOverlay) {
        btnMenu.addEventListener('click', () => {
          sidebar.classList.add('open');
          sidebarOverlay.classList.add('open');
        });
      }

      if (btnCloseSidebar && sidebar && sidebarOverlay) {
        btnCloseSidebar.addEventListener('click', () => {
          sidebar.classList.remove('open');
          sidebarOverlay.classList.remove('open');
        });
      }

      if (sidebarOverlay && sidebar) {
        sidebarOverlay.addEventListener('click', () => {
          sidebar.classList.remove('open');
          sidebarOverlay.classList.remove('open');
        });
      }
    }

    // Configura√ß√£o dos event listeners
    function setupEventListeners() {
      if (categoryFilter) {
        categoryFilter.addEventListener('change', () => {
          filterInventory();
        });
      }
      
      if (sortBy) {
        sortBy.addEventListener('change', () => {
          filterInventory();
        });
      }
      
      if (searchFilter) {
        searchFilter.addEventListener('input', () => {
          filterInventory();
        });
      }
    }

    // Carregar invent√°rio
    async function loadInventory() {

      
      try {
        // Primeiro, precisamos encontrar o docId do usu√°rio na cole√ß√£o 'alunos'

        const alunosCol = collection(db, 'alunos');
        const userQuery = query(alunosCol, where('user', '==', sess.user));
        const userSnap = await getDocs(userQuery);
        
        if (userSnap.empty) {

          showError('Usu√°rio n√£o encontrado');
          return;
        }
        
        const userDoc = userSnap.docs[0];
        const userDocId = userDoc.id;
        
        // Agora buscar itens do invent√°rio usando o docId correto
        const inventarioCol = collection(db, 'inventario', userDocId, 'inventarioAluno');
        
        // Buscar todos os documentos (sem filtros) para debug
        try {
          const allDocsSnap = await getDocs(inventarioCol);
          if (allDocsSnap.size > 0) {

          }
        } catch (testError) {
          console.error('‚ùå Erro ao buscar sem filtros:', testError);
        }
        
        // Buscar apenas itens ativos
        const q = query(
          inventarioCol,
          where('status', '==', 'active')
        );
        
        const snap = await getDocs(q);

        
        // Processar itens do invent√°rio
        purchases.length = 0; // Limpar array global
        
        snap.forEach((doc, index) => {
          const data = doc.data();
          purchases.push({
            id: doc.id,
            productName: data.productName,
            price: data.price,
            quantity: data.quantity || 1,
            category: data.category || 'Geral',
            subcategory: data.subcategory || '',
            description: data.description || 'Item do invent√°rio',
            firstPurchaseDate: data.firstPurchaseDate,
            lastPurchaseDate: data.lastPurchaseDate,
            totalSpent: data.totalSpent || data.price,
            dateTime: data.lastPurchaseDate // Para compatibilidade com o c√≥digo existente
          });
        });
        

        
        // Ordenar por data de compra (mais recente primeiro)
        purchases.sort((a, b) => {
          if (a.lastPurchaseDate && b.lastPurchaseDate) {
            if (a.lastPurchaseDate.toDate && b.lastPurchaseDate.toDate) {
              return b.lastPurchaseDate.toDate() - a.lastPurchaseDate.toDate();
            }
            return new Date(b.lastPurchaseDate) - new Date(a.lastPurchaseDate);
          }
          return 0;
        });
        
        // Atualizar estat√≠sticas
        updateStats(purchases);
        
        // Renderizar invent√°rio
        renderInventory(purchases);
        
        // Preencher filtros
        populateFilters(purchases);
      
        
      } catch (error) {
        console.error('üí• ===== ERRO AO CARREGAR INVENT√ÅRIO =====');
        console.error('‚ùå Erro completo:', error);
        console.error('üìù Mensagem de erro:', error.message);
        console.error('üîç Stack trace:', error.stack);
        console.error('üìÅ Collection tentada: inventario/' + (userDocId || 'N/A') + '/inventarioAluno');
        showError('Erro ao carregar invent√°rio: ' + error.message);
      }
    }



    // Atualizar estat√≠sticas
    function updateStats(purchases) {
      if (totalItems) {
        // Contar total de itens (quantidade de produtos √∫nicos √ó quantidade de cada produto)
        const totalItemsCount = purchases.reduce((sum, item) => sum + (item.quantity || 1), 0);
        totalItems.textContent = totalItemsCount;
      }
      
      if (totalSpent) {
        const total = purchases.reduce((sum, item) => sum + (item.totalSpent || 0), 0);
        totalSpent.textContent = `N$ ${total.toFixed(2)}`;

      }
      
      if (uniqueCategories) {
        const categories = new Set(purchases.map(item => item.category));
        uniqueCategories.textContent = categories.size;
        
      }
      
      if (recentPurchases) {
        const thirtyDaysAgo = new Date();
        thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
        
        const recent = purchases.filter(item => {
          if (item.lastPurchaseDate && item.lastPurchaseDate.toDate) {
            return item.lastPurchaseDate.toDate() > thirtyDaysAgo;
          }
          return false;
        });
        
        // Contar total de itens comprados nos √∫ltimos 30 dias (considerando quantidades)
        const recentItemsCount = recent.reduce((sum, item) => sum + (item.quantity || 1), 0);
        recentPurchases.textContent = recentItemsCount;
        
      }
      
    }

    // Renderizar invent√°rio
    function renderInventory(purchases) {
      if (!inventoryGrid) {
        console.error('‚ùå Elemento inventoryGrid n√£o encontrado no DOM');
        return;
      }
      
      if (purchases.length === 0) {
        inventoryGrid.style.display = 'none';
        if (emptyState) {
          emptyState.style.display = 'block';
        } else {
          console.error('‚ùå Elemento emptyState n√£o encontrado');
        }
        return;
      }
      
      // Limpar grid
      inventoryGrid.innerHTML = '';
      inventoryGrid.style.display = 'grid';
      if (emptyState) {
        emptyState.style.display = 'none';
      }
      
      // Renderizar cada item
      purchases.forEach((item, index) => {
        const itemElement = document.createElement('div');
        itemElement.className = 'inventory-item';
        
        const purchaseDate = item.lastPurchaseDate && item.lastPurchaseDate.toDate ? 
          item.lastPurchaseDate.toDate().toLocaleDateString('pt-BR') : 
          'Data n√£o dispon√≠vel';
        
        const itemHTML = `
          <div class="item-header">
            <h3 class="item-name">${item.productName}</h3>
            <span class="item-category">${item.category}</span>
          </div>
          <div class="item-details">
            <div class="item-detail">
              <span class="detail-label">Pre√ßo unit√°rio:</span>
              <span class="detail-value">N$ ${(item.price || 0).toFixed(2)}</span>
            </div>
            <div class="item-detail">
              <span class="detail-label">Quantidade:</span>
              <span class="detail-value">${item.quantity || 1}</span>
            </div>
            <div class="item-detail">
              <span class="detail-label">Total gasto:</span>
              <span class="detail-value">N$ ${(item.totalSpent || 0).toFixed(2)}</span>
            </div>
            <div class="item-detail">
              <span class="detail-label">√öltima compra:</span>
              <span class="detail-value">${purchaseDate}</span>
            </div>
          </div>
          <div class="item-description">${item.description}</div>
          <div class="item-actions">
            <button class="btn btn-item secondary" onclick="viewDetails('${item.id}')">üìã Detalhes</button>
            <button class="btn btn-item success" onclick="useItem('${item.id}')" data-subcategory="${item.subcategory || ''}">üéØ Usar</button>
          </div>
        `;
        
        itemElement.innerHTML = itemHTML;
        inventoryGrid.appendChild(itemElement);
      });
      
    }

    // Preencher filtros
    function populateFilters(purchases) {
      if (categoryFilter) {
        const categories = ['Todas as categorias'];
        const uniqueCats = new Set(purchases.map(item => item.category));
        
        uniqueCats.forEach(cat => categories.push(cat));
        
        categoryFilter.innerHTML = categories.map(cat => 
          `<option value="${cat === 'Todas as categorias' ? '' : cat}">${cat}</option>`
        ).join('');
      } else {
        console.error('‚ùå Elemento categoryFilter n√£o encontrado');
      }
    }

    // Filtrar invent√°rio
    function filterInventory() {
      // Implementar l√≥gica de filtros aqui
      // Por enquanto, apenas recarregar
      loadInventory();
    }

    // Fun√ß√µes globais para os bot√µes de a√ß√£o
    window.viewDetails = function(id) {
      showSuccess('Funcionalidade de detalhes em desenvolvimento');
    };

    window.useItem = function(id) {
      console.log('üé¥ Fun√ß√£o useItem chamada para ID:', id);
      
      // Encontrar o item no invent√°rio
      const item = purchases.find(p => p.id === id);
      if (!item) {
        console.error('‚ùå Item n√£o encontrado no invent√°rio');
        showError('Item n√£o encontrado');
        return;
      }
      
      console.log('üì¶ Item encontrado:', item);
      console.log('üè∑Ô∏è Subcategoria do item:', item.subcategory);
      
      // Verificar se √© uma carta (case-insensitive)
      if (item.subcategory && item.subcategory.toLowerCase().includes('carta')) {
        console.log('‚úÖ Item √© uma carta! Iniciando anima√ß√£o...');
        startCardAnimation(item);
      } else {
        console.log('‚ÑπÔ∏è Item n√£o √© uma carta, usando comportamento padr√£o');
        showSuccess('Item usado com sucesso!');
      }
    };

    // Fun√ß√µes auxiliares
    function showSuccess(message) {
      console.log('‚úÖ Sucesso:', message);
      if (msgEl) {
        msgEl.textContent = message;
        msgEl.style.display = 'block';
        if (errEl) errEl.style.display = 'none';
        setTimeout(() => {
          msgEl.style.display = 'none';
        }, 3000);
      }
    }

    function showError(message) {
      console.error('‚ùå Erro:', message);
      if (errEl) {
        errEl.textContent = message;
        errEl.style.display = 'block';
        if (msgEl) msgEl.style.display = 'none';
        setTimeout(() => {
          errEl.style.display = 'none';
        }, 5000);
      }
    }

    // Fun√ß√µes de anima√ß√£o de cartas
    function startCardAnimation(item) {
      console.log('üöÄ Iniciando anima√ß√£o de cartas para:', item.productName);
      console.log('üîç Verificando elementos DOM...');
      
      const overlay = document.getElementById('cardAnimationOverlay');
      const cardPack = document.getElementById('cardPack');
      
      console.log('üì± Overlay encontrado:', !!overlay);
      console.log('üì¶ CardPack encontrado:', !!cardPack);
      
      if (!overlay || !cardPack) {
        console.error('‚ùå Elementos de anima√ß√£o n√£o encontrados');
        console.error('‚ùå Overlay:', overlay);
        console.error('‚ùå CardPack:', cardPack);
        
        // Tentar encontrar elementos novamente
        console.log('üîÑ Tentando encontrar elementos novamente...');
        const allElements = document.querySelectorAll('*');
        console.log('üìä Total de elementos no DOM:', allElements.length);
        
        const overlayElements = document.querySelectorAll('[id*="card"]');
        console.log('üîç Elementos com ID contendo "card":', overlayElements);
        
        // Verificar se o HTML est√° presente
        const bodyHTML = document.body.innerHTML;
        const hasOverlay = bodyHTML.includes('cardAnimationOverlay');
        const hasCardPack = bodyHTML.includes('cardPack');
        console.log('üîç HTML cont√©m overlay:', hasOverlay);
        console.log('üîç HTML cont√©m cardPack:', hasCardPack);
        
        return;
      }
      
      // Mostrar overlay
      overlay.style.display = 'flex';
      console.log('üì± Overlay de anima√ß√£o exibido');
      
      // Iniciar anima√ß√£o de deslizamento
      setTimeout(() => {
        cardPack.classList.add('slide-in');
        console.log('üì¶ Pacote de cartas deslizando para o centro');
        
        // Mostrar popup de confirma√ß√£o ap√≥s o deslizamento
        setTimeout(() => {
          showCardConfirmationPopup();
        }, 1500);
      }, 100);
    }

    function showCardConfirmationPopup() {
      console.log('üí¨ Exibindo popup de confirma√ß√£o');
      
      const popup = document.getElementById('cardConfirmationPopup');
      if (!popup) {
        console.error('‚ùå Popup de confirma√ß√£o n√£o encontrado');
        return;
      }
      
      popup.style.display = 'block';
      
      // Configurar event listeners
      const btnOpen = document.getElementById('btnOpenCards');
      const btnCancel = document.getElementById('btnCancelCards');
      
      if (btnOpen) {
        btnOpen.onclick = () => {
          console.log('‚úÖ Usu√°rio confirmou abertura do pacote');
          openCardPack();
        };
      }
      
      if (btnCancel) {
        btnCancel.onclick = () => {
          console.log('‚ùå Usu√°rio cancelou abertura do pacote');
          closeCardAnimation();
        };
      }
    }

    function openCardPack() {
      console.log('üé¥ Iniciando abertura do pacote de cartas');
      
      const popup = document.getElementById('cardConfirmationPopup');
      const cardPack = document.getElementById('cardPack');
      
      // Esconder popup
      if (popup) popup.style.display = 'none';
      
      // Iniciar anima√ß√£o de rasgar
      if (cardPack) {
        cardPack.classList.add('rip-animation');
        console.log('‚úÇÔ∏è Anima√ß√£o de rasgar iniciada');
        
        // Ap√≥s a anima√ß√£o de rasgar, mostrar as cartas
        setTimeout(() => {
          showFlyingCards();
        }, 1200);
      }
    }

    function showFlyingCards() {
      console.log('üÉè Exibindo cartas sequencialmente');
      
      const cardsContainer = document.getElementById('cardsContainer');
      if (!cardsContainer) {
        console.error('‚ùå Container de cartas n√£o encontrado');
        return;
      }
      
      cardsContainer.style.display = 'block';
      cardsContainer.innerHTML = '';
      
      // Recriar o container de navega√ß√£o
      const navigationDiv = document.createElement('div');
      navigationDiv.className = 'card-navigation';
      navigationDiv.innerHTML = `
        <button id="btnNextCard">Visualizar a pr√≥xima carta</button>
        <button id="btnCloseCards" style="display: none;">Fechar visualiza√ß√£o</button>
      `;
      cardsContainer.appendChild(navigationDiv);
      
      // Criar 5 cartas empilhadas
      const cardSymbols = ['‚ô†Ô∏è', '‚ô•Ô∏è', '‚ô£Ô∏è', '‚ô¶Ô∏è', 'üÉè'];
      let currentCardIndex = 0;
      
      for (let i = 0; i < 5; i++) {
        const card = document.createElement('div');
        card.className = 'card-item';
        card.textContent = cardSymbols[i];
        card.dataset.index = i;
        
        // Todas as cartas come√ßam empilhadas no centro
        card.style.transform = 'translate(-50%, -50%)';
        
        if (i === 0) {
          card.classList.add('current');
        } else {
          card.classList.add('hidden');
        }
        
        cardsContainer.appendChild(card);
      }
      
      // Configurar navega√ß√£o
      const btnNext = document.getElementById('btnNextCard');
      const btnClose = document.getElementById('btnCloseCards');
      
      if (btnNext) {
        btnNext.onclick = () => {
          showNextCard();
        };
      }
      
      if (btnClose) {
        btnClose.onclick = () => {
          closeCardAnimation();
        };
      }
      
      console.log('üéâ Cartas criadas e empilhadas, mostrando primeira carta');
    }

    function showNextCard() {
      console.log('üîÑ Mostrando pr√≥xima carta');
      
      const cards = document.querySelectorAll('.card-item');
      const btnNext = document.getElementById('btnNextCard');
      const btnClose = document.getElementById('btnCloseCards');
      
      if (!cards || cards.length === 0) return;
      
      // Esconder carta atual
      const currentCard = cards[currentCardIndex];
      if (currentCard) {
        currentCard.classList.remove('current');
        currentCard.classList.add('hidden');
      }
      
      // Mostrar pr√≥xima carta
      currentCardIndex++;
      
      if (currentCardIndex < cards.length) {
        const nextCard = cards[currentCardIndex];
        if (nextCard) {
          nextCard.classList.remove('hidden');
          nextCard.classList.add('current');
          console.log(`üÉè Mostrando carta ${currentCardIndex + 1} de ${cards.length}`);
        }
        
        // Se for a pen√∫ltima carta, mostrar bot√£o de fechar
        if (currentCardIndex === cards.length - 1) {
          if (btnNext) btnNext.style.display = 'none';
          if (btnClose) btnClose.style.display = 'inline-block';
        }
      } else {
        // √öltima carta, fechar anima√ß√£o
        closeCardAnimation();
      }
    }

    function closeCardAnimation() {
      console.log('üîö Fechando anima√ß√£o de cartas');
      
      const overlay = document.getElementById('cardAnimationOverlay');
      const cardPack = document.getElementById('cardPack');
      const popup = document.getElementById('cardConfirmationPopup');
      const cardsContainer = document.getElementById('cardsContainer');
      
      // Resetar classes
      if (cardPack) {
        cardPack.classList.remove('slide-in', 'rip-animation');
      }
      
      // Esconder elementos
      if (popup) popup.style.display = 'none';
      if (cardsContainer) cardsContainer.style.display = 'none';
      if (overlay) overlay.style.display = 'none';
      
      // Resetar √≠ndice das cartas
      currentCardIndex = 0;
      
      console.log('‚úÖ Anima√ß√£o de cartas fechada com sucesso');
    }
    
  </script>
</body>
</html>
