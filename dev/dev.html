<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Dev Tools ‚Ä¢ Banco da Neon</title>
  <link rel="icon" href="../assets/logotipo.svg" type="image/svg+xml" />
  <style>
    :root {
      --primary: #5a039a;
      --secondary: #b6f902;
      --secondary-700: #8bb601;
      --bg: #f7f7fb;
      --card: #ffffff;
      --text: #1a1a1a;
      --muted: #5d5d6a;
      --border: #e8e8ef;
      --success: #28a745;
      --warning: #ffc107;
      --danger: #dc3545;
      --info: #17a2b8;
    }
    
    * { box-sizing: border-box; }
    
    body {
      margin: 0;
      color: var(--text);
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto;
      background:
        radial-gradient(800px 600px at 100% -10%, rgba(90,3,154,0.10), rgba(90,3,154,0.0) 60%),
        var(--bg);
      line-height: 1.6;
    }
    
    .wrap {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }
    
    .page-title {
      font-size: 32px;
      font-weight: 800;
      margin-bottom: 24px;
      color: var(--primary);
    }
    
    .card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 24px;
      padding: 24px;
      margin-bottom: 24px;
      box-shadow: 0 10px 30px rgba(16, 20, 40, 0.08);
    }
    
    .card h2 {
      margin: 0 0 16px 0;
      font-size: 24px;
      font-weight: 700;
      color: var(--primary);
    }
    
    .card h3 {
      margin: 16px 0 8px 0;
      font-size: 18px;
      font-weight: 600;
      color: var(--text);
    }
    
    .constants-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 16px;
      margin-bottom: 24px;
    }
    
    .constant-item {
      padding: 16px;
      border: 1px solid var(--border);
      border-radius: 12px;
      background: rgba(90, 3, 154, 0.02);
    }
    
    .constant-label {
      font-weight: 600;
      color: var(--primary);
      margin-bottom: 4px;
    }
    
    .constant-value {
      font-family: 'Courier New', monospace;
      font-size: 14px;
      color: var(--muted);
      word-break: break-all;
    }
    
    .btn {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 12px 24px;
      border: none;
      border-radius: 12px;
      font-weight: 600;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.2s ease;
      text-decoration: none;
      margin: 4px;
    }
    
    .btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }
    
    .btn-primary {
      background: var(--primary);
      color: white;
    }
    
    .btn-primary:hover:not(:disabled) {
      background: #4a0380;
      transform: translateY(-1px);
    }
    
    .btn-success {
      background: var(--success);
      color: white;
    }
    
    .btn-success:hover:not(:disabled) {
      background: #218838;
      transform: translateY(-1px);
    }
    
    .btn-warning {
      background: var(--warning);
      color: #212529;
    }
    
    .btn-warning:hover:not(:disabled) {
      background: #e0a800;
      transform: translateY(-1px);
    }
    
    .btn-danger {
      background: var(--danger);
      color: white;
    }
    
    .btn-danger:hover:not(:disabled) {
      background: #c82333;
      transform: translateY(-1px);
    }
    
    .btn-info {
      background: var(--info);
      color: white;
    }
    
    .btn-info:hover:not(:disabled) {
      background: #138496;
      transform: translateY(-1px);
    }
    
    .btn-large {
      padding: 16px 32px;
      font-size: 16px;
      border-radius: 16px;
    }
    
    .console-log {
      background: #1e1e1e;
      color: #d4d4d4;
      padding: 16px;
      border-radius: 8px;
      font-family: 'Courier New', monospace;
      font-size: 12px;
      line-height: 1.4;
      margin: 16px 0;
      max-height: 300px;
      overflow-y: auto;
      white-space: pre-wrap;
      word-break: break-word;
    }
    
    .status-indicator {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 8px 12px;
      border-radius: 6px;
      font-size: 14px;
      font-weight: 600;
      margin: 4px;
    }
    
    .status-success {
      background: rgba(40, 167, 69, 0.1);
      color: var(--success);
      border: 1px solid rgba(40, 167, 69, 0.2);
    }
    
    .status-error {
      background: rgba(220, 53, 69, 0.1);
      color: var(--danger);
      border: 1px solid rgba(220, 53, 69, 0.2);
    }
    
    .status-warning {
      background: rgba(255, 193, 7, 0.1);
      color: #856404;
      border: 1px solid rgba(255, 193, 7, 0.2);
    }
    
    .status-info {
      background: rgba(23, 162, 184, 0.1);
      color: var(--info);
      border: 1px solid rgba(23, 162, 184, 0.2);
    }
    
    .loading {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      font-weight: 600;
      color: var(--primary);
    }
    
    .spinner {
      width: 16px;
      height: 16px;
      border: 2px solid rgba(90, 3, 154, 0.2);
      border-top-color: var(--primary);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    .grid-2 {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 24px;
    }
    
    @media (max-width: 768px) {
      .grid-2 {
        grid-template-columns: 1fr;
      }
      
      .constants-grid {
        grid-template-columns: 1fr;
      }
    }
    
    .progress-bar {
      width: 100%;
      height: 8px;
      background: var(--border);
      border-radius: 4px;
      overflow: hidden;
      margin: 8px 0;
    }
    
    .progress-fill {
      height: 100%;
      background: var(--primary);
      transition: width 0.3s ease;
    }
  </style>
</head>
<body>
  <div id="header-container"></div>
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      fetch('../components/header.html')
        .then(res => res.text())
        .then(html => {
          document.getElementById('header-container').innerHTML = html;
          // Ap√≥s inserir o header, carrega o JS do menu
          const script = document.createElement('script');
          script.src = '../components/header-menu.js';
          document.body.appendChild(script);
        });
    });
  </script>

  <div class="wrap">
    <h1 class="page-title">üõ†Ô∏è Dev Tools & Debug</h1>
    
    <!-- Status do Firebase -->
    <div class="card">
      <h2>üî• Firebase Status</h2>
      <div id="firebase-status">
        <div class="loading">
          <div class="spinner"></div>
          Inicializando Firebase...
        </div>
      </div>
      <div id="console-firebase" class="console-log" style="display: none;"></div>
    </div>
    
    <!-- Constantes do Sistema -->
    <div class="card">
      <h2>‚öôÔ∏è Constantes do Sistema</h2>
      <div class="constants-grid">
        <div class="constant-item">
          <div class="constant-label">Firebase Config</div>
          <div class="constant-value" id="firebase-config-display">Carregando...</div>
        </div>
        <div class="constant-item">
          <div class="constant-label">Database Name</div>
          <div class="constant-value" id="database-name">bancodaneondb</div>
        </div>
        <div class="constant-item">
          <div class="constant-label">Storage Bucket</div>
          <div class="constant-value" id="storage-bucket">crmdaneon.firebasestorage.app</div>
        </div>
        <div class="constant-item">
          <div class="constant-label">Cole√ß√µes Principais</div>
          <div class="constant-value">alunos, inventario, loja</div>
        </div>
        <div class="constant-item">
          <div class="constant-label">Cards Collection Path</div>
          <div class="constant-value">loja/config/produtos</div>
        </div>
        <div class="constant-item">
          <div class="constant-label">Pack Probabilities</div>
          <div class="constant-value">loja/config/packOpeningConfig/probabilidades</div>
        </div>
      </div>
    </div>
    
    <!-- Setup Inicial -->
    <div class="card">
      <h2>‚öôÔ∏è Setup Inicial</h2>
      <p>Configure as categorias e subcategorias necess√°rias para o sistema de cartas.</p>
      
      <button id="btn-setup-categories" class="btn btn-warning">
        üìã Configurar Categorias e Subcategorias
      </button>
      
      <div id="setup-status" style="margin: 16px 0;">
        <div class="status-info">
          ‚ÑπÔ∏è Clique para configurar as categorias b√°sicas do sistema
        </div>
      </div>
      
      <div id="console-setup" class="console-log" style="display: none;"></div>
    </div>
    
    <!-- Populador de Cartas -->
    <div class="card">
      <h2>üÉè Populador de Cartas</h2>
      <p>Este bot√£o ir√° popular o banco de dados com cartas para teste do sistema de abertura de packs.</p>
      <p><strong>‚ö†Ô∏è Execute primeiro o setup das categorias acima!</strong></p>
      
      <h3>üìä Cartas que ser√£o criadas:</h3>
      <div class="constants-grid">
        <div class="constant-item">
          <div class="constant-label">üü´ Cartas Comuns</div>
          <div class="constant-value">40 cartas</div>
        </div>
        <div class="constant-item">
          <div class="constant-label">üîµ Cartas Raras</div>
          <div class="constant-value">10 cartas</div>
        </div>
        <div class="constant-item">
          <div class="constant-label">üü£ Cartas √âpicas</div>
          <div class="constant-value">3 cartas</div>
        </div>
        <div class="constant-item">
          <div class="constant-label">üü† Cartas Lend√°rias</div>
          <div class="constant-value">1 carta</div>
        </div>
      </div>
      
      <div id="populate-status" style="margin: 16px 0;">
        <div class="status-info">
          ‚ÑπÔ∏è Pronto para popular o banco de dados
        </div>
      </div>
      
      <div id="populate-progress" style="display: none;">
        <div class="progress-bar">
          <div id="progress-fill" class="progress-fill" style="width: 0%;"></div>
        </div>
        <div id="progress-text">0 / 54 cartas criadas</div>
      </div>
      
      <button id="btn-populate" class="btn btn-primary btn-large">
        üéØ Popular Banco com Cartas de Teste
      </button>
      
      <div id="console-populate" class="console-log" style="display: none;"></div>
    </div>
    
    <!-- Debug Tools -->
    <div class="grid-2">
      <div class="card">
        <h2>üîç Debug Tools</h2>
        
        <h3>Database Queries</h3>
        <button id="btn-check-collections" class="btn btn-info">
          üìÇ Verificar Cole√ß√µes
        </button>
        <button id="btn-check-cards" class="btn btn-info">
          üÉè Verificar Cartas Existentes
        </button>
        <button id="btn-debug-cards-detailed" class="btn btn-info">
          üîç Debug Detalhado das Cartas
        </button>
        <button id="btn-check-categories" class="btn btn-info">
          üìã Verificar Categorias
        </button>
        
        <h3>Pack System Tests</h3>
        <button id="btn-test-pack-creation" class="btn btn-success">
          üì¶ Criar Pack de Teste no Invent√°rio
        </button>
        <button id="btn-test-pack-probabilities" class="btn btn-success">
          üé≤ Testar Probabilidades de Pack
        </button>
        <button id="btn-fix-missing-commons" class="btn btn-warning">
          üîß Fix: Criar Cartas Comuns Faltantes
        </button>
        
        <h3>Limpeza</h3>
        <button id="btn-clear-cards" class="btn btn-danger">
          üóëÔ∏è Limpar Cartas de Teste
        </button>
        
        <div id="console-debug" class="console-log" style="display: none;"></div>
      </div>
      
      <div class="card">
        <h2>üìä Estat√≠sticas</h2>
        <div id="stats-container">
          <div class="loading">
            <div class="spinner"></div>
            Carregando estat√≠sticas...
          </div>
        </div>
        
        <h3>Actions</h3>
        <button id="btn-refresh-stats" class="btn btn-warning">
          üîÑ Atualizar Estat√≠sticas
        </button>
        <button id="btn-export-logs" class="btn btn-success">
          üì• Exportar Logs
        </button>
      </div>
    </div>
  </div>

  <script type="module">
    // Console log personalizado para capturar todas as mensagens
    const originalLog = console.log;
    const originalError = console.error;
    const originalWarn = console.warn;
    
    let allLogs = [];
    
    function captureLog(type, ...args) {
      const timestamp = new Date().toLocaleTimeString();
      const message = args.map(arg => typeof arg === 'object' ? JSON.stringify(arg, null, 2) : String(arg)).join(' ');
      allLogs.push(`[${timestamp}] [${type.toUpperCase()}] ${message}`);
      
      // Tamb√©m chama o console original
      if (type === 'log') originalLog(...args);
      else if (type === 'error') originalError(...args);
      else if (type === 'warn') originalWarn(...args);
    }
    
    console.log = (...args) => captureLog('log', ...args);
    console.error = (...args) => captureLog('error', ...args);
    console.warn = (...args) => captureLog('warn', ...args);
    
    // In√≠cio do script
    console.log('üöÄ [DEV-TOOLS] Iniciando p√°gina de desenvolvimento');
    console.log('üîß [DEV-TOOLS] Configurando captura de logs');
    
    // Imports do Firebase
    console.log('üì¶ [DEV-TOOLS] Importando m√≥dulos do Firebase...');
    const { initializeApp } = await import("https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js");
    const { getAuth, signInAnonymously } = await import("https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js");
    const { getFirestore, collection, doc, setDoc, getDocs, query, where, deleteDoc } = await import("https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js");
    console.log('‚úÖ [DEV-TOOLS] M√≥dulos do Firebase carregados com sucesso');
    
    // Configura√ß√£o do Firebase
    console.log('üî• [DEV-TOOLS] Configurando Firebase...');
    const firebaseConfig = {
      apiKey: "AIzaSyBHU6yFDCKp9jm9tPGyRqQJFS3amewuuQY",
      authDomain: "crmdaneon.firebaseapp.com",
      projectId: "crmdaneon",
      storageBucket: "crmdaneon.firebasestorage.app",
      messagingSenderId: "564595832938",
      appId: "1:564595832938:web:16fb660d8d433ae5f3f213",
      measurementId: "G-D3G4M9F17R"
    };
    
    console.log('üîß [DEV-TOOLS] Firebase Config:', firebaseConfig);
    document.getElementById('firebase-config-display').textContent = JSON.stringify(firebaseConfig, null, 2);
    
    let app, auth, db;
    
    try {
      console.log('üî• [DEV-TOOLS] Inicializando Firebase App...');
      app = initializeApp(firebaseConfig);
      console.log('‚úÖ [DEV-TOOLS] Firebase App inicializado');
      
      console.log('üîê [DEV-TOOLS] Configurando autentica√ß√£o...');
      auth = getAuth(app);
      await signInAnonymously(auth);
      console.log('‚úÖ [DEV-TOOLS] Autentica√ß√£o an√¥nima realizada');
      
      console.log('üóÑÔ∏è [DEV-TOOLS] Conectando ao Firestore...');
      try {
        db = getFirestore(app, "bancodaneondb");
        console.log('‚úÖ [DEV-TOOLS] Conectado ao banco: bancodaneondb');
      } catch {
        db = getFirestore(app);
        console.log('‚ö†Ô∏è [DEV-TOOLS] Conectado ao banco padr√£o (fallback)');
      }
      
      document.getElementById('firebase-status').innerHTML = `
        <div class="status-success">‚úÖ Firebase conectado com sucesso</div>
        <div class="status-info">üìä Database: ${db.app.options.projectId}</div>
        <div class="status-info">üîê Auth: ${auth.currentUser ? 'Logado' : 'N√£o logado'}</div>
      `;
      
    } catch (error) {
      console.error('‚ùå [DEV-TOOLS] Erro na inicializa√ß√£o do Firebase:', error);
      document.getElementById('firebase-status').innerHTML = `
        <div class="status-error">‚ùå Erro na conex√£o com Firebase</div>
        <div class="status-error">üîß ${error.message}</div>
      `;
    }
    
    console.log('üîÑ [DEV-TOOLS] Meio do processo de inicializa√ß√£o conclu√≠do');
    
    // Fun√ß√£o para atualizar console na tela
    function updateConsole(elementId, newLogs) {
      const consoleEl = document.getElementById(elementId);
      consoleEl.style.display = 'block';
      consoleEl.textContent = newLogs.join('\n');
      consoleEl.scrollTop = consoleEl.scrollHeight;
    }
    
    // Fun√ß√£o para configurar categorias
    async function setupCategories() {
      console.log('‚öôÔ∏è [SETUP] Iniciando configura√ß√£o de categorias...');
      
      const btn = document.getElementById('btn-setup-categories');
      const statusEl = document.getElementById('setup-status');
      
      btn.disabled = true;
      btn.textContent = '‚è≥ Configurando...';
      statusEl.innerHTML = '<div class="status-warning">‚è≥ Configurando categorias...</div>';
      
      try {
        console.log('üìÇ [SETUP] Definindo categorias principais...');
        
        // Categorias principais
        const categorias = [
          {
            id: 'Colecion√°veis',
            nome: 'Colecion√°veis',
            descricao: 'Itens colecion√°veis como cartas',
            ativo: true,
            ordem: 1
          },
          {
            id: 'Consum√≠veis',
            nome: 'Consum√≠veis',
            descricao: 'Itens que podem ser consumidos ou usados',
            ativo: true,
            ordem: 2
          }
        ];
        
        // Subcategorias para cartas
        const subcategorias = [
          {
            id: 'Cartas Comuns',
            nome: 'Cartas Comuns',
            categoria: 'Colecion√°veis',
            descricao: 'Cartas comuns do jogo',
            ativo: true,
            ordem: 1
          },
          {
            id: 'Cartas Raras',
            nome: 'Cartas Raras',
            categoria: 'Colecion√°veis',
            descricao: 'Cartas raras do jogo',
            ativo: true,
            ordem: 2
          },
          {
            id: 'Cartas √âpicas',
            nome: 'Cartas √âpicas',
            categoria: 'Colecion√°veis',
            descricao: 'Cartas √©picas do jogo',
            ativo: true,
            ordem: 3
          },
          {
            id: 'Cartas Lend√°rias',
            nome: 'Cartas Lend√°rias',
            categoria: 'Colecion√°veis',
            descricao: 'Cartas lend√°rias do jogo',
            ativo: true,
            ordem: 4
          },
          {
            id: 'Pack de Cartas',
            nome: 'Pack de Cartas',
            categoria: 'Consum√≠veis',
            descricao: 'Pacotes que cont√™m cartas aleat√≥rias',
            ativo: true,
            ordem: 1
          }
        ];
        
        console.log('üìÇ [SETUP] Criando categorias...');
        const categoriasRef = collection(db, 'loja', 'config', 'categorias');
        
        for (const categoria of categorias) {
          const docRef = doc(categoriasRef, categoria.id);
          await setDoc(docRef, categoria);
          console.log(`‚úÖ [SETUP] Categoria criada: ${categoria.nome}`);
        }
        
        console.log('üìã [SETUP] Criando subcategorias...');
        const subcategoriasRef = collection(db, 'loja', 'config', 'subcategorias');
        
        for (const subcategoria of subcategorias) {
          const docRef = doc(subcategoriasRef, subcategoria.id);
          await setDoc(docRef, subcategoria);
          console.log(`‚úÖ [SETUP] Subcategoria criada: ${subcategoria.nome}`);
        }
        
        console.log('üéâ [SETUP] Configura√ß√£o de categorias conclu√≠da!');
        
        statusEl.innerHTML = `
          <div class="status-success">‚úÖ Categorias configuradas com sucesso!</div>
          <div class="status-info">üìä ${categorias.length} categorias e ${subcategorias.length} subcategorias criadas</div>
        `;
        
        updateConsole('console-setup', allLogs.filter(log => log.includes('[SETUP]')));
        
      } catch (error) {
        console.error('‚ùå [SETUP] Erro na configura√ß√£o:', error);
        statusEl.innerHTML = `<div class="status-error">‚ùå Erro: ${error.message}</div>`;
      } finally {
        btn.disabled = false;
        btn.textContent = 'üìã Configurar Categorias e Subcategorias';
      }
    }
    
    // Fun√ß√£o para gerar cartas de teste
    function generateTestCards() {
      console.log('üéØ [POPULATE] Gerando dados de cartas de teste...');
      
      const cards = [];
      const raridades = [
        { nome: 'Comum', count: 40, subcategoria: 'Cartas Comuns' },
        { nome: 'Rara', count: 10, subcategoria: 'Cartas Raras' },
        { nome: '√âpica', count: 3, subcategoria: 'Cartas √âpicas' },
        { nome: 'Lend√°ria', count: 1, subcategoria: 'Cartas Lend√°rias' }
      ];
      
      console.log('üìã [POPULATE] Raridades configuradas:', raridades);
      
      let cardId = 1;
      
      for (const raridade of raridades) {
        console.log(`üÉè [POPULATE] Gerando ${raridade.count} cartas ${raridade.nome}s...`);
        
        for (let i = 1; i <= raridade.count; i++) {
          const card = {
            id: `test-card-${cardId.toString().padStart(3, '0')}`,
            nome: `${raridade.nome} Card ${i.toString().padStart(2, '0')}`,
            categoria: 'Colecion√°veis',
            subcategoria: raridade.subcategoria,
            descricao: `Uma carta ${raridade.nome.toLowerCase()} para testes do sistema de packs. ID: ${cardId}`,
            preco: getRarityPrice(raridade.nome),
            imagem: "https://firebasestorage.googleapis.com/v0/b/crmdaneon.firebasestorage.app/o/imagemLoja%2Fcarta_teste_1755543322647.svg?alt=media&token=dc319a7e-c6e0-438a-bccf-0a9258b4622d",
            ativo: true,
            dataAdicao: new Date(),
            raridade: raridade.nome,
            poder: getRarityPower(raridade.nome),
            elemento: getRandomElement()
          };
          
          cards.push(card);
          cardId++;
        }
      }
      
      console.log(`‚úÖ [POPULATE] Total de ${cards.length} cartas geradas`);
      return cards;
    }
    
    function getRarityPrice(raridade) {
      const prices = {
        'Comum': 10,
        'Rara': 50,
        '√âpica': 150,
        'Lend√°ria': 500
      };
      return prices[raridade] || 10;
    }
    
    function getRarityPower(raridade) {
      const powers = {
        'Comum': Math.floor(Math.random() * 100) + 50,
        'Rara': Math.floor(Math.random() * 200) + 150,
        '√âpica': Math.floor(Math.random() * 300) + 350,
        'Lend√°ria': Math.floor(Math.random() * 500) + 650
      };
      return powers[raridade] || 50;
    }
    
    function getRandomElement() {
      const elements = ['Fogo', '√Ågua', 'Terra', 'Ar', 'Luz', 'Trevas', 'Neutro'];
      return elements[Math.floor(Math.random() * elements.length)];
    }
    
    // Fun√ß√£o para popular o banco de dados
    async function populateDatabase() {
      console.log('üöÄ [POPULATE] Iniciando popula√ß√£o do banco de dados...');
      
      const btn = document.getElementById('btn-populate');
      const statusEl = document.getElementById('populate-status');
      const progressEl = document.getElementById('populate-progress');
      const progressFill = document.getElementById('progress-fill');
      const progressText = document.getElementById('progress-text');
      
      btn.disabled = true;
      btn.textContent = '‚è≥ Populando...';
      statusEl.innerHTML = '<div class="status-warning">‚è≥ Gerando cartas...</div>';
      progressEl.style.display = 'block';
      
      try {
        console.log('üîç [POPULATE] Verificando cole√ß√£o de destino: loja/config/produtos');
        const produtosRef = collection(db, 'loja', 'config', 'produtos');
        console.log('‚úÖ [POPULATE] Reference criada para:', produtosRef.path);
        
        const cards = generateTestCards();
        console.log(`üì¶ [POPULATE] ${cards.length} cartas preparadas para inser√ß√£o`);
        
        let created = 0;
        const total = cards.length;
        
        for (const card of cards) {
          try {
            console.log(`üìù [POPULATE] Criando carta ${created + 1}/${total}: ${card.nome}`);
            
            const cardDocRef = doc(produtosRef, card.id);
            console.log(`üîó [POPULATE] Document path: ${cardDocRef.path}`);
            
            await setDoc(cardDocRef, card);
            console.log(`‚úÖ [POPULATE] Carta criada: ${card.nome} (${card.raridade})`);
            
            created++;
            
            // Atualizar progresso
            const percentage = (created / total) * 100;
            progressFill.style.width = `${percentage}%`;
            progressText.textContent = `${created} / ${total} cartas criadas`;
            
            // Pequena pausa para n√£o sobrecarregar
            await new Promise(resolve => setTimeout(resolve, 50));
            
          } catch (error) {
            console.error(`‚ùå [POPULATE] Erro ao criar carta ${card.nome}:`, error);
          }
        }
        
        console.log(`üéâ [POPULATE] Popula√ß√£o conclu√≠da! ${created}/${total} cartas criadas`);
        
        statusEl.innerHTML = `
          <div class="status-success">‚úÖ Popula√ß√£o conclu√≠da!</div>
          <div class="status-info">üìä ${created} de ${total} cartas criadas</div>
        `;
        
        updateConsole('console-populate', allLogs.filter(log => log.includes('[POPULATE]')));
        
      } catch (error) {
        console.error('‚ùå [POPULATE] Erro durante a popula√ß√£o:', error);
        statusEl.innerHTML = `<div class="status-error">‚ùå Erro: ${error.message}</div>`;
      } finally {
        btn.disabled = false;
        btn.textContent = 'üéØ Popular Banco com Cartas de Teste';
        setTimeout(() => {
          progressEl.style.display = 'none';
        }, 3000);
      }
    }
    
    // Event Listeners
    document.getElementById('btn-setup-categories').addEventListener('click', setupCategories);
    document.getElementById('btn-populate').addEventListener('click', populateDatabase);
    
    // Debug functions
    document.getElementById('btn-check-collections').addEventListener('click', async () => {
      console.log('üîç [DEBUG] Verificando cole√ß√µes...');
      
      try {
        const collections = ['alunos', 'inventario', 'loja'];
        for (const collName of collections) {
          const collRef = collection(db, collName);
          const snapshot = await getDocs(collRef);
          console.log(`üìÇ [DEBUG] ${collName}: ${snapshot.size} documentos`);
        }
        
        updateConsole('console-debug', allLogs.filter(log => log.includes('[DEBUG]')));
      } catch (error) {
        console.error('‚ùå [DEBUG] Erro ao verificar cole√ß√µes:', error);
      }
    });
    
    document.getElementById('btn-check-cards').addEventListener('click', async () => {
      console.log('üÉè [DEBUG] Verificando cartas existentes...');
      
      try {
        const produtosRef = collection(db, 'loja', 'config', 'produtos');
        const snapshot = await getDocs(produtosRef);
        
        console.log(`üìä [DEBUG] Total de produtos: ${snapshot.size}`);
        
        const raridades = {};
        snapshot.forEach(doc => {
          const data = doc.data();
          if (data.categoria === 'Colecion√°veis') {
            const subcategoria = data.subcategoria || 'Sem subcategoria';
            raridades[subcategoria] = (raridades[subcategoria] || 0) + 1;
          }
        });
        
        console.log('üìã [DEBUG] Cartas por raridade:', raridades);
        updateConsole('console-debug', allLogs.filter(log => log.includes('[DEBUG]')));
      } catch (error) {
        console.error('‚ùå [DEBUG] Erro ao verificar cartas:', error);
      }
    });
    
    document.getElementById('btn-debug-cards-detailed').addEventListener('click', async () => {
      console.log('üîç [DEBUG-DETAILED] Iniciando debug detalhado das cartas...');
      
      try {
        const produtosRef = collection(db, 'loja', 'config', 'produtos');
        const snapshot = await getDocs(produtosRef);
        
        console.log(`üìä [DEBUG-DETAILED] Total de produtos no banco: ${snapshot.size}`);
        
        const cartasPorRaridade = {
          'Cartas Comuns': [],
          'Cartas Raras': [],
          'Cartas √âpicas': [],
          'Cartas Lend√°rias': []
        };
        
        let totalCartas = 0;
        
        snapshot.forEach(doc => {
          const data = doc.data();
          console.log(`üîé [DEBUG-DETAILED] Produto: ${data.nome || doc.id}`);
          console.log(`   üìÇ Categoria: "${data.categoria}"`);
          console.log(`   üè∑Ô∏è Subcategoria: "${data.subcategoria}"`);
          console.log(`   üÜî ID: ${doc.id}`);
          
          if (data.categoria === 'Colecion√°veis') {
            totalCartas++;
            const subcategoria = data.subcategoria || 'Sem subcategoria';
            
            if (cartasPorRaridade[subcategoria]) {
              cartasPorRaridade[subcategoria].push({
                id: doc.id,
                nome: data.nome,
                subcategoria: data.subcategoria
              });
            } else {
              console.log(`‚ö†Ô∏è [DEBUG-DETAILED] Subcategoria n√£o reconhecida: "${subcategoria}"`);
            }
          }
        });
        
        console.log(`üéØ [DEBUG-DETAILED] === RESUMO DAS CARTAS ===`);
        console.log(`üìä Total de cartas colecion√°veis: ${totalCartas}`);
        
        Object.entries(cartasPorRaridade).forEach(([raridade, cartas]) => {
          console.log(`${raridade}: ${cartas.length} cartas`);
          cartas.forEach((carta, index) => {
            console.log(`   ${index + 1}. ${carta.nome} (ID: ${carta.id})`);
          });
        });
        
        updateConsole('console-debug', allLogs.filter(log => log.includes('[DEBUG-DETAILED]')));
      } catch (error) {
        console.error('‚ùå [DEBUG-DETAILED] Erro:', error);
      }
    });
    
    document.getElementById('btn-check-categories').addEventListener('click', async () => {
      console.log('üìã [DEBUG] Verificando categorias...');
      
      try {
        const categoriasRef = collection(db, 'loja', 'config', 'categorias');
        const subcategoriasRef = collection(db, 'loja', 'config', 'subcategorias');
        
        const [catSnap, subSnap] = await Promise.all([
          getDocs(categoriasRef),
          getDocs(subcategoriasRef)
        ]);
        
        console.log(`üìÇ [DEBUG] Categorias: ${catSnap.size}`);
        console.log(`üìÇ [DEBUG] Subcategorias: ${subSnap.size}`);
        
        catSnap.forEach(doc => {
          console.log(`üìã [DEBUG] Categoria: ${doc.id} - ${doc.data().nome || 'Sem nome'}`);
        });
        
        subSnap.forEach(doc => {
          console.log(`üìã [DEBUG] Subcategoria: ${doc.id} - ${doc.data().nome || 'Sem nome'}`);
        });
        
        updateConsole('console-debug', allLogs.filter(log => log.includes('[DEBUG]')));
      } catch (error) {
        console.error('‚ùå [DEBUG] Erro ao verificar categorias:', error);
      }
    });
    
    document.getElementById('btn-clear-cards').addEventListener('click', async () => {
      if (!confirm('‚ö†Ô∏è Tem certeza que deseja limpar todas as cartas de teste? Esta a√ß√£o n√£o pode ser desfeita.')) {
        return;
      }
      
      console.log('üóëÔ∏è [DEBUG] Limpando cartas de teste...');
      
      try {
        const produtosRef = collection(db, 'loja', 'config', 'produtos');
        const q = query(produtosRef, where('categoria', '==', 'Colecion√°veis'));
        const snapshot = await getDocs(q);
        
        let deleted = 0;
        for (const docSnap of snapshot.docs) {
          const data = docSnap.data();
          if (data.id && data.id.startsWith('test-card-')) {
            await deleteDoc(docSnap.ref);
            deleted++;
            console.log(`üóëÔ∏è [DEBUG] Carta removida: ${data.nome}`);
          }
        }
        
        console.log(`‚úÖ [DEBUG] ${deleted} cartas de teste removidas`);
        updateConsole('console-debug', allLogs.filter(log => log.includes('[DEBUG]')));
      } catch (error) {
        console.error('‚ùå [DEBUG] Erro ao limpar cartas:', error);
      }
    });
    
    // Novo: Criar pack de teste no invent√°rio
    document.getElementById('btn-test-pack-creation').addEventListener('click', async () => {
      console.log('üì¶ [PACK-TEST] Criando pack de teste no invent√°rio...');
      
      try {
        // Verificar se usu√°rio est√° logado
        const sessRaw = localStorage.getItem("bn.currentUser");
        if (!sessRaw) {
          console.error('‚ùå [PACK-TEST] Usu√°rio n√£o logado');
          return;
        }
        
        const currentUser = JSON.parse(sessRaw);
        console.log('üë§ [PACK-TEST] Usu√°rio encontrado:', currentUser.user);
        
        // Criar pack no invent√°rio
        const packData = {
          category: 'Consum√≠veis',
          subcategory: 'Pack de Cartas',
          description: 'Pack de cartas para teste do sistema de abertura',
          firstPurchaseDate: new Date(),
          lastPurchaseDate: new Date(),
          imageUrl: 'https://via.placeholder.com/300x420/5a039a/ffffff?text=PACK',
          nome: 'Pack de 5 Cartas (Teste)',
          price: 100,
          productId: 'test-pack-001',
          productName: 'Pack de 5 Cartas (Teste)',
          quantity: 3, // 3 packs para teste
          status: 'active',
          totalSpent: 300
        };
        
        const inventarioRef = doc(db, 'inventario', currentUser.user, 'inventarioAluno', packData.nome);
        await setDoc(inventarioRef, packData);
        
        console.log('‚úÖ [PACK-TEST] Pack criado no invent√°rio:', packData.nome);
        console.log('üìä [PACK-TEST] Quantidade:', packData.quantity);
        console.log('üéØ [PACK-TEST] Agora v√° para o invent√°rio e teste a abertura!');
        
        updateConsole('console-debug', allLogs.filter(log => log.includes('[PACK-TEST]')));
      } catch (error) {
        console.error('‚ùå [PACK-TEST] Erro ao criar pack:', error);
      }
    });
    
    // Novo: Testar probabilidades de pack
    document.getElementById('btn-test-pack-probabilities').addEventListener('click', async () => {
      console.log('üé≤ [PROB-TEST] Testando probabilidades de pack...');
      
      try {
        // Simular 100 aberturas de pack para testar probabilidades
        const results = {
          comum: 0,
          rara: 0,
          epica: 0,
          lendaria: 0
        };
        
        const totalTests = 100;
        console.log(`üî¨ [PROB-TEST] Executando ${totalTests} simula√ß√µes...`);
        
        // Configura√ß√µes de probabilidade (igual ao sistema real)
        const chanceRaraCarta4 = 30;
        const chanceEpicaCarta5 = 15;
        const chanceLendariaCarta5 = 5;
        const chanceRaraCarta5 = 100 - chanceEpicaCarta5 - chanceLendariaCarta5;
        
        for (let i = 0; i < totalTests; i++) {
          const pack = [];
          
          // Cartas 1, 2, 3: sempre comuns
          pack.push('comum', 'comum', 'comum');
          
          // Carta 4: comum ou rara
          const isRaraCarta4 = Math.random() * 100 < chanceRaraCarta4;
          pack.push(isRaraCarta4 ? 'rara' : 'comum');
          
          // Carta 5: rara, √©pica ou lend√°ria
          const random5 = Math.random() * 100;
          if (random5 < chanceLendariaCarta5) {
            pack.push('lendaria');
          } else if (random5 < chanceLendariaCarta5 + chanceEpicaCarta5) {
            pack.push('epica');
          } else {
            pack.push('rara');
          }
          
          // Contar raridades
          pack.forEach(raridade => {
            results[raridade]++;
          });
        }
        
        // Calcular porcentagens
        const totalCards = totalTests * 5;
        console.log('üìä [PROB-TEST] Resultados da simula√ß√£o:');
        console.log(`üü´ Comuns: ${results.comum} (${(results.comum/totalCards*100).toFixed(1)}%)`);
        console.log(`üîµ Raras: ${results.rara} (${(results.rara/totalCards*100).toFixed(1)}%)`);
        console.log(`üü£ √âpicas: ${results.epica} (${(results.epica/totalCards*100).toFixed(1)}%)`);
        console.log(`üü† Lend√°rias: ${results.lendaria} (${(results.lendaria/totalCards*100).toFixed(1)}%)`);
        
        // Probabilidades esperadas
        console.log('üéØ [PROB-TEST] Probabilidades esperadas:');
        console.log(`üü´ Comuns: ~65% (3 fixas + carta 4 √†s vezes)`);
        console.log(`üîµ Raras: ~28% (carta 4: 30% + carta 5: 80%)`);
        console.log(`üü£ √âpicas: ~${chanceEpicaCarta5}% (apenas carta 5)`);
        console.log(`üü† Lend√°rias: ~${chanceLendariaCarta5}% (apenas carta 5)`);
        
        updateConsole('console-debug', allLogs.filter(log => log.includes('[PROB-TEST]')));
      } catch (error) {
        console.error('‚ùå [PROB-TEST] Erro no teste:', error);
      }
    });
    
    // Novo: Fix para cartas comuns faltantes
    document.getElementById('btn-fix-missing-commons').addEventListener('click', async () => {
      console.log('üîß [FIX-COMMONS] Criando cartas comuns faltantes...');
      
      try {
        // Verificar quantas cartas comuns existem
        const produtosRef = collection(db, 'loja', 'config', 'produtos');
        const q = query(produtosRef, 
          where('categoria', '==', 'Colecion√°veis'), 
          where('subcategoria', '==', 'Cartas Comuns')
        );
        const snapshot = await getDocs(q);
        
        console.log(`üìä [FIX-COMMONS] Cartas comuns existentes: ${snapshot.size}`);
        
        if (snapshot.size >= 5) {
          console.log('‚úÖ [FIX-COMMONS] J√° h√° cartas comuns suficientes');
          return;
        }
        
        // Criar cartas comuns
        const cartasComuns = [];
        for (let i = 1; i <= 10; i++) {
          const carta = {
            id: `fix-comum-${i.toString().padStart(2, '0')}`,
            nome: `Carta Comum Fix ${i.toString().padStart(2, '0')}`,
            categoria: 'Colecion√°veis',
            subcategoria: 'Cartas Comuns',
            descricao: `Uma carta comum criada para fix do sistema de packs. ID: fix-comum-${i}`,
            preco: 10,
            imagem: `https://via.placeholder.com/300x420/6c757d/ffffff?text=Comum+${i}`,
            ativo: true,
            dataAdicao: new Date(),
            raridade: 'Comum',
            poder: Math.floor(Math.random() * 100) + 50,
            elemento: getRandomElement()
          };
          cartasComuns.push(carta);
        }
        
        console.log(`üì¶ [FIX-COMMONS] Criando ${cartasComuns.length} cartas comuns...`);
        
        for (const carta of cartasComuns) {
          const docRef = doc(produtosRef, carta.id);
          await setDoc(docRef, carta);
          console.log(`‚úÖ [FIX-COMMONS] Carta criada: ${carta.nome}`);
        }
        
        console.log('üéâ [FIX-COMMONS] Fix conclu√≠do! Cartas comuns criadas.');
        updateConsole('console-debug', allLogs.filter(log => log.includes('[FIX-COMMONS]')));
        
      } catch (error) {
        console.error('‚ùå [FIX-COMMONS] Erro no fix:', error);
      }
    });
    
    document.getElementById('btn-refresh-stats').addEventListener('click', async () => {
      console.log('üîÑ [STATS] Atualizando estat√≠sticas...');
      await loadStats();
    });
    
    document.getElementById('btn-export-logs').addEventListener('click', () => {
      console.log('üì• [EXPORT] Exportando logs...');
      
      const logs = allLogs.join('\n');
      const blob = new Blob([logs], { type: 'text/plain' });
      const url = URL.createObjectURL(blob);
      
      const a = document.createElement('a');
      a.href = url;
      a.download = `dev-logs-${new Date().toISOString().split('T')[0]}.txt`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
      
      console.log('‚úÖ [EXPORT] Logs exportados');
    });
    
    // Carregar estat√≠sticas
    async function loadStats() {
      const statsContainer = document.getElementById('stats-container');
      
      try {
        console.log('üìä [STATS] Carregando estat√≠sticas...');
        
        // Contagem de cole√ß√µes
        const alunos = await getDocs(collection(db, 'alunos'));
        const inventarios = await getDocs(collection(db, 'inventario'));
        const produtos = await getDocs(collection(db, 'loja', 'config', 'produtos'));
        
        // Contar cartas por raridade
        const cartasPorRaridade = {};
        produtos.forEach(doc => {
          const data = doc.data();
          if (data.categoria === 'Colecion√°veis') {
            const subcategoria = data.subcategoria || 'Sem subcategoria';
            cartasPorRaridade[subcategoria] = (cartasPorRaridade[subcategoria] || 0) + 1;
          }
        });
        
        console.log('üìà [STATS] Estat√≠sticas carregadas');
        
        statsContainer.innerHTML = `
          <div class="constants-grid">
            <div class="constant-item">
              <div class="constant-label">üë• Alunos</div>
              <div class="constant-value">${alunos.size}</div>
            </div>
            <div class="constant-item">
              <div class="constant-label">üéí Invent√°rios</div>
              <div class="constant-value">${inventarios.size}</div>
            </div>
            <div class="constant-item">
              <div class="constant-label">üõçÔ∏è Produtos</div>
              <div class="constant-value">${produtos.size}</div>
            </div>
            <div class="constant-item">
              <div class="constant-label">üÉè Cartas</div>
              <div class="constant-value">${Object.values(cartasPorRaridade).reduce((a, b) => a + b, 0)}</div>
            </div>
          </div>
          
          <h3>üìä Cartas por Raridade</h3>
          <div class="constants-grid">
            ${Object.entries(cartasPorRaridade).map(([raridade, count]) => `
              <div class="constant-item">
                <div class="constant-label">${raridade}</div>
                <div class="constant-value">${count}</div>
              </div>
            `).join('')}
          </div>
        `;
        
      } catch (error) {
        console.error('‚ùå [STATS] Erro ao carregar estat√≠sticas:', error);
        statsContainer.innerHTML = `
          <div class="status-error">‚ùå Erro ao carregar estat√≠sticas</div>
        `;
      }
    }
    
    // Carregar estat√≠sticas iniciais
    setTimeout(loadStats, 2000);
    
    // Atualizar console do Firebase
    setTimeout(() => {
      updateConsole('console-firebase', allLogs.filter(log => log.includes('[DEV-TOOLS]')));
    }, 1000);
    
    console.log('üèÅ [DEV-TOOLS] Fim da inicializa√ß√£o da p√°gina de desenvolvimento');
  </script>
</body>
</html>
