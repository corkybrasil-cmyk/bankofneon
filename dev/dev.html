<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Dev • Banco da Neon</title>
  <link rel="icon" href="logotipo.svg" type="image/svg+xml" />
  <style>
    :root {
      --bg: #0b0f14; --panel: #131a22; --panel-alt: #111820; --text: #e6eef8; --muted: #9fb3c8; --accent: #1ee1a8; --border: #223042; --danger: #ff6b6b;
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body { margin: 0; font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto; color: var(--text); background: #0b0f14; }
    .app-header { padding: 16px 20px; display: flex; justify-content: space-between; border-bottom: 1px solid var(--border); background: #0f1520; position: sticky; top:0; z-index:2; }
    .grid { display: grid; grid-template-columns: repeat(2, 1fr); grid-template-rows: repeat(2, minmax(420px, auto)); gap: 16px; padding: 16px; }
    .card { background: linear-gradient(180deg, var(--panel), var(--panel-alt)); border: 1px solid var(--border); border-radius: 14px; padding: 16px; display: flex; flex-direction: column; }
    h2 { margin: 0 0 12px 0; font-size: 18px; }
    .actions { margin-top: 12px; display: flex; gap: 10px; flex-wrap: wrap; }
    ul.list { margin: 8px 0 0 0; padding: 0; list-style: none; overflow: auto; border: 1px solid var(--border); border-radius: 10px; }
    ul.list li { padding: 10px 12px; border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; cursor: pointer; }
    button { background: #111a25; color: var(--text); border: 1px solid var(--border); border-radius: 10px; padding: 10px 14px; cursor: pointer; }
    button.warn { border-color: #5c3b00; background: linear-gradient(180deg, #5c3b00, #2b1c00); color: #ffe8b3; }
    .grid-compact { display: grid; grid-template-columns: repeat(3, minmax(120px, 1fr)); gap: 8px; }
    .pill { font-size: 11px; border: 1px solid var(--border); border-radius: 9999px; padding: 4px 8px; color: var(--muted); }
    @media (max-width: 920px) { .grid { grid-template-columns: 1fr; } }
  </style>
</head>
<body>
  <div class="app-header">
    <div>Banco da Neon • Dev</div>
    <div style="display:flex; gap:10px; align-items:center;">
      <a href="index.html" style="color: var(--accent); text-decoration: none;">Sair</a>
      <a href="adicionarAluno.html" style="color: var(--accent); text-decoration: none;">Adicionar Aluno</a>
    </div>
  </div>

  <main class="grid">
    <section class="card" id="q2">
      <h2>Lista de alunos (idAluno por nome)</h2>
      <div class="actions">
        <button id="btnRefreshList">Refresh</button>
        <span style="color:#9fb3c8; font-size:12px;">Clique em um nome para ver o idAluno</span>
      </div>
      <ul class="list" id="listNames"></ul>
    </section>

    <section class="card" id="q3">
      <h2>Excluir aluno</h2>
      <div class="actions">
        <button class="warn" id="btnRefreshDelete">Refresh</button>
        <span style="color:#9fb3c8; font-size:12px;">Clique em um nome para solicitar exclusão</span>
      </div>
      <ul class="list" id="listDelete"></ul>
    </section>

    <section class="card" id="q4">
      <h2>Debug Site</h2>
      <div style="display:flex;flex-direction:column;gap:12px;">
        <button id="btnBackupInventario" style="margin:8px 0;background:#ffe8b3;color:#0b0f14;font-weight:bold;border:2px solid #223042;border-radius:10px;padding:10px 18px;">Backup Inventário (localStorage)</button>
        <button id="btnMigrarInventario" style="margin:8px 0;background:#1ee1a8;color:#0b0f14;font-weight:bold;border:2px solid #223042;border-radius:10px;padding:10px 18px;">Migrar Inventário (novo formato)</button>
        <button id="btnReverterInventario" style="margin:8px 0;background:#ff6b6b;color:#fff;font-weight:bold;border:2px solid #223042;border-radius:10px;padding:10px 18px;">Reverter Inventário (restaurar backup)</button>
      </div>
    </section>
    <section class="card" id="card-raridades-config">
      <h2>Config • Probabilidades de Cartas</h2>
      <form id="formRaridades" style="display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-bottom:12px;">
        <label>Comum (%)<input type="number" id="probComum" min="0" max="100" step="1" value="50" /></label>
        <label>Rara (%)<input type="number" id="probRara" min="0" max="100" step="1" value="30" /></label>
        <label>Épica (%)<input type="number" id="probEpica" min="0" max="100" step="1" value="15" /></label>
        <label>Lendária (%)<input type="number" id="probLendaria" min="0" max="100" step="1" value="5" /></label>
      </form>
      <button id="btnSalvarRaridades">Salvar Probabilidades</button>
      <span id="msgRaridades" style="color:var(--muted); font-size:13px; margin-top:8px; display:block;"></span>
    </section>
      <h2>Config • Ocorrências (custoFaltas)</h2>
      <div id="ocorrencias-config" style="display:grid; grid-template-columns: 1fr; gap:10px;">
        <div id="cfg-leve" style="display:flex; align-items:center; gap:10px;">
          <span style="min-width:160px;">Falta leve</span>
          <input id="valor-leve" type="number" step="1" style="max-width:160px;" />
          <button id="btn-leve">Atualizar</button>
        </div>
        <div id="cfg-medio" style="display:flex; align-items:center; gap:10px;">
          <span style="min-width:160px;">Falta média</span>
          <input id="valor-medio" type="number" step="1" style="max-width:160px;" />
          <button id="btn-medio">Atualizar</button>
        </div>
        <div id="cfg-grave" style="display:flex; align-items:center; gap:10px;">
          <span style="min-width:160px;">Falta grave</span>
          <input id="valor-grave" type="number" step="1" style="max-width:160px;" />
          <button id="btn-grave">Atualizar</button>
        </div>
        <div id="cfg-gravissimo" style="display:flex; align-items:center; gap:10px;">
          <span style="min-width:160px;">Falta gravíssima</span>
          <input id="valor-gravissimo" type="number" step="1" style="max-width:160px;" />
          <button id="btn-gravissimo">Atualizar</button>
        </div>
      </div>
    </section>
  </main>

  <div class="modal-overlay" id="modalOverlay" style="position:fixed; inset:0; background:rgba(0,0,0,0.6); display:none; align-items:center; justify-content:center; z-index:20;">
    <div class="modal" style="width:min(92vw,520px); background:#111820; border:1px solid var(--border); border-radius:12px; padding:16px;">
      <h3 id="modalTitle" style="margin:0 0 8px 0;">Título</h3>
      <p id="modalMessage" style="margin:0 0 12px 0; color:#9fb3c8;">Mensagem</p>
      <div class="actions">
        <button id="modalNo">Não</button>
        <button id="modalYes" class="warn">Sim</button>
        <button id="modalClose">Fechar</button>
      </div>
    </div>
  </div>

  

  <script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-analytics.js";
import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";
import { getFirestore, collection, getDocs, deleteDoc, doc, getDoc, setDoc, updateDoc } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

console.log('[DEV] Script ES module iniciado');

(async () => {
  try {
    const firebaseConfig = {
      apiKey: "AIzaSyBHU6yFDCKp9jm9tPGyRqQJFS3amewuuQY",
      authDomain: "crmdaneon.firebaseapp.com",
      projectId: "crmdaneon",
      storageBucket: "crmdaneon.firebasestorage.app",
      messagingSenderId: "564595832938",
      appId: "1:564595832938:web:16fb660d8d433ae5f3f213",
      measurementId: "G-D3G4M9F17R"
    };
    const app = initializeApp(firebaseConfig);
    try { getAnalytics(app); } catch {}
    try { await signInAnonymously(getAuth(app)); } catch {}
    let db; try { db = getFirestore(app, "bancodaneondb"); } catch { db = getFirestore(app); }
    const alunosCol = collection(db, "alunos");
    console.log('[DEV] Firebase inicializado');

    // Reuso de lógica essencialmente igual ao app original (Q2 a Q4)
    const $ = (s) => document.querySelector(s);
    const listNamesEl = $("#listNames");
    const listDeleteEl = $("#listDelete");
    const btnRefreshList = $("#btnRefreshList");
    const btnRefreshDelete = $("#btnRefreshDelete");
    const overlay = $("#modalOverlay");
    const modalTitle = $("#modalTitle");
    const modalMessage = $("#modalMessage");
    const modalNo = $("#modalNo");
    const modalYes = $("#modalYes");
    const modalClose = $("#modalClose");
    const showSpinner = () => {};
    const hideSpinner = () => {};

    function openModal({ title, message, mode = "info", onYes = null }) {
      modalTitle.textContent = title || "Mensagem";
      modalMessage.textContent = message || "";
      overlay.style.display = "flex";
      if (mode === "confirm") {
        modalYes.style.display = "inline-block"; modalNo.style.display = "inline-block"; modalClose.style.display = "none";
        modalYes.onclick = () => { try { onYes && onYes(); } finally { closeModal(); } };
        modalNo.onclick = () => closeModal();
      } else {
        modalYes.style.display = "none"; modalNo.style.display = "none"; modalClose.style.display = "inline-block";
        modalClose.onclick = () => closeModal();
      }
    }
    function closeModal() { overlay.style.display = "none"; }

    async function fetchAlunos() {
      const snapshot = await getDocs(alunosCol);
      const result = [];
      snapshot.forEach(d => { const data = d.data(); result.push({ docId: d.id, firstName: data?.firstName ?? "(sem nome)", idAluno: data?.idAluno ?? "(sem idAluno)" }); });
      return result;
    }
    function renderList(targetEl, items, onClick) {
      targetEl.innerHTML = "";
      if (!items.length) { const li = document.createElement("li"); li.innerHTML = '<span style="color:#9fb3c8; font-size:12px;">Nenhum aluno encontrado.</span>'; targetEl.appendChild(li); return; }
      items.forEach(item => { const li = document.createElement("li"); const name = document.createElement("span"); name.textContent = item.firstName; li.addEventListener("click", () => onClick(item)); li.appendChild(name); targetEl.appendChild(li); });
    }

    btnRefreshList.addEventListener("click", async () => {
      btnRefreshList.disabled = true;
      try { showSpinner(); const arr = await fetchAlunos(); renderList(listNamesEl, arr, (item) => openModal({ title: `Aluno: ${item.firstName}`, message: `idAluno: ${item.idAluno}`, mode: "info" })); }
      catch (e) { console.error(e); alert(e?.message || e); }
      finally { btnRefreshList.disabled = false; hideSpinner(); }
    });

    btnRefreshDelete.addEventListener("click", async () => {
      btnRefreshDelete.disabled = true;
      try {
        showSpinner();
        const arr = await fetchAlunos();
        renderList(listDeleteEl, arr, (item) => openModal({ title: `Excluir: ${item.firstName}`, message: `Deseja excluir? (idAluno: ${item.idAluno})`, mode: "confirm", onYes: async () => { try { await deleteDoc(doc(db, "alunos", item.docId)); btnRefreshDelete.click(); } catch (e) { console.error(e); alert(e?.message || e); } } }));
      } catch (e) { console.error(e); alert(e?.message || e); }
      finally { btnRefreshDelete.disabled = false; hideSpinner(); }
    });

    // MIGRAÇÃO DE ITENS DO INVENTÁRIO PARA NOVO FORMATO
    async function migrateInventario(userDocId) {
      console.log('[MIGRAÇÃO] Iniciando migração para usuário:', userDocId);
      const invCol = collection(db, 'inventario', userDocId, 'inventarioAluno');
      const snap = await getDocs(invCol);
      let migrados = 0, falhas = 0;
      for (const docSnap of snap.docs) {
        const data = docSnap.data();
        const productName = data.productName;
        if (!productName) { falhas++; console.log(`[MIGRAÇÃO] Falha: item sem productName (id: ${docSnap.id})`); continue; }
        try {
          await setDoc(doc(invCol, productName), data);
          await deleteDoc(doc(invCol, docSnap.id));
          migrados++;
          console.log(`[MIGRAÇÃO] Sucesso: ${docSnap.id} -> ${productName}`);
        } catch (e) {
          falhas++;
          console.log(`[MIGRAÇÃO] Erro ao migrar ${docSnap.id}:`, e);
        }
      }
      console.log(`[MIGRAÇÃO] Concluída! Itens migrados: ${migrados}, falhas: ${falhas}`);
      alert(`Migração concluída! Itens migrados: ${migrados}, falhas: ${falhas}`);
    }
    // BACKUP DO INVENTÁRIO NO LOCALSTORAGE
    async function backupInventario(userDocId) {
      try {
        console.log('[BACKUP] Iniciando backup para usuário:', userDocId);
        const invCol = collection(db, 'inventario', userDocId, 'inventarioAluno');
        const snap = await getDocs(invCol);
        const backup = [];
        for (const docSnap of snap.docs) {
          backup.push({ id: docSnap.id, data: docSnap.data() });
        }
        localStorage.setItem('backupInventario_' + userDocId, JSON.stringify(backup));
        console.log(`[BACKUP] Backup salvo para ${userDocId} (${backup.length} itens)`);
        alert(`Backup salvo no localStorage! (${backup.length} itens)`);
      } catch (e) {
        console.error('[BACKUP] Falha ao fazer backup:', e);
        alert('Falha ao fazer backup: ' + (e?.message || e));
      }
    }
    // REVERTER INVENTÁRIO USANDO BACKUP DO LOCALSTORAGE
    async function reverterInventario(userDocId) {
      console.log('[REVERTER] Iniciando restauração para usuário:', userDocId);
      const raw = localStorage.getItem('backupInventario_' + userDocId);
      if (!raw) { console.log(`[REVERTER] Nenhum backup encontrado para ${userDocId}`); alert('Nenhum backup encontrado para este usuário!'); return; }
      const backup = JSON.parse(raw);
      let restaurados = 0, falhas = 0;
      for (const item of backup) {
        try {
          await setDoc(doc(collection(db, 'inventario', userDocId, 'inventarioAluno'), item.id), item.data);
          restaurados++;
          console.log(`[REVERTER] Sucesso: ${item.id}`);
        } catch (e) {
          falhas++;
          console.log(`[REVERTER] Erro ao restaurar ${item.id}:`, e);
        }
      }
      console.log(`[REVERTER] Concluída! Itens restaurados: ${restaurados}, falhas: ${falhas}`);
      alert(`Inventário restaurado! (${restaurados} itens, falhas: ${falhas})`);
    }
    // Card Ocorrências: carregar e atualizar custoFaltas
    try {
      const custoRef = doc(db, 'ocorrencias', 'custoFaltas');
      const snap = await getDoc(custoRef);
      const data = snap.exists() ? snap.data() : { leve: 0, medio: 0, grave: 0, gravissimo: 0 };
      const vLeve = data.leve ?? 0;
      const vMedio = (data.medio ?? data['média']) ?? 0;
      const vGrave = data.grave ?? 0;
      const vGravissimo = (data.gravissimo ?? data['gravíssima']) ?? 0;
      document.getElementById('valor-leve').value = vLeve;
      document.getElementById('valor-medio').value = vMedio;
      document.getElementById('valor-grave').value = vGrave;
      document.getElementById('valor-gravissimo').value = vGravissimo;

      document.getElementById('btn-leve').onclick = async () => {
        const v = Number(document.getElementById('valor-leve').value || 0);
        await setDoc(custoRef, { leve: v }, { merge: true }); alert('Atualizado falta leve');
      };
      document.getElementById('btn-medio').onclick = async () => {
        const v = Number(document.getElementById('valor-medio').value || 0);
        await setDoc(custoRef, { medio: v, 'média': v }, { merge: true }); alert('Atualizado falta média');
      };
      document.getElementById('btn-grave').onclick = async () => {
        const v = Number(document.getElementById('valor-grave').value || 0);
        await setDoc(custoRef, { grave: v }, { merge: true }); alert('Atualizado falta grave');
      };
      document.getElementById('btn-gravissimo').onclick = async () => {
        const v = Number(document.getElementById('valor-gravissimo').value || 0);
        await setDoc(custoRef, { gravissimo: v, 'gravíssima': v }, { merge: true }); alert('Atualizado falta gravíssima');
      };
    } catch (e) {
      console.error('Erro custoFaltas:', e);
    }
    // Configuração de probabilidades de cartas
    const probComum = document.getElementById('probComum');
    const probRara = document.getElementById('probRara');
    const probEpica = document.getElementById('probEpica');
    const probLendaria = document.getElementById('probLendaria');
    const btnSalvarRaridades = document.getElementById('btnSalvarRaridades');
    const msgRaridades = document.getElementById('msgRaridades');
    async function carregarRaridades() {
      try {
        const rarRef = doc(db, 'config', 'raridades');
        const snap = await getDoc(rarRef);
        if (snap.exists()) {
          const cfg = snap.data().ultimaCarta || {};
          probComum.value = cfg.comum ?? 50;
          probRara.value = cfg.rara ?? 30;
          probEpica.value = cfg.epica ?? 15;
          probLendaria.value = cfg.lendaria ?? 5;
        }
      } catch (e) { msgRaridades.textContent = 'Erro ao carregar: ' + e.message; }
    }
    carregarRaridades();
    btnSalvarRaridades.onclick = async () => {
      const comum = Number(probComum.value||0);
      const rara = Number(probRara.value||0);
      const epica = Number(probEpica.value||0);
      const lendaria = Number(probLendaria.value||0);
      try {
        const rarRef = doc(db, 'config', 'raridades');
        await setDoc(rarRef, { ultimaCarta: { comum, rara, epica, lendaria } }, { merge:true });
        msgRaridades.textContent = 'Probabilidades salvas com sucesso!';
      } catch (e) {
        msgRaridades.textContent = 'Erro ao salvar: ' + e.message;
      }
    };
    document.addEventListener('DOMContentLoaded', () => {
      console.log('[DEV] DOMContentLoaded disparado');
      const cardDebug = document.getElementById('q4');
      console.log('[DEV] Card Debug Site encontrado:', !!cardDebug);
      const btnBackup = document.getElementById('btnBackupInventario');
      const btnMigrar = document.getElementById('btnMigrarInventario');
      const btnReverter = document.getElementById('btnReverterInventario');
      console.log('[DEV] Botões encontrados:', {
        btnBackup: !!btnBackup,
        btnMigrar: !!btnMigrar,
        btnReverter: !!btnReverter
      });
      if (btnBackup) {
        btnBackup.addEventListener('click', async () => {
          console.log('[DEV] Clique em btnBackupInventario');
          const userDocId = prompt('Informe o ID do usuário para backup do inventário:');
          console.log('[DEV] userDocId informado:', userDocId);
          if (userDocId) {
            await backupInventario(userDocId);
            // Exibe o conteúdo do backup em JSON no console
            const raw = localStorage.getItem('backupInventario_' + userDocId);
            if (raw) {
              console.log('[DEV] Backup JSON:', raw);
            } else {
              console.log('[DEV] Nenhum backup encontrado no localStorage para', userDocId);
            }
          }
        });
      } else {
        console.log('[DEV] Botão btnBackupInventario não encontrado');
      }
      if (btnMigrar) {
        btnMigrar.addEventListener('click', async () => {
          console.log('[DEV] Clique em btnMigrarInventario');
          const userDocId = prompt('Informe o ID do usuário para migrar o inventário:');
          console.log('[DEV] userDocId informado:', userDocId);
          if (userDocId) await migrateInventario(userDocId);
        });
      } else {
        console.log('[DEV] Botão btnMigrarInventario não encontrado');
      }
      if (btnReverter) {
        btnReverter.addEventListener('click', async () => {
          console.log('[DEV] Clique em btnReverterInventario');
          const userDocId = prompt('Informe o ID do usuário para restaurar o inventário:');
          console.log('[DEV] userDocId informado:', userDocId);
          if (userDocId) await reverterInventario(userDocId);
        });
      } else {
        console.log('[DEV] Botão btnReverterInventario não encontrado');
      }
    });
  } catch (e) {
    console.error('[DEV] Erro global no script:', e);
  }
})();
  </script>
</body>
</html>


